<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIDI Karplus-Strong Flute</title>
    <!-- Basic styling for the page -->
    <style>
        .toolbar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            background: #333;
            padding: 2px;
            box-sizing: border-box;
            text-align: center;
            z-index: 1000;
        }
        .toolbar button {
            background: #555;
            color: white;
            border: 1px solid #888;
            border-radius: 3px;
            padding: 1px 4px;
            margin: 1px;
            cursor: pointer;
            font-size: 12px;
        }
        .toolbar button:disabled {
            background: #777;
            color: #ccc;
            cursor: default;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #1a1a1a;
            color: #e0e0e0;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
        }
        h1 {
            color: #ffffff;
            font-weight: 500;
        }
        button {
            padding: 12px 24px;
            font-size: 1em;
            cursor: pointer;
            background-color: #3d3d3d;
            color: white;
            border: 1px solid #555;
            border-radius: 8px;
            transition: background-color 0.3s, transform 0.1s;
            margin-bottom: 20px;
        }
        button:hover {
            background-color: #4a4a4a;
        }
        button:active {
            background-color: #555555;
            transform: scale(0.98);
        }
        #controlsContainer {
            margin-top: 20px;
            padding: 15px 20px;
            border: 1px solid #333;
            background-color: #252525;
            min-width: 320px;
            max-width: 90%;
            border-radius: 8px;
        }
        .slider-group {
            margin-bottom: 15px;
            display: grid;
            grid-template-columns: 1fr;
            justify-items: center;
            gap: 8px;
        }
        .slider-group label {
            font-size: 0.9em;
            color: #ccc;
        }
        .slider-group input[type="range"] {
            width: 90%;
            margin-top: 4px;
        }
        .midi-learn-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 0.8em;
        }
        .learn-button {
            padding: 4px 8px;
            font-size: 0.8em;
            margin: 0;
            border-radius: 5px;
        }
        .learn-button:disabled {
            background-color: #007bff;
            cursor: default;
        }
        .cc-display {
            background-color: #3d3d3d;
            padding: 4px 6px;
            border-radius: 4px;
            min-width: 50px;
            text-align: center;
        }
        #statusContainer {
            margin-top: 15px;
            padding: 15px 20px;
            border: 1px solid #333;
            background-color: #252525;
            min-width: 300px;
            max-width: 90%;
            border-radius: 8px;
            font-size: 0.9em;
            color: #cccccc;
            line-height: 1.6;
        }
        p {
            margin-top: 10px;
            color: #aaaaaa;
        }
    </style>
</head>
<body>
<div class="toolbar">
    <button onclick="window.location.href='index.html'">Home</button>
    <button onclick="window.location.href='berlin.html'">Berlin</button>
    <button onclick="window.location.href='chords.html'">Chords</button>
    <button onclick="window.location.href='CosmicDrift.html'">Cosmic</button>
    <button onclick="window.location.href='delay.html'">Delay</button>
    <button disabled>Karplus</button>
    <button onclick="window.location.href='midi-monitor.html'">Monitor</button>
    <button onclick="window.location.href='polychain.html'">Polychain</button>
    <button onclick="window.location.href='pondviz.html'">Pond</button>
    <button onclick="window.location.href='Psychedelia.html'">Psyche</button>
    <button onclick="window.location.href='rhythm.html'">Rhythm</button>
    <button onclick="window.location.href='Shepard chord.html'">Shepard</button>
    <button onclick="window.location.href='starfield.html'">Starfield</button>
    <button onclick="window.location.href='visualizer2.html'">Viz</button>
</div>
<h1>MIDI Controlled Karplus-Strong Flute</h1>
<p>Connect a MIDI controller, click the "Test Sound" button once to activate audio, then play!</p>

<!-- Button to test sound generation and activate AudioContext -->
<button id="testSoundButton">Test Sound (C5)</button>

<!-- Sliders for parameter control -->
<div id="controlsContainer">
    <div class="slider-group">
        <label for="decaySlider">Decay: <span id="decayValue">0.997</span></label>
        <input type="range" id="decaySlider" min="0.95" max="1.0" step="0.001" value="0.997">
        <div class="midi-learn-control">
            <button class="learn-button" data-target="decay">Learn CC</button>
            <span class="cc-display" id="decayCcDisplay">None</span>
        </div>
    </div>
    <div class="slider-group">
        <label for="filterSlider">Excitation Filter (Softness): <span id="filterValue">0.5</span></label>
        <input type="range" id="filterSlider" min="0" max="1" step="0.01" value="0.5">
        <div class="midi-learn-control">
            <button class="learn-button" data-target="filter">Learn CC</button>
            <span class="cc-display" id="filterCcDisplay">None</span>
        </div>
    </div>
</div>

<!-- Status area for MIDI and Audio feedback -->
<div id="statusContainer">Initializing...</div>

<!-- All JavaScript logic is included here -->
<script>
    // --- MIDI Karplus-Strong Flute Synthesis (Version 6 - MIDI CC Learn) ---

    const testSoundButton = document.getElementById('testSoundButton');
    const statusContainer = document.getElementById('statusContainer');
    const decaySlider = document.getElementById('decaySlider');
    const decayValueSpan = document.getElementById('decayValue');
    const filterSlider = document.getElementById('filterSlider');
    const filterValueSpan = document.getElementById('filterValue');

    const decayLearnButton = document.querySelector('[data-target="decay"]');
    const filterLearnButton = document.querySelector('[data-target="filter"]');
    const decayCcDisplay = document.getElementById('decayCcDisplay');
    const filterCcDisplay = document.getElementById('filterCcDisplay');

    let audioCtx = null;
    let midiAccess = null; // Store midiAccess globally
    const activeNotes = {}; // Object to store active GainNodes, keyed by MIDI note number

    // --- Synthesis & MIDI CC Parameters ---
    let currentDecay = 0.997;
    let currentFilterAmount = 0.5;
    let learningTarget = null;
    let decayCc = null;
    let filterCc = null;

    // --- Event Listeners ---
    decaySlider.addEventListener('input', (e) => {
        currentDecay = parseFloat(e.target.value);
        decayValueSpan.textContent = currentDecay.toFixed(3);
    });

    filterSlider.addEventListener('input', (e) => {
        currentFilterAmount = parseFloat(e.target.value);
        filterValueSpan.textContent = currentFilterAmount.toFixed(2);
    });

    decayLearnButton.addEventListener('click', () => startLearning('decay'));
    filterLearnButton.addEventListener('click', () => startLearning('filter'));

    function startLearning(target) {
        learningTarget = target;
        // Update UI to show we're listening
        decayLearnButton.textContent = 'Learn CC';
        filterLearnButton.textContent = 'Learn CC';
        decayLearnButton.disabled = false;
        filterLearnButton.disabled = false;

        if (target === 'decay') {
            decayLearnButton.textContent = 'Listening...';
            decayLearnButton.disabled = true;
        } else if (target === 'filter') {
            filterLearnButton.textContent = 'Listening...';
            filterLearnButton.disabled = true;
        }
        console.log(`Waiting for MIDI CC for: ${target}`);
    }

    // --- AudioContext Management ---
    async function ensureAudioContext() {
        if (!audioCtx) {
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                console.log("AudioContext created.");
                audioCtx.onstatechange = () => {
                    console.log(`AudioContext state changed to: ${audioCtx.state}`);
                    updateStatusDisplay();
                };
            } catch (e) {
                console.error("Web Audio API is not supported in this browser", e);
                statusContainer.innerHTML = "<strong>Error:</strong><br/>Web Audio API not supported.";
                alert("Web Audio API is not supported in this browser.");
                return null;
            }
        }

        if (audioCtx.state === 'suspended') {
            try {
                console.log("Attempting to resume AudioContext...");
                await audioCtx.resume();
                console.log(`AudioContext resumed. State: ${audioCtx.state}`);
            } catch (e) {
                console.error("Failed to resume AudioContext:", e);
                statusContainer.innerHTML = "<strong>Error:</strong><br/>Failed to resume audio. Click the page.";
                return null;
            }
        }

        updateStatusDisplay();
        return audioCtx.state === 'running' ? audioCtx : null;
    }

    // --- Karplus-Strong Sound Generation ---
    function playKarplusStrongFlute(freq, duration, velocity, currentAudioCtx) {
        if (!currentAudioCtx) return null;

        const sampleRate = currentAudioCtx.sampleRate;
        const N = Math.round(sampleRate / freq);
        const totalSamples = Math.floor(sampleRate * duration);

        let ringBuffer = new Float32Array(N);
        let tempNoise = new Float32Array(N);
        for (let i = 0; i < N; i++) tempNoise[i] = Math.random() * 2 - 1;

        ringBuffer[0] = tempNoise[0];
        for (let i = 1; i < N; i++) {
            const rawSample = tempNoise[i];
            const filteredSample = (tempNoise[i] + tempNoise[i - 1]) * 0.5;
            ringBuffer[i] = (rawSample * (1 - currentFilterAmount)) + (filteredSample * currentFilterAmount);
        }

        let outputBuffer = new Float32Array(totalSamples);
        let writeIndex = 0;
        for (let i = 0; i < totalSamples; i++) {
            const currentSample = ringBuffer[writeIndex];
            outputBuffer[i] = currentSample;
            const nextIndex = (writeIndex + 1) % N;
            const newValue = (currentSample + ringBuffer[nextIndex]) * 0.5 * currentDecay;
            ringBuffer[writeIndex] = newValue;
            writeIndex = nextIndex;
        }

        const audioBuffer = currentAudioCtx.createBuffer(1, totalSamples, sampleRate);
        audioBuffer.getChannelData(0).set(outputBuffer);
        const source = currentAudioCtx.createBufferSource();
        source.buffer = audioBuffer;
        const gainNode = currentAudioCtx.createGain();
        const initialGain = Math.min(1.0, Math.max(0.0, velocity / 127));
        gainNode.gain.setValueAtTime(initialGain, currentAudioCtx.currentTime);
        source.connect(gainNode);
        gainNode.connect(currentAudioCtx.destination);
        source.start();
        return gainNode;
    }

    // --- MIDI Handling ---
    function midiNoteToFrequency(note) {
        return 440 * Math.pow(2, (note - 69) / 12);
    }

    async function handleMIDIMessage(event) {
        const currentAudioCtx = await ensureAudioContext();
        const command = event.data[0] >> 4;
        const note = event.data[1];
        const velocity = event.data[2];

        // Command 11 is Control Change
        if (command === 11) {
            const ccNumber = note;
            const ccValue = velocity;

            if (learningTarget) {
                if (learningTarget === 'decay') {
                    decayCc = ccNumber;
                    decayCcDisplay.textContent = `CC ${ccNumber}`;
                } else if (learningTarget === 'filter') {
                    filterCc = ccNumber;
                    filterCcDisplay.textContent = `CC ${ccNumber}`;
                }
                console.log(`Mapped ${learningTarget} to CC ${ccNumber}`);
                learningTarget = null;
                decayLearnButton.textContent = 'Learn CC';
                filterLearnButton.textContent = 'Learn CC';
                decayLearnButton.disabled = false;
                filterLearnButton.disabled = false;
            } else {
                if (ccNumber === decayCc) {
                    const newDecay = 0.95 + (ccValue / 127) * 0.05;
                    decaySlider.value = newDecay;
                    decaySlider.dispatchEvent(new Event('input'));
                } else if (ccNumber === filterCc) {
                    const newFilter = ccValue / 127;
                    filterSlider.value = newFilter;
                    filterSlider.dispatchEvent(new Event('input'));
                }
            }
            return;
        }

        if (!currentAudioCtx) return;

        if (command === 9 && velocity > 0) {
            const frequency = midiNoteToFrequency(note);
            if (activeNotes[note]) {
                stopNote(note, currentAudioCtx);
            }
            const gainNode = playKarplusStrongFlute(frequency, 2.0, velocity, currentAudioCtx);
            if (gainNode) activeNotes[note] = gainNode;
        } else if (command === 8 || (command === 9 && velocity === 0)) {
            stopNote(note, currentAudioCtx);
        }
    }

    function stopNote(note, currentAudioCtx) {
        if (!currentAudioCtx || !activeNotes[note]) return;
        const gainNode = activeNotes[note];
        const now = currentAudioCtx.currentTime;
        if (gainNode.gain.value > 0.001) {
            gainNode.gain.setValueAtTime(gainNode.gain.value, now);
            gainNode.gain.exponentialRampToValueAtTime(0.0001, now + 0.05);
        }
        delete activeNotes[note];
    }

    // --- MIDI Initialization and State Change Handling ---
    function updateMIDIInputs() {
        if (!midiAccess) return;
        for (let input of midiAccess.inputs.values()) {
            input.onmidimessage = null;
        }
        if (midiAccess.inputs.size === 0) {
            console.log("No MIDI input devices found.");
        } else {
            for (let input of midiAccess.inputs.values()) {
                input.onmidimessage = handleMIDIMessage;
                console.log(`Listening to MIDI device: ${input.name}`);
            }
        }
        updateStatusDisplay();
    }

    function updateStatusDisplay() {
        const audioState = audioCtx ? audioCtx.state : "Inactive";
        let midiState = "No Access";
        let devicesFound = [];

        if(midiAccess) {
            midiState = "Ready";
            if (midiAccess.inputs.size > 0) {
                for(let input of midiAccess.inputs.values()){
                    devicesFound.push(input.name);
                }
            } else {
                midiState = "No devices found";
            }
        }

        let html = `<strong>Audio Status:</strong> ${audioState}<br/>`;
        html += `<strong>MIDI Status:</strong> ${midiState}`;
        if(devicesFound.length > 0) {
            html += `<br/><strong>Listening to:</strong><br/>${devicesFound.join('<br/>')}`;
        }

        statusContainer.innerHTML = html;
    }

    function onMIDISuccess(ma) {
        console.log("MIDI Access Granted");
        midiAccess = ma;
        updateMIDIInputs();
        midiAccess.onstatechange = (event) => {
            console.log(`MIDI state change: ${event.port.name}, state: ${event.port.state}`);
            updateMIDIInputs();
        };
    }

    function onMIDIFailure(error) {
        console.error(`Failed to get MIDI access - ${error}`);
        let errorMessage = "<strong>Error:</strong><br/>Failed to get MIDI access.";
        if (error && (error.name === 'SecurityError' || (error.message && error.message.includes('permissions policy')))) {
            errorMessage = "<strong>Error:</strong><br/>MIDI is blocked by the browser's security policy. This often happens when the page is in a sandboxed environment (like an iframe) that needs explicit permission to access MIDI devices.";
        }
        statusContainer.innerHTML = errorMessage;
    }

    function initializeMIDI() {
        if (navigator.requestMIDIAccess) {
            statusContainer.innerHTML = "Requesting MIDI access...";
            navigator.requestMIDIAccess({ sysex: false })
                .then(onMIDISuccess, onMIDIFailure);
        } else {
            statusContainer.innerHTML = "<strong>Error:</strong><br/>Web MIDI API not supported.";
        }
    }

    testSoundButton.addEventListener('click', async () => {
        const currentAudioCtx = await ensureAudioContext();
        if (currentAudioCtx) {
            console.log("Playing test sound C5");
            const testGain = playKarplusStrongFlute(midiNoteToFrequency(72), 1.5, 100, currentAudioCtx);
            if (testGain) {
                setTimeout(() => {
                    const now = currentAudioCtx.currentTime;
                    if (testGain.gain.value > 0.001) {
                        testGain.gain.setValueAtTime(testGain.gain.value, now);
                        testGain.gain.exponentialRampToValueAtTime(0.0001, now + 0.2);
                    }
                }, 1300);
            }
        } else {
            console.error("Could not play test sound, AudioContext not running.");
        }
    });

    initializeMIDI();
</script>

</body>
</html>