```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generative Music Sequencer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            padding-top: 35px; /* Make space for toolbar */
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        :root {
            --base-hue: 244;
            --bg-panel: rgba(17, 24, 39, 0.8);
            --bg-control: rgba(255, 255, 255, 0.1);
            --text-header: hsl(var(--base-hue), 91%, 74%);
            --text-body: #f9fafb;
            --text-label: #f3f4f6;
            --text-display: hsl(var(--base-hue), 93%, 82%);
            --border-color: #374151;
            --thumb-color: hsl(var(--base-hue), 76%, 58%);
            --note-highlight-color: hsl(var(--base-hue), 100%, 85%);
        }
        .theme-vintage {
            --base-hue: 28;
            --bg-body-vintage: #e7e2d8;
            --bg-panel: rgba(212, 206, 195, 0.8);
            --bg-control: rgba(0, 0, 0, 0.05);
            --text-header: hsl(var(--base-hue), 39%, 39%);
            --text-body: #1c1917;
            --text-label: #292524;
            --text-display: hsl(var(--base-hue), 96%, 44%);
            --border-color: #c7c1b8;
            --thumb-color: hsl(var(--base-hue), 57%, 49%);
            --note-highlight-color: hsl(var(--base-hue), 100%, 50%);
        }

        body {
            background-color: #1a202c;
            background-image: linear-gradient(to bottom right, #1e3a8a, #5b21b6);
            color: var(--text-body);
            background-attachment: fixed;
        }

        body.theme-vintage {
            background-image: none;
            background-color: var(--bg-body-vintage);
            color: var(--text-body);
        }

        .main-panel {
            background: var(--bg-panel);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-color: var(--border-color);
            transition: border-color 2s ease-in-out;
        }
        .control-group {
            background-color: var(--bg-control);
            border-color: var(--border-color);
            transition: border-color 2s ease-in-out;
        }
        h1 {
            transition: color 2s ease-in-out;
        }
        h2.section-header { color: var(--text-header); letter-spacing: 0.05em; }
        label, .text-label { color: var(--text-label); }
        .text-display { color: var(--text-display); }
        select { background-color: var(--bg-control); border-color: var(--border-color); color: var(--text-label); }

        input[type="range"]::-webkit-slider-thumb { background: var(--thumb-color); transition: background-color 2s ease-in-out; }
        input[type="range"]::-moz-range-thumb { background: var(--thumb-color); transition: background-color 2s ease-in-out; }

        button {
            transition: background-color 2s ease-in-out;
        }

        select {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            background-image: var(--select-arrow-url);
            background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 1.2em; padding-right: 2.5rem;
        }
        .note-playing { color: var(--note-highlight-color); transform: scale(1.2); transition: all 0.1s ease-out; }

        .seq-step {
            width: 1.75rem; height: 1.75rem; border: 1px solid var(--border-color); transition: all 0.1s ease;
            cursor: pointer;
        }
        @media (min-width: 640px) { .seq-step { width: 2rem; height: 2rem; } }
        @media (min-width: 1024px) { .seq-step { width: 2.5rem; height: 2.5rem; } }

        .seq-step.active { background-color: var(--thumb-color); opacity: 0.75; }
        .seq-step.playing { box-shadow: 0 0 10px 2px var(--note-highlight-color); transform: scale(1.1); opacity: 1; }
        .seq-step:hover { border-color: var(--note-highlight-color); }

        .status-bar-item { @apply text-center p-2 rounded-lg bg-black/10 flex-1 min-w-[120px]; }
        .status-bar-label { @apply block text-xs font-semibold uppercase tracking-wider text-label opacity-70; }
        .status-bar-value { @apply block text-lg font-bold text-display; }

        .live-note {
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }
        .live-note.fade-out {
            opacity: 0;
        }
        .toolbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: var(--wood-brown, #2b2321);
            display: flex;
            justify-content: center;
            padding: 2px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 1000;
        }
        .toolbar a {
            background-color: var(--burnt-orange, #e65100);
            color: var(--ivory, #ffffff);
            text-decoration: none;
            padding: 5px 10px;
            margin: 0 2px;
            border-radius: 4px;
            font-size: 0.8rem;
            border: 1px solid var(--dark-orange, #bf360c);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            transition: all 0.2s ease-in-out;
        }
        .toolbar a:hover {
            background-color: var(--dark-orange, #bf360c);
            transform: translateY(-1px);
        }
    </style>
<style>
  .toolbar {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    background: #333;
    padding: 2px;
    box-sizing: border-box;
    text-align: center;
    z-index: 1000;
  }
  .toolbar button {
    background: #555;
    color: white;
    border: 1px solid #888;
    border-radius: 3px;
    padding: 1px 4px;
    margin: 1px;
    cursor: pointer;
    font-size: 12px;
  }
  .toolbar button:disabled {
    background: #777;
    color: #ccc;
    cursor: default;
  }
</style>
</head>
<body>
<div class="toolbar">
    <button onclick="window.location.href='index.html'">Home</button>
    <button disabled>Berlin</button>
    <button onclick="window.location.href='chords.html'">Chords</button>
    <button onclick="window.location.href='delay.html'">Delay</button>
    <button onclick="window.location.href='karplus.html'">Karplus</button>
    <button onclick="window.location.href='polychain.html'">Polychain</button>
    <button onclick="window.location.href='pondviz.html'">Pond</button>
    <button onclick="window.location.href='rhythm.html'">Rhythm</button>
    <button onclick="window.location.href='starfield.html'">Starfield</button>
    <button onclick="window.location.href='visualizer1.html'">Viz 1</button>
</div>

<div class="main-panel w-full max-w-7xl mx-auto p-2 my-2 rounded-2xl shadow-2xl border">
    <!-- Header -->
    <div class="relative text-center mb-2">
        <h1 id="main-title" class="text-3xl sm:text-4xl font-bold tracking-tight">Generative Sequencer</h1>
        <p class="mt-1 text-sm text-label">Craft your own evolving soundscape</p>
        <div class="absolute top-0 right-2">
            <button id="theme-switcher" title="Toggle theme" class="p-2 rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-[var(--bg-panel)] focus:ring-[var(--thumb-color)]">
                <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" /></svg>
                <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-1.414 8.486a1 1 0 010-1.414l.707-.707a1 1 0 111.414 1.414l-.707-.707a1 1 0 01-1.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1z" clip-rule="evenodd" /></svg>
            </button>
        </div>
    </div>

    <div id="message-box" class="text-center text-yellow-400 mb-2 h-5"></div>

    <div class="mb-2">
        <button id="play-stop-button" title="Start or stop the music" class="bg-[var(--thumb-color)] hover:opacity-80 text-white font-bold py-3 px-4 rounded-full text-xl w-full transition-all duration-300 ease-in-out shadow-lg transform hover:scale-105">Start</button>
    </div>

    <!-- Status Bar -->
    <div id="status-bar" class="control-group p-2 rounded-xl mb-2 flex flex-wrap justify-around gap-2">
        <div class="status-bar-item"><span class="status-bar-label">Evolve State</span><span id="evolve-state-display" class="status-bar-value">Idle</span></div>
        <div class="status-bar-item"><span class="status-bar-label">Mood</span><span id="mood-display" class="status-bar-value">...</span></div>
        <div class="status-bar-item"><span class="status-bar-label">Tempo</span><span id="tempo-display" class="status-bar-value">70 BPM</span></div>
        <div class="status-bar-item"><span class="status-bar-label">Current Chord</span><span id="chord-display" class="status-bar-value">-</span></div>
        <div class="status-bar-item"><span class="status-bar-label">Key</span><span id="scale-display" class="status-bar-value">-</span></div>
    </div>

    <!-- Main Control Panels -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 mb-2">
        <div class="control-group p-3 rounded-xl">
            <h2 class="section-header text-lg font-bold text-center mb-2 uppercase">Global &amp; Rhythm</h2>
            <div data-instrument="master"><label for="master-vol" class="block mb-1 text-sm font-semibold text-label">Master Volume</label><input type="range" id="master-vol" min="-20" max="6" value="3" step="1" class="w-full"><div class="text-center mt-0 text-display font-mono text-sm"><span id="master-vol-value">3</span> dB</div></div>
            <div data-instrument="tempo" class="mt-2"><label for="tempo" class="block mb-1 text-sm font-semibold text-label">Tempo</label><input type="range" id="tempo" min="70" max="170" value="70" class="w-full"><div class="text-center mt-0 text-display font-mono text-sm"><span id="tempo-value">70</span> BPM</div></div>
            <div data-instrument="swing" class="mt-2"><label for="swing" class="block mb-1 text-sm font-semibold text-label">Swing</label><input type="range" id="swing" min="0" max="0.8" value="0" step="0.05" class="w-full"><div class="text-center mt-0 text-display font-mono text-sm"><span id="swing-value">0.0</span></div></div>
        </div>
        <div class="control-group p-3 rounded-xl">
            <h2 class="section-header text-lg font-bold text-center mb-2 uppercase">Foundation</h2>
            <div class="space-y-3">
                <select id="root-note-select" title="Select root note" class="text-base rounded-lg focus:ring-[var(--thumb-color)] focus:border-[var(--thumb-color)] block w-full p-2.5"><option>C</option><option>C#</option><option>D</option><option>D#</option><option>E</option><option>F</option><option>F#</option><option>G</option><option>G#</option><option>A</option><option>A#</option><option>B</option></select>
                <select id="scale-type-select" title="Select scale" class="text-base rounded-lg focus:ring-[var(--thumb-color)] focus:border-[var(--thumb-color)] block w-full p-2.5"><option value="majorPentatonic">Major Pentatonic</option><option value="minorPentatonic">Minor Pentatonic</option><option value="major">Major</option><option value="minor" selected>Natural Minor</option><option value="dorian">Dorian</option></select>
                <select id="octave-select" title="Select octave" class="text-base rounded-lg focus:ring-[var(--thumb-color)] focus:border-[var(--thumb-color)] block w-full p-2.5"><option>1</option><option>2</option><option selected>3</option><option>4</option><option>5</option></select>
            </div>
            <button id="new-mood-button" class="w-full mt-3 p-2 rounded-lg bg-[var(--thumb-color)] text-white font-semibold hover:opacity-80">New Mood</button>
        </div>
        <div class="control-group p-3 rounded-xl">
            <h2 class="section-header text-lg font-bold text-center mb-2 uppercase">Evolve Engine</h2>
            <div data-instrument="density"><label for="density" class="block mb-1 text-sm font-semibold text-label">Drum Density</label><input type="range" id="density" min="0.0" max="1.0" value="0.0" step="0.05" class="w-full"><div class="text-center mt-0 text-display font-mono text-sm"><span id="density-value">0.0</span></div></div>
            <div data-instrument="evolve-up" class="mt-2"><label for="evolve-up" class="block mb-1 text-sm font-semibold text-label">Build Up</label><input type="range" id="evolve-up" min="10" max="360" value="120" step="5" class="w-full"><div class="text-center mt-0 text-display font-mono text-sm"><span id="evolve-up-value">120</span>s</div></div>
            <div data-instrument="evolve-breakdown" class="mt-2"><label for="evolve-breakdown" class="block mb-1 text-sm font-semibold text-label">Break Down</label><input type="range" id="evolve-breakdown" min="10" max="180" value="20" step="5" class="w-full"><div class="text-center mt-0 text-display font-mono text-sm"><span id="evolve-breakdown-value">20</span>s</div></div>
            <div data-instrument="evolve-peak" class="mt-2"><label for="evolve-peak" class="block mb-1 text-sm font-semibold text-label">Peak Time</label><input type="range" id="evolve-peak" min="1" max="90" value="10" step="1" class="w-full"><div class="text-center mt-0 text-display font-mono text-sm"><span id="evolve-peak-value">10</span>s</div></div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-2">
        <div class="lg:col-span-2 control-group p-3 rounded-xl mb-2">
            <h2 class="section-header text-lg font-bold text-center mb-2 uppercase">Mixer</h2>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-x-2 gap-y-1">
                <div data-instrument="bass"><label for="bass-vol" class="block text-center mb-1 text-sm font-semibold text-label">Bass</label><input type="range" id="bass-vol" min="-40" max="0" value="-4" step="1" class="w-full"><div class="text-center mt-0 text-display font-mono text-sm"><span id="bass-vol-value">-4</span> dB</div></div>
                <div data-instrument="pluck"><label for="pluck-vol" class="block text-center mb-1 text-sm font-semibold text-label">Pluck</label><input type="range" id="pluck-vol" min="-40" max="0" value="-10" step="1" class="w-full"><div class="text-center mt-0 text-display font-mono text-sm"><span id="pluck-vol-value">-10</span> dB</div></div>
                <div data-instrument="pad"><label for="pad-vol" class="block text-center mb-1 text-sm font-semibold text-label">Pad</label><input type="range" id="pad-vol" min="-40" max="0" value="-12" step="1" class="w-full"><div class="text-center mt-0 text-display font-mono text-sm"><span id="pad-vol-value">-12</span> dB</div></div>
                <div data-instrument="lfoPad"><label for="lfoPad-vol" class="block text-center mb-1 text-sm font-semibold text-label">LFO Pad</label><input type="range" id="lfoPad-vol" min="-40" max="0" value="-24" step="1" class="w-full"><div class="text-center mt-0 text-display font-mono text-sm"><span id="lfoPad-vol-value">-24</span> dB</div></div>
                <div data-instrument="melody"><label for="melody-vol" class="block text-center mb-1 text-sm font-semibold text-label">Melody</label><input type="range" id="melody-vol" min="-40" max="0" value="-12" step="1" class="w-full"><div class="text-center mt-0 text-display font-mono text-sm"><span id="melody-vol-value">-12</span> dB</div></div>
                <div data-instrument="openhat"><label for="openhat-vol" class="block text-center mb-1 text-sm font-semibold text-label">Open Hat</label><input type="range" id="openhat-vol" min="-40" max="0" value="-18" step="1" class="w-full"><div class="text-center mt-0 text-display font-mono text-sm"><span id="openhat-vol-value">-18</span> dB</div></div>
                <div data-instrument="hat"><label for="hat-vol" class="block text-center mb-1 text-sm font-semibold text-label">Hat</label><input type="range" id="hat-vol" min="-40" max="0" value="-12" step="1" class="w-full"><div class="text-center mt-0 text-display font-mono text-sm"><span id="hat-vol-value">-12</span> dB</div></div>
                <div data-instrument="rumble"><label for="rumble-vol" class="block text-center mb-1 text-sm font-semibold text-label">Rumble</label><input type="range" id="rumble-vol" min="-40" max="0" value="-20" step="1" class="w-full"><div class="text-center mt-0 text-display font-mono text-sm"><span id="rumble-vol-value">-20</span> dB</div></div>
            </div>
        </div>
        <div class="control-group p-3 rounded-xl mb-2">
            <h2 class="section-header text-lg font-bold text-center mb-2 uppercase">Live Notes</h2>
            <div id="live-notes-display" class="grid grid-cols-3 sm:grid-cols-4 gap-1 text-center font-mono text-sm h-full min-h-[6rem]"></div>
        </div>
    </div>

    <div class="control-group p-2 rounded-xl">
        <h2 class="section-header text-lg font-bold text-center mb-2 uppercase">Drum Sequencer</h2>
        <div id="sequencer-grid" class="flex gap-1 sm:gap-2 justify-center">
            <div id="sequencer-labels" class="flex flex-col gap-1 sm:gap-2 justify-around text-right pr-2">
                <!-- Labels will be generated here -->
            </div>
            <div id="sequencer-steps" class="flex flex-col gap-1 sm:gap-2">
                <!-- Steps will be generated here -->
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Global State & Constants ---
        let isPlaying = false;
        let currentScale = [];
        let evolveState = 'Idle';
        const NOTES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const SCALE_INTERVALS = {
            majorPentatonic: [0, 2, 4, 7, 9], minorPentatonic: [0, 3, 5, 7, 10], major: [0, 2, 4, 5, 7, 9, 11],
            minor: [0, 2, 3, 5, 7, 8, 10], dorian: [0, 2, 3, 5, 7, 9, 10],
        };
        const MOOD_COLORS = {
            'Frenetic & Euphoric': 'hsl(320, 100%, 65%)',
            'Frenetic & Intense': 'hsl(350, 100%, 65%)',
            'Frenetic & Mystical': 'hsl(290, 100%, 75%)',
            'Energetic & Euphoric': 'hsl(340, 89%, 60%)',
            'Driving & Euphoric': 'hsl(45, 100%, 58%)',
            'Relaxed & Hopeful': 'hsl(145, 63%, 49%)',
            'Meditative & Hopeful': 'hsl(195, 74%, 65%)',
            'Energetic & Intense': 'hsl(3, 90%, 61%)',
            'Driving & Intense': 'hsl(25, 84%, 55%)',
            'Relaxed & Somber': 'hsl(262, 47%, 56%)',
            'Meditative & Somber': 'hsl(220, 47%, 56%)',
            'Energetic & Mystical': 'hsl(283, 89%, 70%)',
            'Driving & Mystical': 'hsl(283, 60%, 60%)',
            'Relaxed & Mystical': 'hsl(283, 40%, 50%)',
            'Meditative & Mystical': 'hsl(283, 30%, 40%)',
        };
        let NUM_STEPS = 16;
        let seq_data = {
            kick: Array(NUM_STEPS).fill(false),
            snare: Array(NUM_STEPS).fill(false),
            hat: Array(NUM_STEPS).fill(false),
            openhat: Array(NUM_STEPS).fill(false)
        };
        let controls = {};
        let drumSequence;

        // --- DOM Element References ---
        const dom = {
            mainTitle: document.getElementById('main-title'),
            playStopButton: document.getElementById('play-stop-button'),
            newMoodButton: document.getElementById('new-mood-button'),
            messageBox: document.getElementById('message-box'),
            rootNoteSelect: document.getElementById('root-note-select'),
            scaleTypeSelect: document.getElementById('scale-type-select'),
            octaveSelect: document.getElementById('octave-select'),
            sequencerGrid: document.getElementById('sequencer-grid'),
            sequencerLabels: document.getElementById('sequencer-labels'),
            sequencerSteps: document.getElementById('sequencer-steps'),
            themeSwitcher: document.getElementById('theme-switcher'),
            themeIconDark: document.getElementById('theme-icon-dark'),
            themeIconLight: document.getElementById('theme-icon-light'),
            liveNotesDisplay: document.getElementById('live-notes-display'),
            statusBar: {
                evolveState: document.getElementById('evolve-state-display'),
                mood: document.getElementById('mood-display'),
                tempo: document.getElementById('tempo-display'),
                chord: document.getElementById('chord-display'),
                scale: document.getElementById('scale-display'),
            }
        };

        // --- Audio Setup ---
        const limiter = new Tone.Limiter(-0.5).toDestination();
        const masterVolume = new Tone.Volume(0).connect(limiter);

        // LFO Pad setup
        const lfoPadFilter = new Tone.Filter(400, "lowpass").connect(masterVolume);
        const lfo = new Tone.LFO({
            type: "sine",
            min: 200,
            max: 4000,
            frequency: "4n",
        }).connect(lfoPadFilter.frequency).start();

        // Rumble Setup
        const rumbleReverb = new Tone.Reverb({ decay: 4, wet: 0.8 }).connect(masterVolume);
        const rumbleFilter = new Tone.Filter(80, "lowpass").connect(rumbleReverb);
        const rumble = new Tone.MonoSynth({
            volume: -20,
            oscillator: { type: "sine" },
            envelope: { attack: 0.01, decay: 0.4, sustain: 1, release: 0.8 }
        }).connect(rumbleFilter);

        const synths = {
            kick: new Tone.MembraneSynth({ volume: -2, octaves: 10, pitchDecay: 0.05, envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 1.4, attackCurve: 'exponential' } }).connect(masterVolume),
            snare: new Tone.NoiseSynth({ volume: -14, noise: { type: 'white' }, envelope: { attack: 0.001, decay: 0.15, sustain: 0, release: 0.2 } }).connect(masterVolume),
            hat: new Tone.MetalSynth({ volume: -18, frequency: 300, envelope: { attack: 0.005, decay: 0.05, release: 0.08 }, harmonicity: 5.1, modulationIndex: 32, resonance: 4000, octaves: 1.5 }).connect(masterVolume),
            openhat: new Tone.MetalSynth({ volume: -18, frequency: 250, envelope: { attack: 0.01, decay: 0.4, release: 0.4 }, harmonicity: 5.1, modulationIndex: 32, resonance: 4000, octaves: 1.5 }).connect(masterVolume),
            bass: new Tone.MonoSynth({ volume: -4, oscillator: { type: 'fatsquare' }, envelope: { attack: 0.05, decay: 0.3, sustain: 0.4, release: 2 }, filterEnvelope: { attack: 0.01, decay: 0.6, sustain: 0.2, release: 2, baseFrequency: 80, octaves: 4 } }).connect(masterVolume),
            pluck: new Tone.PluckSynth({ volume: -10, attackNoise: 0.8, dampening: 5000, resonance: 0.95 }).connect(masterVolume),
            pad: new Tone.PolySynth(Tone.FMSynth, { volume: -12, envelope: { attack: 1, decay: 0.5, sustain: 0.5, release: 3 } }).set({ maxPolyphony: 6 }).connect(masterVolume),
            melody: new Tone.FMSynth({ volume: -12, envelope: { attack: 0.02, decay: 0.3,