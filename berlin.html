<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generative Polyphonic Music</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* --- Base Theme (Dark) --- */
        :root {
            --base-hue: 244;
            --bg-body: #0a0a0a;
            --bg-panel: #111827;
            --bg-control: rgba(255, 255, 255, 0.1);
            --text-header: hsl(var(--base-hue), 91%, 74%);
            --text-body: #f9fafb;
            --text-label: #f3f4f6;
            --text-display: hsl(var(--base-hue), 93%, 82%);
            --border-color: #374151;
            --thumb-color: hsl(var(--base-hue), 76%, 58%);
            --note-highlight-color: hsl(var(--base-hue), 100%, 85%);
            --panel-flash-color: rgba(255, 255, 255, 0.2);
        }
        /* --- Vintage Theme --- */
        .theme-vintage {
            --base-hue: 28;
            --bg-body: #e7e2d8;
            --bg-panel: #d4cec3;
            --bg-control: rgba(0, 0, 0, 0.05);
            --text-header: hsl(var(--base-hue), 39%, 39%);
            --text-body: #1c1917;
            --text-label: #292524;
            --text-display: hsl(var(--base-hue), 96%, 44%);
            --border-color: #c7c1b8;
            --thumb-color: hsl(var(--base-hue), 57%, 49%);
            --note-highlight-color: hsl(var(--base-hue), 100%, 50%);
            --panel-flash-color: rgba(0, 0, 0, 0.1);
        }
        body { background-color: var(--bg-body); color: var(--text-body); }
        .main-panel { background: var(--bg-panel); border-color: var(--border-color); }
        .control-group { background-color: var(--bg-control); border-color: var(--border-color); transition: background-color 0.1s ease-out; }
        h1 { color: var(--text-header); }
        label, .text-label { color: var(--text-label); }
        .text-display { color: var(--text-display); }
        select { background-color: var(--bg-control); border-color: var(--border-color); color: var(--text-label); }
        .custom-checkbox:checked { background-color: var(--thumb-color); border-color: var(--thumb-color); }

        input[type="range"]::-webkit-slider-thumb { background: var(--thumb-color); }
        input[type="range"]::-moz-range-thumb { background: var(--thumb-color); }

        select {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            background-image: var(--select-arrow-url);
            background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 1.2em; padding-right: 2.5rem;
        }
        .note-playing {
            color: var(--note-highlight-color);
            transform: scale(1.2);
            transition: all 0.1s ease-out;
        }
        .panel-playing {
            background-color: var(--panel-flash-color);
        }
        /* Toggle Switch Styles */
        .toggle-label {
            position: relative;
            display: inline-flex;
            align-items: center;
            cursor: pointer;
        }
        .toggle-checkbox {
            opacity: 0;
            width: 0;
            height: 0;
            position: absolute;
        }
        .toggle-switch {
            width: 44px;
            height: 24px;
            background-color: #4b5563;
            border-radius: 9999px;
            transition: background-color 0.2s ease-in-out;
            position: relative;
        }
        .toggle-switch::before {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            background-color: white;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: transform 0.2s ease-in-out;
        }
        .toggle-checkbox:checked + .toggle-switch {
            background-color: var(--thumb-color);
        }
        .toggle-checkbox:checked + .toggle-switch::before {
            transform: translateX(20px);
        }
    </style>
</head>
<body class="transition-colors duration-500">

<div class="main-panel w-full max-w-4xl mx-auto p-2 my-2 rounded-2xl shadow-2xl border transition-colors duration-500">
    <!-- Header -->
    <div class="relative text-center mb-2">
        <h1 class="text-2xl sm:text-3xl font-bold tracking-tight transition-colors duration-500">Generative Music</h1>
        <p class="mt-1 text-sm text-label transition-colors duration-500">An ever-changing soundscape</p>
        <!-- Theme Switcher -->
        <div class="absolute top-0 right-2">
            <button id="theme-switcher" title="Toggle theme" class="p-2 rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-[var(--bg-panel)] focus:ring-[var(--thumb-color)]">
                <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" /></svg>
                <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-1.414 8.486a1 1 0 010-1.414l.707-.707a1 1 0 111.414 1.414l-.707.707a1 1 0 01-1.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1z" clip-rule="evenodd" /></svg>
            </button>
        </div>
    </div>

    <!-- Main Controls -->
    <div class="grid grid-cols-1 sm:grid-cols-3 items-center justify-center gap-2 mb-2">
        <button id="play-stop-button" title="Start or stop the music" class="bg-[var(--thumb-color)] hover:opacity-80 text-white font-bold py-2 px-3 rounded-full text-lg transition-all duration-300 ease-in-out shadow-lg transform hover:scale-105 sm:col-span-3">
            Start
        </button>
        <div class="relative col-span-1 sm:col-span-1">
            <select id="root-note-select" title="Select the root note of the scale" class="text-base rounded-lg focus:ring-[var(--thumb-color)] focus:border-[var(--thumb-color)] block w-full p-2">
                <option>C</option> <option>C#</option> <option>D</option> <option>D#</option> <option>E</option> <option>F</option> <option>F#</option> <option>G</option> <option>G#</option> <option>A</option> <option>A#</option> <option>B</option>
            </select>
        </div>
        <div class="relative col-span-1 sm:col-span-1">
            <select id="scale-type-select" title="Select the musical scale for the composition" class="text-base rounded-lg focus:ring-[var(--thumb-color)] focus:border-[var(--thumb-color)] block w-full p-2">
                <option value="majorPentatonic">Major Pentatonic</option> <option value="minorPentatonic">Minor Pentatonic</option> <option value="major">Major (Ionian)</option> <option value="minor" selected>Minor (Aeolian)</option> <option value="dorian">Dorian</option> <option value="lydian">Lydian</option> <option value="mixolydian">Mixolydian</option> <option value="phrygian">Phrygian</option> <option value="insen">Japanese 'Insen'</option>
            </select>
        </div>
        <div class="relative col-span-1 sm:col-span-1">
            <select id="octave-select" title="Select the starting octave" class="text-base rounded-lg focus:ring-[var(--thumb-color)] focus:border-[var(--thumb-color)] block w-full p-2">
                <option>1</option> <option>2</option> <option selected>3</option> <option>4</option> <option>5</option>
            </select>
        </div>
        <div class="flex items-center justify-around w-full col-span-1 sm:col-span-3">
            <label class="toggle-label" title="Switch to a 7/8 time signature with a driving, hypnotic beat"><input type="checkbox" id="berlin-toggle" class="toggle-checkbox" checked><div class="toggle-switch"></div><span class="ml-2 text-base text-label">Berlin</span></label>
            <label class="toggle-label" title="Toggle a slow, sweeping filter effect with a subtle LFO for added movement"><input type="checkbox" id="filter-toggle" class="toggle-checkbox" checked><div class="toggle-switch"></div><span class="ml-2 text-base text-label">Filter</span></label>
            <label class="toggle-label" title="Slowly modulate parameters and change key/octave over a long cycle"><input type="checkbox" id="evolve-toggle" class="toggle-checkbox" checked><div class="toggle-switch"></div><span class="ml-2 text-base text-label">Evolve</span></label>
        </div>
    </div>

    <div id="message-box" class="text-center text-yellow-400 mb-2 h-5"></div>

    <!-- Volume Controls -->
    <div class="grid grid-cols-2 sm:grid-cols-3 gap-1">
        <div class="control-group p-1 rounded-xl" data-instrument="master"><label for="master-vol" class="block mb-0 text-sm font-semibold text-label">Master Volume</label><input type="range" id="master-vol" min="-20" max="6" value="3" step="1" class="w-full" title="Adjust the overall output volume"><div class="text-center mt-0 text-display font-mono text-sm"><span id="master-vol-value">3</span> dB</div></div>
        <div class="control-group p-1 rounded-xl" data-instrument="tempo"><label for="tempo" class="block mb-0 text-sm font-semibold text-label">Tempo</label><input type="range" id="tempo" min="60" max="120" value="120" class="w-full" title="Adjust the speed of the music (beats per minute)"><div class="text-center mt-0 text-display font-mono text-sm"><span id="tempo-value">120</span> BPM</div></div>
        <div class="control-group p-1 rounded-xl" data-instrument="density"><label for="density" class="block mb-0 text-sm font-semibold text-label">Density</label><input type="range" id="density" min="0.1" max="1.0" value="0.5" step="0.05" class="w-full" title="Controls how many notes are generated"><div class="text-center mt-0 text-display font-mono text-sm"><span id="density-value">0.5</span></div></div>
        <div class="control-group p-1 rounded-xl" data-instrument="swing"><label for="swing" class="block mb-0 text-sm font-semibold text-label">Swing</label><input type="range" id="swing" min="0" max="0.8" value="0" step="0.05" class="w-full" title="Adjust the rhythmic shuffle/groove"><div class="text-center mt-0 text-display font-mono text-sm"><span id="swing-value">0</span></div></div>
        <div class="control-group p-1 rounded-xl" data-instrument="reverb"><label for="reverb-amount" class="block mb-0 text-sm font-semibold text-label">Reverb</label><input type="range" id="reverb-amount" min="0" max="1" value="0.6" step="0.05" class="w-full" title="Adjust the amount of reverb"><div class="text-center mt-0 text-display font-mono text-sm"><span id="reverb-amount-value">0.6</span></div></div>
        <div class="control-group p-1 rounded-xl" data-instrument="filterQ"><label for="filter-q" class="block mb-0 text-sm font-semibold text-label">Filter Resonance</label><input type="range" id="filter-q" min="1" max="20" value="6" step="0.5" class="w-full" title="Adjust the sharpness of the filter sweep effect"><div class="text-center mt-0 text-display font-mono text-sm"><span id="filter-q-value">6</span></div></div>
        <div class="control-group p-1 rounded-xl" data-instrument="evolve-up"><label for="evolve-up" class="block mb-0 text-sm font-semibold text-label">Evolve Build Up</label><input type="range" id="evolve-up" min="10" max="120" value="60" step="5" class="w-full" title="Evolve mode build-up time (seconds)"><div class="text-center mt-0 text-display font-mono text-sm"><span id="evolve-up-value">60</span>s</div></div>
        <div class="control-group p-1 rounded-xl" data-instrument="evolve-down"><label for="evolve-down" class="block mb-0 text-sm font-semibold text-label">Evolve Build Down</label><input type="range" id="evolve-down" min="10" max="60" value="30" step="5" class="w-full" title="Evolve mode build-down time (seconds)"><div class="text-center mt-0 text-display font-mono text-sm"><span id="evolve-down-value">30</span>s</div></div>
        <div class="control-group p-1 rounded-xl" data-instrument="evolve-peak"><label for="evolve-peak" class="block mb-0 text-sm font-semibold text-label">Evolve Peak Time</label><input type="range" id="evolve-peak" min="1" max="30" value="10" step="1" class="w-full" title="Evolve mode peak hold time (seconds)"><div class="text-center mt-0 text-display font-mono text-sm"><span id="evolve-peak-value">10</span>s</div></div>
        <div class="control-group p-1 rounded-xl" data-instrument="drum-pattern"><label for="drum-pattern" class="block mb-0 text-sm font-semibold text-label">Drum Pattern</label><select id="drum-pattern" title="Select the drum pattern for Berlin mode" class="text-base rounded-lg focus:ring-[var(--thumb-color)] focus:border-[var(--thumb-color)] block w-full p-2"><option value="driving">Driving</option><option value="syncopated">Syncopated</option><option value="complex">Complex</option></select></div>
        <div class="control-group p-1 rounded-xl" data-instrument="snare"><label for="snare-vol" class="block mb-0 text-sm font-semibold text-label">Snare</label><input type="range" id="snare-vol" min="-40" max="0" value="-18" step="1" class="w-full" title="Adjust the Snare Drum volume"><div class="text-center mt-0 text-display font-mono text-sm"><span id="snare-vol-value">-18</span> dB</div></div>
        <div class="control-group p-1 rounded-xl" data-instrument="hat"><label for="hat-vol" class="block mb-0 text-sm font-semibold text-label">Hat</label><input type="range" id="hat-vol" min="-40" max="0" value="-16" step="1" class="w-full" title="Adjust the Hi-Hat volume"><div class="text-center mt-0 text-display font-mono text-sm"><span id="hat-vol-value">-16</span> dB</div></div>
        <div class="control-group p-1 rounded-xl" data-instrument="bass"><label for="bass-vol" class="block mb-0 text-sm font-semibold text-label">Bass</label><input type="range" id="bass-vol" min="-40" max="0" value="-12" step="1" class="w-full" title="Adjust the mellow, ambient Bass synth volume"><div class="text-center mt-0 text-display font-mono text-sm"><span id="bass-vol-value">-12</span> dB</div></div>
        <div class="control-group p-1 rounded-xl" data-instrument="pluck"><label for="pluck-vol" class="block mb-0 text-sm font-semibold text-label">Pluck/Arp</label><input type="range" id="pluck-vol" min="-40" max="0" value="-15" step="1" class="w-full" title="Adjust the Pluck/Arpeggio synth volume"><div class="text-center mt-0 text-display font-mono text-sm"><span id="pluck-vol-value">-15</span> dB</div></div>
        <div class="control-group p-1 rounded-xl" data-instrument="melody"><label for="melody-vol" class="block mb-0 text-sm font-semibold text-label">Melody</label><input type="range" id="melody-vol" min="-40" max="0" value="-12" step="1" class="w-full" title="Adjust the Melody synth volume"><div class="text-center mt-0 text-display font-mono text-sm"><span id="melody-vol-value">-12</span> dB</div></div>
        <div class="control-group p-1 rounded-xl" data-instrument="pad"><label for="pad-vol" class="block mb-0 text-sm font-semibold text-label">Pad</label><input type="range" id="pad-vol" min="-40" max="0" value="-22" step="1" class="w-full" title="Adjust the Pad synth volume"><div class="text-center mt-0 text-display font-mono text-sm"><span id="pad-vol-value">-22</span> dB</div></div>
        <div class="control-group p-1 rounded-xl" data-instrument="bell"><label for="bell-vol" class="block mb-0 text-sm font-semibold text-label">Bell</label><input type="range" id="bell-vol" min="-40" max="0" value="-16" step="1" class="w-full" title="Adjust the Bell synth volume"><div class="text-center mt-0 text-display font-mono text-sm"><span id="bell-vol-value">-16</span> dB</div></div>
        <div class="control-group p-1 rounded-xl" data-instrument="waterDrop"><label for="water-drop-vol" class="block mb-0 text-sm font-semibold text-label">Water Drop</label><input type="range" id="water-drop-vol" min="-40" max="0" value="-12" step="1" class="w-full" title="Adjust the Water Drop sound volume"><div class="text-center mt-0 text-display font-mono text-sm"><span id="water-drop-vol-value">-12</span> dB</div></div>
    </div>

    <!-- Scale Display Panel -->
    <div class="control-group p-2 rounded-xl mt-1">
        <div class="flex flex-wrap justify-center items-center gap-x-4">
            <div class="flex items-center gap-2">
                <span class="text-sm font-semibold text-label">Current Scale:</span>
                <div id="scale-notes-container" class="flex flex-wrap justify-center gap-x-3 gap-y-1 text-display font-mono text-sm">
                    <!-- Notes will be dynamically inserted here -->
                </div>
            </div>
            <div id="evolve-display-container" class="hidden flex items-center gap-2 pt-1 sm:pt-0">
                <span class="text-sm font-semibold text-label">Evolve:</span>
                <div class="flex justify-center gap-x-3 text-display font-mono text-xs">
                    <div>Tempo: <span id="evolve-tempo"></span></div>
                    <div>Density: <span id="evolve-density"></span></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Element References ---
        const playStopButton = document.getElementById('play-stop-button');
        const messageBox = document.getElementById('message-box');
        const rootNoteSelect = document.getElementById('root-note-select');
        const scaleTypeSelect = document.getElementById('scale-type-select');
        const octaveSelect = document.getElementById('octave-select');
        const reverbToggle = document.getElementById('reverb-toggle');
        const filterToggle = document.getElementById('filter-toggle');
        const berlinToggle = document.getElementById('berlin-toggle');
        const evolveToggle = document.getElementById('evolve-toggle');
        const scaleNotesContainer = document.getElementById('scale-notes-container');
        const evolveDisplayContainer = document.getElementById('evolve-display-container');

        // --- Control Sliders and Displays ---
        const controls = {
            master: { slider: document.getElementById('master-vol'), display: document.getElementById('master-vol-value') },
            tempo: { slider: document.getElementById('tempo'), display: document.getElementById('tempo-value') },
            density: { slider: document.getElementById('density'), display: document.getElementById('density-value') },
            swing: { slider: document.getElementById('swing'), display: document.getElementById('swing-value') },
            filterQ: { slider: document.getElementById('filter-q'), display: document.getElementById('filter-q-value') },
            reverb: { slider: document.getElementById('reverb-amount'), display: document.getElementById('reverb-amount-value') },
            snare: { slider: document.getElementById('snare-vol'), display: document.getElementById('snare-vol-value') },
            hat: { slider: document.getElementById('hat-vol'), display: document.getElementById('hat-vol-value') },
            bass: { slider: document.getElementById('bass-vol'), display: document.getElementById('bass-vol-value') },
            pluck: { slider: document.getElementById('pluck-vol'), display: document.getElementById('pluck-vol-value') },
            melody: { slider: document.getElementById('melody-vol'), display: document.getElementById('melody-vol-value') },
            pad: { slider: document.getElementById('pad-vol'), display: document.getElementById('pad-vol-value') },
            bell: { slider: document.getElementById('bell-vol'), display: document.getElementById('bell-vol-value') },
            waterDrop: { slider: document.getElementById('water-drop-vol'), display: document.getElementById('water-drop-vol-value') },
            evolveUp: { slider: document.getElementById('evolve-up'), display: document.getElementById('evolve-up-value') },
            evolveDown: { slider: document.getElementById('evolve-down'), display: document.getElementById('evolve-down-value') },
            evolvePeak: { slider: document.getElementById('evolve-peak'), display: document.getElementById('evolve-peak-value') },
        };

        let isPlaying = false;
        let stepCounter = 0;
        let currentArpPattern = 'up';
        const arpPatterns = ['up', 'down', 'upDown', 'random'];
        let currentScale = [];
        let baseHue = 244;
        const darkThemeBaseHue = 244;
        const vintageThemeBaseHue = 28;

        // --- Music Theory ---
        const NOTES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const SCALE_INTERVALS = {
            majorPentatonic: [0, 2, 4, 7, 9],
            minorPentatonic: [0, 3, 5, 7, 10],
            major: [0, 2, 4, 5, 7, 9, 11],
            minor: [0, 2, 3, 5, 7, 8, 10],
            dorian: [0, 2, 3, 5, 7, 9, 10],
            lydian: [0, 2, 4, 6, 7, 9, 11],
            mixolydian: [0, 2, 4, 5, 7, 9, 10],
            phrygian: [0, 1, 3, 5, 7, 8, 10],
            insen: [0, 1, 5, 7, 10]
        };
        const scaleKeys = Object.keys(SCALE_INTERVALS);

        const DRUM_PATTERNS = {
            driving: { snare: [4, 12], hat: [2, 6, 10] },
            syncopated: { snare: [4, 10], hat: [0, 2, 6, 8, 12] },
            complex: { snare: [4, 11], hat: [0, 2, 6, 8, 10, 13] }
        };

        function generateScale(rootNote, scaleType, startOctave, numOctaves = 4) {
            const rootIndex = NOTES.indexOf(rootNote);
            if (rootIndex === -1) return [];
            const intervals = SCALE_INTERVALS[scaleType];
            if (!intervals) return [];

            const scale = [];
            for (let oct = 0; oct < numOctaves; oct++) {
                for (const interval of intervals) {
                    const noteIndex = rootIndex + interval;
                    const currentOctave = startOctave + oct + Math.floor(noteIndex / 12);
                    scale.push(NOTES[noteIndex % 12] + currentOctave);
                }
            }
            return scale;
        }

        function getNoteAtIndex(note, interval) {
            const rootIndex = NOTES.indexOf(note);
            if (rootIndex === -1) return note;
            const newIndex = (rootIndex + interval % 12 + 12) % 12;
            return NOTES[newIndex];
        }

        // --- Audio Setup: Synths and Effects ---
        const masterVolume = new Tone.Volume(0).toDestination();
        const initialReverbWet = 0.6;
        const reverb = new Tone.Reverb({ decay: 6, wet: initialReverbWet, preDelay: 0.05 });
        const delay = new Tone.FeedbackDelay("8n.", 0.4).connect(reverb);
        const chorus = new Tone.Chorus(4, 2.5, 0.5).connect(reverb);
        const vibrato = new Tone.Vibrato(5, 0.1).connect(reverb);
        const autoFilter = new Tone.AutoFilter("2m").connect(masterVolume);
        const filterLfo = new Tone.LFO(0.02, 0.05, 0.2).connect(autoFilter.frequency);
        autoFilter.filter.Q.value = 6;
        autoFilter.wet.value = 0;
        reverb.connect(autoFilter);


        // --- Instrument Definitions ---
        const synths = {
            snare: new Tone.NoiseSynth({ noise: { type: 'white' }, envelope: { attack: 0.001, decay: 0.15, sustain: 0, release: 0.2 } }).connect(reverb),
            hat: new Tone.MetalSynth({ frequency: 250, envelope: { attack: 0.005, decay: 0.1, release: 0.08 }, harmonicity: 5.1, modulationIndex: 32, resonance: 4000, octaves: 1.5 }).connect(reverb),
            bass: new Tone.MonoSynth({ oscillator: { type: 'sine' }, envelope: { attack: 0.8, decay: 0.4, sustain: 0.1, release: 4.0 }, filterEnvelope: { attack: 0.5, decay: 0.1, sustain: 0.3, release: 4, baseFrequency: 100, octaves: 3 } }).connect(reverb),
            pluck: new Tone.PluckSynth({ attackNoise: 1, dampening: 6000, resonance: 0.9 }).connect(vibrato),
            melody: new Tone.PolySynth(Tone.FMSynth, { harmonicity: 1.5, modulationIndex: 1.2, envelope: { attack: 0.02, decay: 0.3, sustain: 0.1, release: 0.8 }, modulationEnvelope: { attack: 0.1, decay: 0.2, sustain: 0.3, release: 0.8 } }).connect(vibrato),
            pad: new Tone.PolySynth(Tone.Synth, { oscillator: { type: "fatsawtooth", count: 2, spread: 30 }, envelope: { attack: 0.5, decay: 1, sustain: 0.4, release: 2.5 } }).connect(chorus),
            bell: new Tone.FMSynth({ harmonicity: 2, modulationIndex: 10, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 2 }, modulationEnvelope: { attack: 0.01, decay: 0.5, sustain: 0.01, release: 2 } }).connect(delay),
            waterDrop: new Tone.FMSynth({ harmonicity: 8, modulationIndex: 20, oscillator: { type: 'sine' }, envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.2 }, modulation: { type: 'sine' }, modulationEnvelope: { attack: 0.001, decay: 0.5, sustain: 0, release: 0.5 }, }).connect(delay)
        };

        // --- Initialization ---
        function initialize() {
            Object.values(controls).forEach(c => { c.display.textContent = c.slider.value; });
            Object.keys(controls).forEach(name => {
                if (synths[name]) synths[name].volume.value = controls[name].slider.value;
            });
            masterVolume.volume.value = controls.master.slider.value;
            Tone.Transport.lookAhead = 0.1;

            const randomRoot = NOTES[Math.floor(Math.random() * NOTES.length)];
            const randomTypeKey = scaleKeys[Math.floor(Math.random() * scaleKeys.length)];
            rootNoteSelect.value = randomRoot;
            scaleTypeSelect.value = randomTypeKey;
            updateCurrentScale();

            updateUIColor(Tone.Transport.bpm.value);
            if (evolveToggle.checked) {
                evolveToggle.dispatchEvent(new Event('change'));
            }
            if (berlinToggle.checked) {
                berlinToggle.dispatchEvent(new Event('change'));
            } else {
                synths.snare.volume.value = -Infinity;
            }
        }

        function noteToUtf8(note) {
            return note.replace('#', '♯').replace('b', '♭');
        }

        function updateScaleDisplay() {
            scaleNotesContainer.innerHTML = '';
            const uniqueNotes = [...new Set(currentScale.map(n => n.slice(0, -1)))];
            uniqueNotes.forEach(noteName => {
                const noteEl = document.createElement('span');
                noteEl.textContent = noteToUtf8(noteName);
                noteEl.id = `note-${noteName.replace('#', 's')}`;
                noteEl.className = "transition-all duration-100";
                scaleNotesContainer.appendChild(noteEl);
            });
        }

        function highlightNote(note) {
            const noteName = note.slice(0, -1);
            const el = document.getElementById(`note-${noteName.replace('#', 's')}`);
            if (el) {
                el.classList.add('note-playing');
                setTimeout(() => el.classList.remove('note-playing'), 150);
            }
        }

        function updateCurrentScale() {
            const root = rootNoteSelect.value;
            const type = scaleTypeSelect.value;
            const octave = parseInt(octaveSelect.value, 10);
            currentScale = generateScale(root, type, 4, octave);
            updateScaleDisplay();
        }

        function modulateToNewKey() {
            const currentRoot = rootNoteSelect.value;
            const currentType = scaleTypeSelect.value;
            const moves = [];
            const fifthUp = getNoteAtIndex(currentRoot, 7);
            moves.push({ root: fifthUp, type: currentType });
            const fifthDown = getNoteAtIndex(currentRoot, -5);
            moves.push({ root: fifthDown, type: currentType });
            const isMajor = ['majorPentatonic', 'major', 'lydian', 'mixolydian'].includes(currentType);
            if (isMajor) {
                moves.push({ root: currentRoot, type: 'minor' });
                const relativeMinorRoot = getNoteAtIndex(currentRoot, -3);
                moves.push({ root: relativeMinorRoot, type: 'minor' });
            } else {
                moves.push({ root: currentRoot, type: 'major' });
                const relativeMajorRoot = getNoteAtIndex(currentRoot, 3);
                moves.push({ root: relativeMajorRoot, type: 'major' });
            }
            const otherModes = scaleKeys.filter(k => k !== currentType);
            const randomMode = otherModes[Math.floor(Math.random() * otherModes.length)];
            moves.push({ root: currentRoot, type: randomMode });
            const nextKey = moves[Math.floor(Math.random() * moves.length)];
            rootNoteSelect.value = nextKey.root;
            scaleTypeSelect.value = nextKey.type;
            octaveSelect.value = Math.floor(Math.random() * 3) + 2; // Random octave 2-4
            updateCurrentScale();
        }

        // --- Generative Logic ---
        const loop = new Tone.Loop(time => {
            if (currentScale.length === 0) return;
            const density = parseFloat(controls.density.slider.value);

            // --- BERLIN MODE LOGIC (7/8 Time) ---
            if (berlinToggle.checked) {
                const stepIn78 = stepCounter % 14;
                const measureIn78 = Math.floor(stepCounter / 14);
                const pattern = DRUM_PATTERNS[document.getElementById('drum-pattern').value];

                if (pattern.snare.includes(stepIn78)) synths.snare.triggerAttack(time);
                if (pattern.hat.includes(stepIn78)) synths.hat.triggerAttackRelease('C6', '16n', time, Math.random() * 0.4 + 0.4);

                const bassNotes = [currentScale[0], currentScale[2], currentScale[4]].filter(Boolean);
                if (bassNotes.length > 0 && (stepIn78 === 0 || stepIn78 === 4 || stepIn78 === 7 || stepIn78 === 11)) {
                    if (Math.random() < (0.85 * density)) {
                        const note = bassNotes[Math.floor(Math.random() * bassNotes.length)];
                        synths.bass.triggerAttackRelease(note, '16n', time);
                        highlightNote(note);
                    }
                }

                if (measureIn78 % 4 === 0 && stepIn78 === 0) currentArpPattern = arpPatterns[Math.floor(Math.random() * arpPatterns.length)];
                const arpNotes = [currentScale[5], currentScale[7], currentScale[8], currentScale[10], currentScale[12]].filter(Boolean);
                if (arpNotes.length > 0 && Math.random() < density) {
                    let noteToPlay;
                    switch (currentArpPattern) {
                        case 'up': noteToPlay = arpNotes[stepIn78 % arpNotes.length]; break;
                        case 'down': noteToPlay = arpNotes[arpNotes.length - 1 - (stepIn78 % arpNotes.length)]; break;
                        case 'upDown':
                            const idx = stepIn78 % (arpNotes.length * 2);
                            noteToPlay = idx < arpNotes.length ? arpNotes[idx] : arpNotes[arpNotes.length * 2 - 1 - idx];
                            break;
                        case 'random': noteToPlay = arpNotes[Math.floor(Math.random() * arpNotes.length)]; break;
                    }
                    synths.pluck.triggerAttackRelease(noteToPlay, '16n', time);
                    highlightNote(noteToPlay);
                }

                if (stepCounter > 0 && stepCounter % (14 * 4) === 0) {
                    const chord = getChord();
                    if (chord) {
                        synths.pad.triggerAttackRelease(chord, Tone.Time('14 * 4 * 16n'));
                        chord.forEach(highlightNote);
                    }
                }

                // --- DEFAULT AMBIENT LOGIC (4/4 Time) ---
            } else {
                const pos = Tone.Transport.position.split(':');
                const measure = parseInt(pos[0]);
                const beat = parseInt(pos[1]);
                const sixteenth = parseInt(pos[2]);

                if (beat === 0 && sixteenth === 0 && measure % 1 === 0 && Math.random() < (0.8 * density)) {
                    const chord = getChord();
                    if (chord) {
                        synths.pad.triggerAttackRelease(chord, '1m', time);
                        chord.forEach(highlightNote);
                    }
                }
                if (beat === 0 && sixteenth === 0 && measure % 2 === 1 && Math.random() < (0.3 * density)) {
                    const note = getRandomNote(currentScale.slice(currentScale.length - 10));
                    synths.bell.triggerAttackRelease(note, '1m', time);
                    highlightNote(note);
                }
                if (sixteenth === 2 && Math.random() < (0.7 * density)) synths.hat.triggerAttackRelease('C6', '16n', time, Math.random() * 0.5 + 0.5);
                if (Math.random() < (0.1 * density)) synths.hat.triggerAttackRelease('C6', '32n', time + Tone.Time('32n').toSeconds());
                if (sixteenth === 0 && Math.random() < (0.5 * density)) {
                    const note = getRandomNote(currentScale.slice(0, 7));
                    synths.bass.triggerAttackRelease(note, '4n', time);
                    highlightNote(note);
                } else if (sixteenth === 3 && Math.random() < (0.25 * density)) {
                    const note = getRandomNote(currentScale.slice(0, 7));
                    synths.bass.triggerAttackRelease(note, '8n', time);
                    highlightNote(note);
                }
                if (Math.random() < (0.4 * density)) {
                    const note = getRandomNote(currentScale.slice(Math.floor(currentScale.length / 2)));
                    synths.pluck.triggerAttack(note, time);
                    highlightNote(note);
                }
                if (Math.random() < (0.2 * density)) {
                    const note = getRandomNote(currentScale.slice(7, -7));
                    synths.melody.triggerAttackRelease(note, '4n', time);
                    highlightNote(note);
                }
                if (Math.random() < (0.08 * density)) {
                    synths.waterDrop.triggerAttackRelease('G6', '32n', time);
                }
            }
            stepCounter++;
        }, '16n');

        // --- UI Event Listeners ---
        playStopButton.addEventListener('click', async () => {
            if (Tone.context.state !== 'running') {
                messageBox.textContent = 'Initializing Audio Engine...';
                await Tone.start();
                autoFilter.start();
                chorus.start();
                filterLfo.start();
                messageBox.textContent = 'Audio Engine Ready!';
                setTimeout(() => messageBox.textContent = '', 2000);
            }

            if (isPlaying) {
                Tone.Transport.stop();
                loop.stop();
                stepCounter = 0;
                playStopButton.textContent = 'Start';
            } else {
                Tone.Transport.start();
                loop.start(0);
                playStopButton.textContent = 'Stop';
            }
            isPlaying = !isPlaying;
        });

        rootNoteSelect.addEventListener('change', updateCurrentScale);
        scaleTypeSelect.addEventListener('change', updateCurrentScale);
        octaveSelect.addEventListener('change', updateCurrentScale);

        berlinToggle.addEventListener('change', (e) => {
            const fadeTime = 8;
            stepCounter = 0;
            if (e.target.checked) {
                autoFilter.frequency.value = "8m";
                synths.snare.volume.rampTo(controls.snare.slider.value, fadeTime);
            } else {
                autoFilter.frequency.value = "2m";
                synths.snare.volume.rampTo(-Infinity, fadeTime);
            }
        });

        controls.reverb.slider.addEventListener('input', (e) => {
            const newWet = parseFloat(e.target.value);
            reverb.wet.value = newWet;
            controls.reverb.display.textContent = newWet.toFixed(2);
        });
        filterToggle.addEventListener('change', (e) => {
            autoFilter.wet.rampTo(e.target.checked ? 1 : 0, 2);
        });
        controls.filterQ.slider.addEventListener('input', (e) => {
            const newQ = parseFloat(e.target.value);
            autoFilter.filter.Q.value = newQ;
            controls.filterQ.display.textContent = newQ;
        });
        controls.master.slider.addEventListener('input', (e) => {
            const newVol = parseInt(e.target.value, 10);
            masterVolume.volume.value = newVol;
            controls.master.display.textContent = newVol;
        });
        controls.tempo.slider.addEventListener('input', (e) => {
            const newTempo = parseInt(e.target.value, 10);
            Tone.Transport.bpm.value = newTempo;
            controls.tempo.display.textContent = newTempo;
            if (!evolveToggle.checked) {
                updateUIColor(newTempo);
            }
        });
        controls.density.slider.addEventListener('input', (e) => {
            controls.density.display.textContent = parseFloat(e.target.value).toFixed(2);
        });
        controls.swing.slider.addEventListener('input', (e) => {
            const swingVal = parseFloat(e.target.value);
            Tone.Transport.swing = swingVal;
            controls.swing.display.textContent = swingVal.toFixed(2);
        });

        Object.keys(synths).forEach(synthName => {
            const control = controls[synthName];
            if (control) {
                control.slider.addEventListener('input', (e) => {
                    const newVol = parseInt(e.target.value, 10);
                    synths[synthName].volume.value = newVol;
                    control.display.textContent = newVol;
                });
            }
        });

        let evolveSignal = new Tone.Signal(0);
        let evolveUpdateLoop;

        function startEvolveCycle() {
            const buildUpTime = parseFloat(controls.evolveUp.slider.value);
            const buildDownTime = parseFloat(controls.evolveDown.slider.value);
            const peakTime = parseFloat(controls.evolvePeak.slider.value);
            const totalCycleTime = buildUpTime + peakTime + buildDownTime;

            evolveSignal.rampTo(1, buildUpTime);
            Tone.Transport.scheduleOnce(() => {
                evolveSignal.rampTo(0, buildDownTime);
            }, `+${buildUpTime + peakTime}`);

            Tone.Transport.scheduleOnce(() => {
                modulateToNewKey();
                startEvolveCycle();
            }, `+${totalCycleTime}`);
        }

        evolveToggle.addEventListener('change', (e) => {
            if(e.target.checked) {
                evolveDisplayContainer.classList.remove('hidden');
                startEvolveCycle();
                evolveUpdateLoop = new Tone.Loop(time => {
                    const evolveValue = evolveSignal.value;

                    const tempoRange = {min: 60, max: 120};
                    const newTempo = tempoRange.min + (tempoRange.max - tempoRange.min) * evolveValue;
                    Tone.Transport.bpm.value = newTempo;
                    controls.tempo.slider.value = newTempo;
                    controls.tempo.display.textContent = Math.round(newTempo);
                    document.getElementById('evolve-tempo').textContent = Math.round(newTempo);
                    updateUIColor(newTempo);

                    const densityRange = {min: 0.1, max: 1.0};
                    const newDensity = densityRange.min + (densityRange.max - densityRange.min) * evolveValue;
                    controls.density.slider.value = newDensity;
                    controls.density.display.textContent = newDensity.toFixed(2);
                    document.getElementById('evolve-density').textContent = newDensity.toFixed(2);

                    const filterQRange = {min: 1, max: 20};
                    const newQ = filterQRange.max - (filterQRange.max - filterQRange.min) * evolveValue;
                    autoFilter.filter.Q.value = newQ;
                    controls.filterQ.slider.value = newQ;
                    controls.filterQ.display.textContent = newQ.toFixed(2);

                }, "4n").start(0);
            } else {
                evolveDisplayContainer.classList.add('hidden');
                Tone.Transport.cancel();
                if(evolveUpdateLoop) evolveUpdateLoop.stop(0).dispose();
                evolveSignal.cancelScheduledValues(Tone.now());
                evolveSignal.rampTo(0, 1);
                updateUIColor(controls.tempo.slider.value);
            }
        });

        controls.evolveUp.slider.addEventListener('input', (e) => {
            controls.evolveUp.display.textContent = e.target.value + 's';
        });
        controls.evolveDown.slider.addEventListener('input', (e) => {
            controls.evolveDown.display.textContent = e.target.value + 's';
        });
        controls.evolvePeak.slider.addEventListener('input', (e) => {
            controls.evolvePeak.display.textContent = e.target.value + 's';
        });

        function updateUIColor(tempo) {
            const tempoRange = { min: 60, max: 120 };
            const tempoPercentage = (tempo - tempoRange.min) / (tempoRange.max - tempoRange.min);
            const isVintage = document.body.classList.contains('theme-vintage');
            const hueStart = isVintage ? 28 : 244;
            const hueEnd = isVintage ? 45 : 28;
            const currentHue = hueStart + (hueEnd - hueStart) * tempoPercentage;
            document.body.style.setProperty('--base-hue', currentHue);
            const arrowColor = isVintage ? 'd97706' : 'a5b4fc';
            document.body.style.setProperty('--select-arrow-url', `url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23${arrowColor}' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e")`);
        }

        document.getElementById('theme-switcher').addEventListener('click', () => {
            document.body.classList.toggle('theme-vintage');
            document.getElementById('theme-icon-dark').classList.toggle('hidden');
            document.getElementById('theme-icon-light').classList.toggle('hidden');
            updateUIColor(Tone.Transport.bpm.value);
        });

        // --- Helper Functions ---
        const getRandomNote = (noteScale) => noteScale[Math.floor(Math.random() * noteScale.length)];
        const getChord = () => {
            if (currentScale.length < 5) return null;
            const rootIdx = Math.floor(Math.random() * (currentScale.length - 4));
            const chord = [currentScale[rootIdx], currentScale[rootIdx + 2], currentScale[rootIdx + 4]];
            const octaveUp = Tone.Frequency(currentScale[rootIdx]).transpose(12).toNote();
            if (currentScale.includes(octaveUp)) {
                chord.push(octaveUp);
            }
            return chord;
        };

        initialize();
    });
</script>
</body>
</html>
