<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web MIDI Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: linear-gradient(135deg, #1f2937 0%, #111827 100%); }
        .piano-wrapper { overflow-x: auto; background: #111; border-radius: 0 0 0.5rem 0.5rem; padding-bottom: 2px; }
        .piano-container { position: relative; display: flex; height: 50px; width: max-content; }
        .white-key { flex: 0 0 20px; height: 100%; background: #fff; border: 1px solid #ccc; border-radius: 0 0 3px 3px; position: relative; z-index: 1; margin-right: 1px; }
        .black-key { position: absolute; width: 12px; height: 60%; background: #222; border-radius: 0 0 3px 3px; z-index: 2; transform: translateX(-50%); box-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        .key-active-white { background: #60a5fa !important; }
        .key-active-black { background: #3b82f6 !important; }
        .custom-scrollbar::-webkit-scrollbar { height: 6px; width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1f2937; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        .arp-trigger { color: #ef4444; font-weight: 800; text-decoration: underline; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen text-gray-200 p-2 font-sans">

<div class="bg-gray-800 shadow-2xl rounded-xl w-full max-w-6xl p-3 border border-gray-700 flex flex-col gap-2">

    <!-- Header / Config -->
    <div class="flex flex-wrap items-end gap-3 border-b border-gray-700 pb-2">
        <div class="mr-auto text-nowrap">
            <h1 class="text-lg font-bold text-white tracking-tight leading-tight">üéπ Web MIDI Player</h1>
            <p class="text-gray-400 text-[9px] mt-0.5">High-performance direct hardware playback.</p>
        </div>

        <div class="w-40">
            <label class="block text-[9px] font-medium text-gray-400 mb-0.5 uppercase">1. Output Device</label>
            <select id="device-select" class="w-full bg-gray-900 border border-gray-600 rounded p-1 text-xs text-white focus:outline-none focus:border-blue-500">
                <option disabled>Initializing hardware...</option>
            </select>
        </div>

        <div class="w-48">
            <label class="block text-[9px] font-medium text-gray-400 mb-0.5 uppercase">2. Choose File</label>
            <input type="file" id="file-upload" accept=".mid,.midi" class="block w-full text-[9px] text-gray-400
                    file:mr-1 file:py-0.5 file:px-2 file:rounded file:border-0 file:text-[9px] file:font-semibold
                    file:bg-blue-600 file:text-white hover:file:bg-blue-500 border border-gray-600 rounded bg-gray-900 p-0.5 h-[24px]">
        </div>

        <div class="flex items-end gap-1">
            <div class="w-24">
                <label class="block text-[9px] font-medium text-gray-400 mb-0.5 uppercase">3. Master Route</label>
                <select id="master-select" class="w-full bg-gray-900 border border-gray-600 rounded p-1 text-[10px] text-white focus:outline-none">
                    <option value="original">Original</option>
                </select>
            </div>
            <button id="guess-mapping-btn" disabled class="bg-gray-700 hover:bg-gray-600 text-blue-300 border border-gray-600 rounded px-2 h-[26px] text-[9px] font-bold uppercase transition-colors">
                Guess Mapping
            </button>
        </div>

        <div class="w-20">
            <label class="block text-[9px] font-medium text-gray-400 mb-1 uppercase">Volume</label>
            <input type="range" id="volume-slider" min="0" max="1" step="0.05" value="1" class="w-full accent-blue-500 h-1.5 bg-gray-900 rounded-lg appearance-none cursor-pointer">
        </div>
    </div>

    <!-- Track Grid -->
    <div class="bg-gray-900/50 border border-gray-700 rounded p-1.5 min-h-[50px]">
        <div id="track-routing-list" class="grid gap-1 content-start relative transition-all duration-300">
            <div class="text-[10px] text-gray-600 italic text-center w-full absolute col-span-full mt-2">Load a MIDI file to route tracks</div>
        </div>
    </div>

    <!-- Transport Control -->
    <div class="flex items-center gap-2 bg-gray-900 rounded p-1.5 border border-gray-700">
        <button id="play-btn" disabled class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-1 px-3 rounded text-[11px] transition-colors w-16">Play</button>
        <button id="stop-btn" disabled class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-1 px-3 rounded text-[11px] transition-colors w-16">Stop</button>
        <button id="panic-btn" disabled title="Hard Reset (Works with Solina and gear)" class="bg-red-700 hover:bg-red-600 text-white font-bold py-1 px-2 rounded text-[11px] w-20">‚ö†Ô∏è Panic</button>

        <div class="flex-1 flex flex-col border-l border-gray-700 ml-1 pl-2 min-w-0">
            <div class="flex items-center justify-between">
                <span id="status-text" class="text-[10px] font-medium text-blue-400 truncate">Ready.</span>
                <div class="text-xs font-bold text-blue-300 tabular-nums" id="completion-percentage">0%</div>
            </div>
        </div>

        <div class="flex items-center gap-4 flex-shrink-0 border-l border-gray-800 ml-2 pl-3">
            <div class="min-w-[70px]"><span class="text-[8px] text-gray-500 block uppercase font-bold">Chord</span><span id="chord-display" class="text-sm font-bold text-yellow-400 tabular-nums">-</span></div>
            <div class="min-w-[90px]"><span class="text-[8px] text-gray-500 block uppercase font-bold">Scale</span><span id="scale-display" class="text-[10px] font-bold text-green-400 truncate">-</span></div>
        </div>
    </div>

    <div class="bg-black rounded border border-gray-700 overflow-hidden">
        <div class="piano-wrapper custom-scrollbar" id="piano-scroll">
            <div style="position: relative; width: max-content;">
                <canvas id="visualizer" height="40" class="block bg-gray-900 border-b border-gray-800"></canvas>
                <div id="keyboard" class="piano-container"></div>
            </div>
        </div>
    </div>

    <!-- Log Panels -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-0.5">
        <div id="warnings-container" class="p-1 bg-gray-900 border border-gray-700/50 rounded text-yellow-500 text-[9px] h-36 overflow-y-auto font-mono custom-scrollbar">
            <div class="flex items-center justify-between sticky top-0 bg-gray-900 border-b border-gray-800 pb-0.5 mb-1 z-10">
                <span class="text-gray-600 font-bold uppercase tracking-widest">System Logs:</span>
                <button id="copy-logs-btn" class="bg-gray-800 hover:bg-gray-700 text-gray-400 px-1.5 py-0.5 rounded border border-gray-700 uppercase font-bold text-[8px]">Copy</button>
            </div>
        </div>
        <div id="cc-monitor" class="p-1 bg-gray-950 border border-blue-900/30 rounded text-blue-400 text-[9px] h-36 overflow-y-auto font-mono custom-scrollbar">
            <div class="flex items-center justify-between sticky top-0 bg-gray-950 border-b border-blue-900/30 pb-0.5 mb-1 z-10">
                <span class="text-blue-700 font-bold uppercase tracking-widest">Live CC Monitor:</span>
                <button id="clear-monitor-btn" class="bg-gray-900 hover:bg-gray-800 text-blue-600 px-1.5 py-0.5 rounded border border-blue-900/30 uppercase font-bold text-[8px]">Clear</button>
            </div>
            <div id="cc-log-list"></div>
        </div>
    </div>
</div>

<script type="module">
    import MidiPlayer from 'https://cdn.skypack.dev/midi-player-js';

    const NOTE_NAMES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
    const GM_INSTRUMENTS = ["Grand Piano", "Bright Piano", "E-Grand Piano", "Honky-tonk Piano", "E-Piano 1", "E-Piano 2", "Harpsichord", "Clavinet", "Celesta", "Glockenspiel", "Music Box", "Vibraphone", "Marimba", "Xylophone", "Tubular Bells", "Dulcimer", "Drawbar Organ", "Percussive Organ", "Rock Organ", "Church Organ", "Reed Organ", "Accordion", "Harmonica", "Tango Accordion", "Nylon Guitar", "Steel Guitar", "Jazz Guitar", "Clean Guitar", "Muted Guitar", "Overdriven Guitar", "Distortion Guitar", "Harmonics", "Acoustic Bass", "Finger Bass", "Pick Bass", "Fretless Bass", "Slap Bass 1", "Slap Bass 2", "Synth Bass 1", "Synth Bass 2", "Violin", "Viola", "Cello", "Contrabass", "Tremolo Strings", "Pizzicato Strings", "Orchestral Harp", "Timpani", "String Ensemble 1", "String Ensemble 2", "SynthStrings 1", "SynthStrings 2", "Choir Aahs", "Voice Oohs", "Synth Voice", "Orchestra Hit", "Trumpet", "Trombone", "Tuba", "Muted Trumpet", "French Horn", "Brass Section", "SynthBrass 1", "SynthBrass 2", "Soprano Sax", "Alto Sax", "Tenor Sax", "Baritone Sax", "Oboe", "English Horn", "Bassoon", "Clarinet", "Piccolo", "Flute", "Recorder", "Pan Flute", "Blown Bottle", "Shakuhachi", "Whistle", "Ocarina", "Square Lead", "Sawtooth Lead", "Calliope Lead", "Chiff Lead", "Charang Lead", "Voice Lead", "Fifth Lead", "Bass+Lead", "New Age Pad", "Warm Pad", "Polysynth Pad", "Choir Pad", "Bowed Pad", "Metallic Pad", "Halo Pad", "Sweep Pad", "Rain SFX", "Soundtrack SFX", "Crystal SFX", "Atmosphere SFX", "Brightness SFX", "Goblins SFX", "Echoes SFX", "Sci-Fi SFX", "Sitar", "Banjo", "Shamisen", "Koto", "Kalimba", "Bagpipe", "Fiddle", "Shanai", "Tinkle Bell", "Agogo", "Steel Drums", "Woodblock", "Taiko Drum", "Melodic Tom", "Synth Drum", "Reverse Cymbal", "Guitar Fret Noise", "Breath Noise", "Seashore", "Bird Tweet", "Telephone Ring", "Helicopter", "Applause", "Gunshot"];

    const deviceSelect = document.getElementById('device-select');
    const fileUpload = document.getElementById('file-upload');
    const masterSelect = document.getElementById('master-select');
    const guessMappingBtn = document.getElementById('guess-mapping-btn');
    const trackRoutingList = document.getElementById('track-routing-list');
    const playBtn = document.getElementById('play-btn');
    const stopBtn = document.getElementById('stop-btn');
    const panicBtn = document.getElementById('panic-btn');
    const statusText = document.getElementById('status-text');
    const warningsContainer = document.getElementById('warnings-container');
    const ccLogList = document.getElementById('cc-log-list');
    const clearMonitorBtn = document.getElementById('clear-monitor-btn');
    const copyLogsBtn = document.getElementById('copy-logs-btn');
    const chordDisplay = document.getElementById('chord-display');
    const scaleDisplay = document.getElementById('scale-display');
    const completionPercentage = document.getElementById('completion-percentage');
    const keyboardContainer = document.getElementById('keyboard');
    const canvas = document.getElementById('visualizer');
    const ctx = canvas.getContext('2d');
    const volumeSlider = document.getElementById('volume-slider');

    let midiAccess = null, selectedOutput = null, audioContext = null, midiPlayer = null;
    let currentFileName = '', currentTrackRouting = {}, trackRows = {}, activeNotes = {}, playingHardwareNotes = new Set(), activeTracks = {}, keyElements = {}, isPanicking = false, autoPaused = false;

    let fileTotalTicks = 0; // Cached for high-performance percentage calculation
    const keyCache = {};
    const channelCCState = Array.from({length: 16}, () => ({ cc: new Int16Array(128).fill(-1), bend: -1 }));
    const noteReferenceCount = Array.from({length: 16}, () => new Uint8Array(128));

    function displayWarning(msg) {
        const logEntry = document.createElement('div');
        logEntry.className = 'py-0.5 border-b border-gray-800 last:border-0';
        logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        warningsContainer.appendChild(logEntry);
        if (warningsContainer.childElementCount > 51) warningsContainer.removeChild(warningsContainer.children[1]);
        warningsContainer.scrollTop = warningsContainer.scrollHeight;
    }

    function logCC(track, ch, msg, val) {
        const entry = document.createElement('div');
        entry.className = 'py-0.5 border-b border-blue-900/10 last:border-0';
        let extra = "";
        let isWarning = false;
        if (msg === "CC 112") { extra = " (PRO-800: ARP ON/OFF!)"; isWarning = true; }
        if (msg === "CC 113") { extra = " (PRO-800: ARP MODE!)"; isWarning = true; }
        if (msg === "CC 114") { extra = " (PRO-800: ARP RANGE!)"; isWarning = true; }
        entry.innerHTML = `<span class="text-blue-800">Trk ${track} Ch ${ch+1}</span>: <span class="${isWarning ? 'arp-trigger' : 'text-blue-200 font-bold'}">${msg}</span> Value: <span class="text-white">${val}</span>${extra}`;
        ccLogList.prepend(entry);
        if (ccLogList.childElementCount > 100) ccLogList.removeChild(ccLogList.lastChild);
    }

    clearMonitorBtn.addEventListener('click', () => ccLogList.innerHTML = '');

    function getNoteName(midiNumber) {
        const name = NOTE_NAMES[midiNumber % 12];
        const octave = Math.floor(midiNumber / 12) - 1;
        return name + octave;
    }

    function updateTrackGridLayout() {
        const numTracks = Object.keys(trackRows).length;
        if (numTracks === 0) return;
        let cols = window.innerWidth < 640 ? 2 : (window.innerWidth < 1024 ? 4 : 8);
        trackRoutingList.style.gridTemplateColumns = `repeat(${cols}, minmax(0, 1fr))`;
    }
    window.addEventListener('resize', updateTrackGridLayout);
    window.onerror = (msg, url, line, col) => { displayWarning(`SYSTEM ERROR: ${msg} | Line: ${line}`); return false; };

    copyLogsBtn.addEventListener('click', () => {
        const logs = Array.from(warningsContainer.children).slice(1).map(el => el.textContent).join('\n');
        const temp = document.createElement('textarea');
        temp.value = logs; document.body.appendChild(temp); temp.select();
        try { document.execCommand('copy'); copyLogsBtn.textContent = 'COPIED!'; setTimeout(() => copyLogsBtn.textContent = 'Copy', 2000); } catch(e) {}
        document.body.removeChild(temp);
    });

    masterSelect.addEventListener('change', () => {
        stopAllNotes();
        displayWarning(`Master Route updated to: ${masterSelect.value === 'original' ? 'Individual Channels' : 'Channel ' + masterSelect.value}`);
    });

    function updateTheoryDisplay() {
        const activeKeys = Object.keys(activeNotes).map(Number);
        if (!activeKeys.length) { chordDisplay.textContent = '-'; scaleDisplay.textContent = '-'; return; }
        const pitches = [...new Set(activeKeys.map(n => n % 12))].sort((a, b) => a - b);
        const ct = {'0,4,7': ' Maj', '0,3,7': ' Min', '0,3,6': ' Dim', '0,4,8': ' Aug', '0,2,7': ' Sus2', '0,5,7': ' Sus4', '0,4,7,11': ' Maj7', '0,3,7,10': ' Min7', '0,4,7,10': ' Dom7'};
        for (let r = 0; r < 12; r++) {
            const ints = pitches.map(p => (p - r + 12) % 12).sort((a, b) => a - b);
            if (ct[ints.join(',')]) { chordDisplay.textContent = NOTE_NAMES[r] + ct[ints.join(',')]; break; }
        }
    }

    function uiLoop() {
        if (midiPlayer) {
            // High-performance percentage calculation using cached total ticks
            if (fileTotalTicks > 0) {
                const currentTick = midiPlayer.tick || 0;
                const percent = Math.min(100, Math.floor((currentTick / fileTotalTicks) * 100));
                completionPercentage.textContent = `${percent}%`;
            }

            if (midiPlayer.isPlaying()) {
                updateTheoryDisplay();
            }
        }
        requestAnimationFrame(uiLoop);
    }

    function buildKeyboard() {
        const whiteNotes = [0, 2, 4, 5, 7, 9, 11];
        let wCount = 0;
        for (let n = 21; n <= 108; n++) {
            const isW = whiteNotes.includes(n % 12);
            const div = document.createElement('div');
            div.className = isW ? 'white-key' : 'black-key';
            if (!isW) div.style.left = `${wCount * 21}px`;
            else wCount++;
            keyboardContainer.appendChild(div);
            keyElements[n] = div;
            keyCache[n] = { left: isW ? div.offsetLeft : wCount * 21 - 7, width: isW ? 20 : 12, isBlack: !isW };
        }
        canvas.width = wCount * 21;
    }

    function drawVisualizer() {
        ctx.fillStyle = 'rgba(17, 24, 39, 0.3)'; ctx.fillRect(0, 0, canvas.width, canvas.height);
        for (const [note, data] of Object.entries(activeNotes)) {
            if (data.velocity > 0 && keyCache[note]) {
                const k = keyCache[note];
                const h = (data.velocity / 127) * (canvas.height - 10);
                ctx.fillStyle = 'rgba(96, 165, 250, 0.8)';
                ctx.fillRect(k.left, canvas.height - h, k.width, h);
                if (data.tracks?.size) {
                    ctx.fillStyle = '#fff'; ctx.font = 'bold 8px sans-serif'; ctx.textAlign = 'center';
                    ctx.fillText(Array.from(data.tracks).join(','), k.left + (k.width/2), canvas.height - h - 2);
                }
            }
        }
        requestAnimationFrame(drawVisualizer);
    }

    function initMIDI() {
        if (navigator.requestMIDIAccess) {
            navigator.requestMIDIAccess({ sysex: false }).then(a => {
                midiAccess = a; refreshOutputs(); midiAccess.onstatechange = refreshOutputs;
            }).catch(e => displayWarning(`MIDI Blocked: ${e.message}`));
        }
    }

    function refreshOutputs() {
        if (!midiAccess) return;
        const outs = Array.from(midiAccess.outputs.values());
        deviceSelect.innerHTML = outs.length ? '' : '<option disabled>No hardware detected</option>';
        outs.forEach(o => { const opt = document.createElement('option'); opt.value = o.id; opt.textContent = o.name; deviceSelect.appendChild(opt); });
        selectedOutput = outs.find(o => o.id === deviceSelect.value) || outs[0] || null;
        if (selectedOutput) statusText.textContent = `Hardware Ready: ${selectedOutput.name}`;
        panicBtn.disabled = !outs.length;
    }

    function stopAllNotes() {
        if (!selectedOutput) return;
        selectedOutput.send([0xFC]); // MIDI System Stop
        for (let ch = 0; ch < 16; ch++) {
            selectedOutput.send([0xB0 + ch, 120, 0]); // All Sound Off
            selectedOutput.send([0xB0 + ch, 123, 0]); // All Notes Off
            selectedOutput.send([0xB0 + ch, 121, 0]); // Reset All Controllers
            selectedOutput.send([0xB0 + ch, 64, 0]);  // Sustain Off
            selectedOutput.send([0xE0 + ch, 0, 64]);  // Bend Reset
            // Brute force note-off for vintage gear like the Solina
            for (let n = 0; n < 128; n++) selectedOutput.send([0x80 + ch, n, 0]);
            noteReferenceCount[ch].fill(0);
            channelCCState[ch].cc.fill(-1);
            channelCCState[ch].bend = -1;
        }
        activeNotes = {};
        activeTracks = {};
        Object.values(trackRows).forEach(row => {
            row.style.borderColor = 'transparent';
            row.style.backgroundColor = '';
        });
        document.querySelectorAll('.key-active-white, .key-active-black').forEach(el => el.classList.remove('key-active-white', 'key-active-black'));
    }

    function sanitize(v) { return Math.max(0, Math.min(127, Math.floor(Number(v) || 0))); }

    midiPlayer = new MidiPlayer.Player(function(ev) {
        if (!selectedOutput || isPanicking) return;
        try {
            const trk = ev.track;
            const route = currentTrackRouting[trk] || 'master';
            if (route === 'mute') return;

            let targetCh;
            if (route === 'master') {
                targetCh = (masterSelect.value === 'original') ? (ev.channel - 1 || 0) : (parseInt(masterSelect.value) - 1);
            } else if (route === 'original') {
                targetCh = (ev.channel - 1 || 0);
            } else {
                targetCh = parseInt(route) - 1;
            }

            const ch = Math.max(0, Math.min(15, targetCh));

            if (ev.name === 'Note on' || ev.name === 'Note off') {
                const isOff = ev.name === 'Note off' || ev.velocity === 0;
                const d1 = sanitize(ev.noteNumber), d2 = sanitize((ev.velocity || 0) * parseFloat(volumeSlider.value));

                if (!activeTracks[trk]) activeTracks[trk] = new Set();

                if (!isOff && d2 > 0) {
                    if (noteReferenceCount[ch][d1] === 0) selectedOutput.send([0x90 + ch, d1, d2]);
                    noteReferenceCount[ch][d1]++;
                    activeNotes[d1] = { velocity: d2, tracks: (activeNotes[d1]?.tracks || new Set()).add(trk) };
                    activeTracks[trk].add(d1);
                    if (keyElements[d1]) keyElements[d1].classList.add(keyCache[d1].isBlack ? 'key-active-black' : 'key-active-white');
                } else {
                    if (noteReferenceCount[ch][d1] > 0) noteReferenceCount[ch][d1]--;
                    if (noteReferenceCount[ch][d1] === 0) selectedOutput.send([0x80 + ch, d1, 0]);
                    activeTracks[trk].delete(d1);
                    if (activeNotes[d1]) { activeNotes[d1].tracks.delete(trk); if (!activeNotes[d1].tracks.size) { delete activeNotes[d1]; if (keyElements[d1]) keyElements[d1].classList.remove('key-active-white', 'key-active-black'); } }
                }

                const row = trackRows[trk];
                if (row) {
                    const notes = activeTracks[trk];
                    if (notes && notes.size > 0) {
                        const lastNote = Array.from(notes).pop();
                        const hue = (lastNote % 12) * 30;
                        row.style.borderColor = `hsl(${hue}, 80%, 55%)`;
                        row.style.backgroundColor = `hsla(${hue}, 80%, 40%, 0.3)`;
                    } else {
                        row.style.borderColor = 'transparent';
                        row.style.backgroundColor = '';
                    }
                }

            } else if (ev.name === 'Controller Change') {
                const val = sanitize(ev.value);
                if (channelCCState[ch].cc[ev.number] !== val) {
                    channelCCState[ch].cc[ev.number] = val;
                    selectedOutput.send([0xB0 + ch, sanitize(ev.number), val]);
                    logCC(trk, ch, `CC ${ev.number}`, val);
                }
            } else if (ev.name === 'Pitch Bend') {
                if (channelCCState[ch].bend !== ev.value) {
                    channelCCState[ch].bend = ev.value;
                    selectedOutput.send([0xE0 + ch, ev.value & 0x7F, (ev.value >> 7) & 0x7F]);
                    logCC(trk, ch, `Bend`, ev.value);
                }
            } else if (ev.name === 'Program Change') {
                selectedOutput.send([0xC0 + ch, sanitize(ev.value)]);
                logCC(trk, ch, `Program`, ev.value);
            }
        } catch (e) { displayWarning(`MIDI Trace Error: ${e.message}`); }
    });

    midiPlayer.on('start', () => { playBtn.textContent = "Pause"; statusText.textContent = "Playing..."; });
    midiPlayer.on('pause', () => { playBtn.textContent = "Play"; statusText.textContent = "Paused."; });
    midiPlayer.on('stop', () => { playBtn.textContent = "Play"; statusText.textContent = "Stopped."; });
    midiPlayer.on('end', () => { playBtn.textContent = "Play"; stopAllNotes(); statusText.textContent = "Finished."; completionPercentage.textContent = "100%"; });

    for(let i = 1; i <= 16; i++) {
        const opt = document.createElement('option');
        opt.value = i; opt.textContent = `Ch ${i}`;
        masterSelect.appendChild(opt);
    }

    fileUpload.addEventListener('change', e => {
        const file = e.target.files[0]; if (!file) return;
        midiPlayer.stop(); stopAllNotes();
        const reader = new FileReader();
        reader.onload = evt => {
            midiPlayer.loadArrayBuffer(evt.target.result);

            // Cache total ticks once for percentage calculations
            fileTotalTicks = midiPlayer.getTotalTicks() || 0;
            displayWarning(`Loaded MIDI: ${fileTotalTicks} total ticks.`);

            currentTrackRouting = {}; trackRows = {}; trackRoutingList.innerHTML = '';
            midiPlayer.events.forEach((events, idx) => {
                const trackNum = idx + 1;
                let firstCh = -1, name = "", inst = "", notes = 0, ccs = 0, minN = 127, maxN = 0, sumPitch = 0;
                events.forEach(ev => {
                    if (firstCh === -1 && ev.channel) firstCh = ev.channel;
                    if (ev.name === 'Track Name') name = ev.string;
                    if (ev.name === 'Instrument Name') inst = ev.string;
                    if (!inst && ev.name === 'Program Change') inst = GM_INSTRUMENTS[ev.value];
                    if (ev.name === 'Note on' && ev.velocity > 0) {
                        notes++; sumPitch += ev.noteNumber; minN = Math.min(minN, ev.noteNumber); maxN = Math.max(maxN, ev.noteNumber);
                    }
                    if (ev.name === 'Controller Change') ccs++;
                });
                if (firstCh === -1 && !notes && !ccs) return;

                let saved = {}; try { saved = JSON.parse(localStorage.getItem(`midi_routing_${file.name}`)) || {}; } catch(e){}
                const val = saved[trackNum] || 'master';
                currentTrackRouting[trackNum] = val;

                const row = document.createElement('div');
                row.className = 'flex items-center justify-between bg-gray-800 p-1 rounded border border-transparent h-[48px] overflow-hidden transition-all duration-75';
                row.innerHTML = `<div class="flex flex-col overflow-hidden mr-1 flex-1 leading-[1.1]"><span class="text-[9px] font-semibold text-gray-200 truncate" title="${name || `Track ${trackNum}`}">${name || `Track ${trackNum}`}</span>${inst ? `<span class="text-[8px] text-blue-300/80 truncate italic">${inst}</span>` : ''}<span class="text-[7px] text-gray-500 uppercase">Ch ${firstCh} ‚Ä¢ ${notes} notes</span><span class="text-[7px] text-gray-400 mt-0.5">Range: ${getNoteName(minN)}-${getNoteName(maxN)}</span></div><select class="bg-gray-900 border border-gray-600 rounded py-0 px-0.5 text-[9px] text-white w-[52px] h-[18px] focus:outline-none"><option value="master">Master</option><option value="original">Orig</option>${Array.from({length:16}, (_,i)=>`<option value="${i+1}">Ch ${i+1}</option>`).join('')}<option value="mute">Mute</option></select>`;
                const sel = row.querySelector('select'); sel.value = val;
                sel.addEventListener('change', ev => { currentTrackRouting[trackNum] = ev.target.value; stopAllNotes(); localStorage.setItem(`midi_routing_${file.name}`, JSON.stringify(currentTrackRouting)); });
                trackRows[trackNum] = row; trackRoutingList.appendChild(row);
            });
            updateTrackGridLayout(); playBtn.disabled = stopBtn.disabled = guessMappingBtn.disabled = false;
            completionPercentage.textContent = "0%";
        };
        reader.readAsArrayBuffer(file);
    });

    guessMappingBtn.addEventListener('click', () => {
        displayWarning("Guessing mapping...");
        Object.keys(trackRows).forEach(tKey => {
            const trackNum = parseInt(tKey);
            let text = "", minN = 127, maxN = 0, sumP = 0, notes = 0;
            midiPlayer.events[trackNum-1].forEach(ev => {
                if(ev.name==='Track Name'||ev.name==='Instrument Name') text+=ev.string.toLowerCase();
                if (ev.name === 'Note on' && ev.velocity > 0) { notes++; sumP += ev.noteNumber; minN = Math.min(minN, ev.noteNumber); maxN = Math.max(maxN, ev.noteNumber); }
            });
            let guess = null;
            if (/drum|perc|rhythm/.test(text)) guess = '10';
            else if (/bass|low/.test(text)) guess = '2';
            else if (/piano|key/.test(text)) guess = '1';
            else if (/lead|solo/.test(text)) guess = '5';
            if (!guess && notes > 0) { const avg = sumP / notes; if (avg < 45 || maxN < 50) guess = '2'; else if (avg > 78 || minN > 72) guess = '5'; }
            if (guess) { trackRows[tKey].querySelector('select').value = guess; currentTrackRouting[trackNum] = guess; }
        });
        localStorage.setItem(`midi_routing_${currentFileName}`, JSON.stringify(currentTrackRouting));
    });

    playBtn.addEventListener('click', async () => {
        if (!selectedOutput) { displayWarning("ERROR: No output device selected."); return; }
        if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
        if (audioContext.state === 'suspended') await audioContext.resume();
        midiPlayer.isPlaying() ? midiPlayer.pause() : midiPlayer.play();
    });

    stopBtn.addEventListener('click', () => { midiPlayer.stop(); stopAllNotes(); completionPercentage.textContent = "0%"; });
    panicBtn.addEventListener('click', () => { isPanicking = true; if (midiPlayer) midiPlayer.stop(); stopAllNotes(); displayWarning("üö® Panic reset sent."); setTimeout(()=>isPanicking=false, 1000); });

    window.addEventListener('blur', () => { if (midiPlayer?.isPlaying()) { midiPlayer.pause(); stopAllNotes(); autoPaused = true; } });
    window.addEventListener('focus', async () => { if (autoPaused) { autoPaused = false; if (audioContext?.state === 'suspended') await audioContext.resume(); midiPlayer.play(); } });

    initMIDI(); buildKeyboard(); uiLoop(); drawVisualizer();
</script>
</body>
</html>