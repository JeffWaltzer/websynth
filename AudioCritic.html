<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AudioCritic.ai</title>

    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Lucide Icons (Standalone) -->
    <script src="https://unpkg.com/lucide@0.263.1"></script>

    <!-- LameJS for MP3 Compression -->
    <script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.1/lame.min.js"></script>

    <style>
        /* Custom scrollbar for a sleeker look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 antialiased selection:bg-purple-500 selection:text-white">
<div id="root"></div>

<script type="text/babel">
    const { useState, useRef, useEffect } = React;

    // --- Icon System Setup ---
    // Helper to render Lucide icons from the global window.lucide object
    const LucideIcon = ({ name, size = 24, className = "" }) => {
        const [svgHtml, setSvgHtml] = useState("");

        useEffect(() => {
            if (window.lucide && window.lucide.icons && window.lucide.icons[name]) {
                const icon = window.lucide.icons[name];
                // Create SVG string
                const svg = icon.toSvg({
                    width: size,
                    height: size,
                    class: className,
                    color: "currentColor"
                });
                setSvgHtml(svg);
            }
        }, [name, size, className]);

        return <span dangerouslySetInnerHTML={{ __html: svgHtml }} className={`inline-flex items-center justify-center ${className}`} />;
    };

    // Map the imports used in the original file to our helper
    const Upload = (p) => <LucideIcon name="Upload" {...p} />;
    const Music = (p) => <LucideIcon name="Music" {...p} />;
    const Play = (p) => <LucideIcon name="Play" {...p} />;
    const Pause = (p) => <LucideIcon name="Pause" {...p} />;
    const FileAudio = (p) => <LucideIcon name="FileAudio" {...p} />;
    const AlertCircle = (p) => <LucideIcon name="AlertCircle" {...p} />;
    const CheckCircle2 = (p) => <LucideIcon name="CheckCircle2" {...p} />;
    const Loader2 = (p) => <LucideIcon name="Loader2" {...p} />;
    const Sparkles = (p) => <LucideIcon name="Sparkles" {...p} />;
    const X = (p) => <LucideIcon name="X" {...p} />;
    const Minimize2 = (p) => <LucideIcon name="Minimize2" {...p} />;
    const Wand2 = (p) => <LucideIcon name="Wand2" {...p} />;
    const Download = (p) => <LucideIcon name="Download" {...p} />;
    const Mic2 = (p) => <LucideIcon name="Mic2" {...p} />;
    const Ear = (p) => <LucideIcon name="Ear" {...p} />;
    const Volume2 = (p) => <LucideIcon name="Volume2" {...p} />;
    const RefreshCw = (p) => <LucideIcon name="RefreshCw" {...p} />;
    const Settings = (p) => <LucideIcon name="Settings" {...p} />;
    const Key = (p) => <LucideIcon name="Key" {...p} />;

    // --- Main Application Component ---
    const AudioCriticApp = () => {
        const [file, setFile] = useState(null);
        const [audioUrl, setAudioUrl] = useState(null);

        // Configuration State
        const [apiKey, setApiKey] = useState(localStorage.getItem('gemini_api_key') || '');
        const [showSettings, setShowSettings] = useState(!localStorage.getItem('gemini_api_key'));

        // Analysis State
        const [analysis, setAnalysis] = useState('');
        const [fixParams, setFixParams] = useState(null);

        // Re-Analysis State
        const [fixedAudioBlob, setFixedAudioBlob] = useState(null);
        const [reAnalysis, setReAnalysis] = useState('');
        const [reAnalyzing, setReAnalyzing] = useState(false);

        // Chord Narrator State
        const [enableChordVoice, setEnableChordVoice] = useState(false);
        const [chords, setChords] = useState([]);
        const [lastSpokenTime, setLastSpokenTime] = useState(-1);

        // Processing State
        const [loading, setLoading] = useState(false);
        const [processingFix, setProcessingFix] = useState(false);
        const [statusMessage, setStatusMessage] = useState('');
        const [error, setError] = useState('');
        const [dragActive, setDragActive] = useState(false);

        // Fixed Audio State
        const [fixedAudioUrl, setFixedAudioUrl] = useState(null);

        const audioRef = useRef(null);

        // Constants
        const MAX_FILE_SIZE_MB = 50;
        const COMPRESSION_THRESHOLD_MB = 2;
        const SUPPORTED_TYPES = ['audio/mpeg', 'audio/wav', 'audio/mp3', 'audio/x-m4a', 'audio/aac', 'audio/ogg', 'audio/flac'];

        // Note: lamejs is loaded in <head>, so we don't need the useEffect loader here.

        useEffect(() => {
            localStorage.setItem('gemini_api_key', apiKey);
        }, [apiKey]);

        const handleDrag = (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (e.type === "dragenter" || e.type === "dragover") {
                setDragActive(true);
            } else if (e.type === "dragleave") {
                setDragActive(false);
            }
        };

        const validateAndSetFile = (selectedFile) => {
            setError('');
            setAnalysis('');
            setFixParams(null);
            setFixedAudioUrl(null);
            setFixedAudioBlob(null);
            setReAnalysis('');
            setChords([]);

            if (!selectedFile) return;

            if (!SUPPORTED_TYPES.includes(selectedFile.type) && !selectedFile.type.startsWith('audio/')) {
                setError('Please upload a valid audio file (MP3, WAV, AAC, etc).');
                return;
            }

            if (selectedFile.size > MAX_FILE_SIZE_MB * 1024 * 1024) {
                setError(`File is too large. Please upload a file smaller than ${MAX_FILE_SIZE_MB}MB.`);
                return;
            }

            setFile(selectedFile);
            const url = URL.createObjectURL(selectedFile);
            setAudioUrl(url);
        };

        const handleDrop = (e) => {
            e.preventDefault();
            e.stopPropagation();
            setDragActive(false);
            if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                validateAndSetFile(e.dataTransfer.files[0]);
            }
        };

        const handleChange = (e) => {
            e.preventDefault();
            if (e.target.files && e.target.files[0]) {
                validateAndSetFile(e.target.files[0]);
            }
        };

        const clearFile = () => {
            setFile(null);
            if (audioUrl) URL.revokeObjectURL(audioUrl);
            setAudioUrl(null);
            if (fixedAudioUrl) URL.revokeObjectURL(fixedAudioUrl);
            setFixedAudioUrl(null);
            setFixedAudioBlob(null);
            setAnalysis('');
            setReAnalysis('');
            setFixParams(null);
            setChords([]);
            setError('');
            setStatusMessage('');
        };

        // --- Audio Utilities ---

        const floatTo16BitPCM = (input) => {
            const output = new Int16Array(input.length);
            for (let i = 0; i < input.length; i++) {
                const s = Math.max(-1, Math.min(1, input[i]));
                output[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
            }
            return output;
        };

        const bufferToWave = (abuffer, len) => {
            let numOfChan = abuffer.numberOfChannels,
                length = len * numOfChan * 2 + 44,
                buffer = new ArrayBuffer(length),
                view = new DataView(buffer),
                channels = [], i, sample,
                offset = 0,
                pos = 0;

            const setUint16 = (data) => { view.setUint16(pos, data, true); pos += 2; }
            const setUint32 = (data) => { view.setUint32(pos, data, true); pos += 4; }

            setUint32(0x46464952);                         // "RIFF"
            setUint32(length - 8);                         // file length - 8
            setUint32(0x45564157);                         // "WAVE"
            setUint32(0x20746d66);                         // "fmt " chunk
            setUint32(16);                                 // length = 16
            setUint16(1);                                  // PCM (uncompressed)
            setUint16(numOfChan);
            setUint32(abuffer.sampleRate);
            setUint32(abuffer.sampleRate * 2 * numOfChan); // avg. bytes/sec
            setUint16(numOfChan * 2);                      // block-align
            setUint16(16);                                 // 16-bit
            setUint32(0x61746164);                         // "data" - chunk
            setUint32(length - pos - 4);                   // chunk length

            for(i = 0; i < abuffer.numberOfChannels; i++)
                channels.push(abuffer.getChannelData(i));

            while(pos < len) {
                for(i = 0; i < numOfChan; i++) {
                    sample = Math.max(-1, Math.min(1, channels[i][pos]));
                    sample = (0.5 + sample < 0 ? sample * 32768 : sample * 32767)|0;
                    view.setInt16(44 + offset, sample, true);
                    offset += 2;
                }
                pos++;
            }
            return new Blob([buffer], {type: "audio/wav"});
        };

        const compressAudio = async (originalFile) => {
            if (!window.lamejs) throw new Error("Compression library not loaded.");
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const arrayBuffer = await originalFile.arrayBuffer();
            const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

            const channels = 1;
            const sampleRate = audioBuffer.sampleRate;
            const kbps = 128;
            const mp3encoder = new window.lamejs.Mp3Encoder(channels, sampleRate, kbps);

            let samples = audioBuffer.getChannelData(0);
            if (audioBuffer.numberOfChannels > 1) {
                const right = audioBuffer.getChannelData(1);
                const mono = new Float32Array(samples.length);
                for (let i = 0; i < samples.length; i++) {
                    mono[i] = (samples[i] + right[i]) / 2;
                }
                samples = mono;
            }

            const sampleBlockSize = 1152;
            const mp3Data = [];
            const int16Samples = floatTo16BitPCM(samples);

            for (let i = 0; i < int16Samples.length; i += sampleBlockSize) {
                const sampleChunk = int16Samples.subarray(i, i + sampleBlockSize);
                const mp3buf = mp3encoder.encodeBuffer(sampleChunk);
                if (mp3buf.length > 0) mp3Data.push(mp3buf);
            }

            const mp3buf = mp3encoder.flush();
            if (mp3buf.length > 0) mp3Data.push(mp3buf);

            const blob = new Blob(mp3Data, { type: 'audio/mp3' });
            return new File([blob], "compressed.mp3", { type: "audio/mp3" });
        };

        const fileToGenerativePart = async (file) => {
            const base64EncodedDataPromise = new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(file);
            });
            return {
                inlineData: { data: await base64EncodedDataPromise, mimeType: file.type },
            };
        };

        // --- FX Generators ---
        const createReverbImpulse = (ctx, duration = 2.0, decay = 2.0) => {
            const rate = ctx.sampleRate;
            const length = rate * duration;
            const impulse = ctx.createBuffer(2, length, rate);
            const left = impulse.getChannelData(0);
            const right = impulse.getChannelData(1);
            for (let i = 0; i < length; i++) {
                const n = i / length;
                left[i] = (Math.random() * 2 - 1) * Math.pow(1 - n, decay);
                right[i] = (Math.random() * 2 - 1) * Math.pow(1 - n, decay);
            }
            return impulse;
        };

        // --- Processing Logic ---

        const analyzeAudio = async () => {
            if (!file) return;
            if (!apiKey) {
                setShowSettings(true);
                setError("Please enter your Gemini API Key in settings to continue.");
                return;
            }

            setLoading(true);
            setError('');
            setAnalysis('');
            setFixParams(null);
            setFixedAudioUrl(null);
            setFixedAudioBlob(null);
            setReAnalysis('');
            setChords([]);
            setStatusMessage('Preparing file...');

            try {
                let fileToUpload = file;
                const needsCompression = file.size > COMPRESSION_THRESHOLD_MB * 1024 * 1024 || file.type === 'audio/wav';

                if (needsCompression) {
                    try {
                        fileToUpload = await compressAudio(file);
                        setStatusMessage('Compression complete. Uploading...');
                    } catch (compError) {
                        console.warn("Compression failed", compError);
                        setStatusMessage('Compression failed. Trying original...');
                    }
                }

                const audioPart = await fileToGenerativePart(fileToUpload);

                setStatusMessage('Consulting Gemini AI...');

                const prompt = `
                        Please listen to this audio file carefully.
                        1. Describe the audio (genre, instruments, mood, tempo).
                        2. Provide a critical review of the production quality, composition, and emotional impact. Be constructive.

                        CRITICAL: At the very end of your response, strictly output a JSON block inside \`\`\`json\`\`\` tags.
                        Analyze if the vocals or instrumentals are off-key or need effects.

                        The JSON must follow this exact schema:
                        {
                            "gain_db": number (suggested output gain adjustment in dB, e.g. 2 or -3),
                            "low_shelf_gain_db": number (bass boost/cut in dB, e.g. 3 or -2),
                            "mid_peaking_gain_db": number (mid frequency adjustments in dB),
                            "mid_frequency_hz": number (frequency for the mid adjustment, e.g. 1000),
                            "high_shelf_gain_db": number (treble boost/cut in dB),
                            "compressor_threshold_db": number (e.g. -24),
                            "compressor_ratio": number (e.g. 4 for moderate compression),
                            "pitch_correction_semitones": number (suggested global pitch shift in semitones, e.g. -1, 0, or 0.5. Use 0 if fine),
                            "vocal_processing_mode": string (one of: "clean", "studio_pop", "ethereal", "robot"),
                            "chords": [ { "seconds": number, "label": string } ]
                        }

                        For "chords", detect the chord progression. Provide a list of timestamps (in seconds) and the chord name (e.g. "C Major", "A Minor 7") occurring at that time. If no clear chords, return empty list.

                        Use "studio_pop" if the track sounds like a demo that needs thickening/chorus.
                        Use "ethereal" if it needs space/reverb.
                        Use "robot" ONLY if it sounds electronic/sci-fi or if the user specifically asked for autotune-like effects in a bad way.
                        Otherwise use "clean".
                    `;

                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }, audioPart] }]
                };

                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    }
                );

                if (!response.ok) throw new Error(`API Error: ${response.status}`);

                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    const jsonMatch = text.match(/```json\n([\s\S]*?)\n```/);
                    if (jsonMatch && jsonMatch[1]) {
                        try {
                            const extractedParams = JSON.parse(jsonMatch[1]);
                            setFixParams(extractedParams);
                            if (extractedParams.chords) {
                                setChords(extractedParams.chords);
                            }
                            setAnalysis(text.replace(/```json[\s\S]*?```/, ''));
                        } catch (e) {
                            console.error("Failed to parse fix params", e);
                            setAnalysis(text);
                        }
                    } else {
                        setAnalysis(text);
                    }
                } else {
                    throw new Error("No analysis received.");
                }

            } catch (err) {
                console.error(err);
                setError(err.message || "Failed to analyze audio.");
            } finally {
                setLoading(false);
                setStatusMessage('');
            }
        };

        const reanalyzeAudio = async () => {
            if (!fixedAudioBlob) return;
            if (!apiKey) {
                setShowSettings(true);
                return;
            }
            setReAnalyzing(true);
            setReAnalysis('');
            setError('');

            try {
                let fileToUpload = new File([fixedAudioBlob], "remastered.wav", { type: "audio/wav" });

                const needsCompression = fileToUpload.size > COMPRESSION_THRESHOLD_MB * 1024 * 1024;

                if (needsCompression) {
                    try {
                        fileToUpload = await compressAudio(fileToUpload);
                    } catch (compError) {
                        console.warn("Re-analysis compression failed", compError);
                    }
                }

                const audioPart = await fileToGenerativePart(fileToUpload);

                const prevContext = analysis.length > 500 ? analysis.substring(0, 500) + "..." : analysis;

                const prompt = `
                        I have applied your suggested fixes (EQ, Compression, FX) to the previous audio file.
                        Here is the REMASTERED version.

                        The previous analysis stated issues such as: "${prevContext}"

                        Please listen to this new version and provide a follow-up critique:
                        1. Has the production quality improved?
                        2. Are the specific issues mentioned earlier (volume, balance, pitch) resolved?
                        3. Is the vocal processing appropriate?
                        4. Give it a final rating out of 10.

                        Be concise and direct.
                    `;

                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }, audioPart] }]
                };

                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    }
                );

                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    setReAnalysis(text);
                } else {
                    throw new Error("No re-analysis received.");
                }

            } catch (err) {
                console.error(err);
                setError("Re-analysis failed: " + err.message);
            } finally {
                setReAnalyzing(false);
            }
        };

        const applyAiFixes = async () => {
            if (!file || !fixParams) return;
            setProcessingFix(true);
            setError('');
            setReAnalysis('');
            setFixedAudioBlob(null);

            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const arrayBuffer = await file.arrayBuffer();
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

                const offlineCtx = new OfflineAudioContext(
                    audioBuffer.numberOfChannels,
                    audioBuffer.length,
                    audioBuffer.sampleRate
                );

                const source = offlineCtx.createBufferSource();
                source.buffer = audioBuffer;

                const semitones = fixParams.pitch_correction_semitones || 0;
                if (semitones !== 0) {
                    source.playbackRate.value = Math.pow(2, semitones / 12);
                }

                const lowShelf = offlineCtx.createBiquadFilter();
                lowShelf.type = "lowshelf";
                lowShelf.frequency.value = 250;
                lowShelf.gain.value = fixParams.low_shelf_gain_db || 0;

                const midPeak = offlineCtx.createBiquadFilter();
                midPeak.type = "peaking";
                midPeak.frequency.value = fixParams.mid_frequency_hz || 1000;
                midPeak.Q.value = 1.0;
                midPeak.gain.value = fixParams.mid_peaking_gain_db || 0;

                const highShelf = offlineCtx.createBiquadFilter();
                highShelf.type = "highshelf";
                highShelf.frequency.value = 4000;
                highShelf.gain.value = fixParams.high_shelf_gain_db || 0;

                const compressor = offlineCtx.createDynamicsCompressor();
                compressor.threshold.value = fixParams.compressor_threshold_db || -24;
                compressor.knee.value = 30;
                compressor.ratio.value = fixParams.compressor_ratio || 12;
                compressor.attack.value = 0.003;
                compressor.release.value = 0.25;

                const gainNode = offlineCtx.createGain();
                const dbGain = fixParams.gain_db || 0;
                gainNode.gain.value = Math.pow(10, dbGain / 20);

                source.connect(lowShelf);
                lowShelf.connect(midPeak);
                midPeak.connect(highShelf);
                highShelf.connect(compressor);

                let finalDest = gainNode;
                const mode = fixParams.vocal_processing_mode || "clean";

                if (mode === "studio_pop") {
                    const delay = offlineCtx.createDelay();
                    delay.delayTime.value = 0.03;

                    const feedback = offlineCtx.createGain();
                    feedback.gain.value = 0.3;

                    const chorusGain = offlineCtx.createGain();
                    chorusGain.gain.value = 0.4;

                    compressor.connect(delay);
                    delay.connect(feedback);
                    feedback.connect(delay);
                    delay.connect(chorusGain);

                    compressor.connect(gainNode);
                    chorusGain.connect(gainNode);

                } else if (mode === "ethereal") {
                    const convolver = offlineCtx.createConvolver();
                    convolver.buffer = createReverbImpulse(offlineCtx, 3.0, 3.0);

                    const reverbGain = offlineCtx.createGain();
                    reverbGain.gain.value = 0.6;

                    compressor.connect(convolver);
                    convolver.connect(reverbGain);
                    reverbGain.connect(gainNode);
                    compressor.connect(gainNode);

                } else if (mode === "robot") {
                    const osc = offlineCtx.createOscillator();
                    osc.type = "sine";
                    osc.frequency.value = 50;
                    osc.start(0);

                    const modGain = offlineCtx.createGain();
                    modGain.gain.value = 0.0;

                    const flanger = offlineCtx.createDelay();
                    flanger.delayTime.value = 0.005;
                    const flangerFeedback = offlineCtx.createGain();
                    flangerFeedback.gain.value = 0.9;

                    compressor.connect(flanger);
                    flanger.connect(flangerFeedback);
                    flangerFeedback.connect(flanger);
                    flanger.connect(gainNode);

                } else {
                    compressor.connect(gainNode);
                }

                gainNode.connect(offlineCtx.destination);

                source.start(0);
                const renderedBuffer = await offlineCtx.startRendering();

                const wavBlob = bufferToWave(renderedBuffer, renderedBuffer.length);
                setFixedAudioBlob(wavBlob);

                const fixedUrl = URL.createObjectURL(wavBlob);
                setFixedAudioUrl(fixedUrl);

            } catch (err) {
                console.error(err);
                setError("Failed to apply audio fixes: " + err.message);
            } finally {
                setProcessingFix(false);
            }
        };

        const handleTimeUpdate = (e) => {
            if (!enableChordVoice || chords.length === 0) return;

            const currentTime = e.target.currentTime;
            const sortedChords = [...chords].sort((a, b) => a.seconds - b.seconds);
            const currentChordObj = sortedChords.reverse().find(c => c.seconds <= currentTime);

            if (currentChordObj) {
                if (currentChordObj.seconds > lastSpokenTime) {
                    const u = new SpeechSynthesisUtterance(currentChordObj.label);
                    u.rate = 1.1;
                    const voices = window.speechSynthesis.getVoices();
                    const preferredVoice = voices.find(v => v.name.includes("Google US English") || v.name.includes("Natural"));
                    if (preferredVoice) u.voice = preferredVoice;

                    window.speechSynthesis.cancel();
                    window.speechSynthesis.speak(u);
                    setLastSpokenTime(currentChordObj.seconds);
                }
            }
        };

        const handleSeek = (e) => {
            setLastSpokenTime(e.target.currentTime - 0.1);
            window.speechSynthesis.cancel();
        };

        return (
            <div className="min-h-screen">
                {/* Header */}
                <header className="border-b border-slate-800 bg-slate-900/50 backdrop-blur-md sticky top-0 z-10">
                    <div className="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
                        <div className="flex items-center gap-2">
                            <div className="bg-gradient-to-tr from-purple-500 to-indigo-500 p-2 rounded-lg">
                                <Music className="w-6 h-6 text-white" />
                            </div>
                            <h1 className="text-xl font-bold tracking-tight">AudioCritic<span className="text-purple-400">.ai</span></h1>
                        </div>
                        <div className="flex items-center gap-3">
                            <button
                                onClick={() => setShowSettings(!showSettings)}
                                className={`p-2 rounded-full transition-colors ${!apiKey ? 'animate-pulse bg-purple-500/20 text-purple-300' : 'text-slate-400 hover:text-white hover:bg-slate-800'}`}
                            >
                                <Settings className="w-5 h-5" />
                            </button>
                            <div className="hidden md:block text-xs font-medium text-slate-400 border border-slate-700 px-3 py-1 rounded-full">
                                Powered by Gemini 2.5 Flash
                            </div>
                        </div>
                    </div>
                </header>

                {/* API Key Modal */}
                {showSettings && (
                    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200">
                        <div className="bg-slate-900 border border-slate-700 rounded-2xl p-6 max-w-md w-full shadow-2xl space-y-4">
                            <div className="flex items-center justify-between">
                                <h3 className="text-lg font-bold text-white flex items-center gap-2">
                                    <Settings className="w-5 h-5 text-purple-400" />
                                    App Settings
                                </h3>
                                <button onClick={() => setShowSettings(false)} className="text-slate-400 hover:text-white">
                                    <X className="w-5 h-5" />
                                </button>
                            </div>

                            <div className="space-y-2">
                                <label className="text-sm font-medium text-slate-300">Gemini API Key</label>
                                <div className="relative">
                                    <div className="absolute inset-y-0 left-3 flex items-center pointer-events-none">
                                        <Key className="w-4 h-4 text-slate-500" />
                                    </div>
                                    <input
                                        type="password"
                                        value={apiKey}
                                        onChange={(e) => setApiKey(e.target.value)}
                                        placeholder="AIzaSy..."
                                        className="w-full bg-slate-800 border border-slate-700 rounded-lg py-2 pl-10 pr-4 text-white placeholder:text-slate-600 focus:outline-none focus:border-purple-500 transition-colors"
                                    />
                                </div>
                                <p className="text-xs text-slate-500">
                                    Required for analysis. Your key is stored locally in your browser and never sent to our servers.
                                    <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-purple-400 hover:underline ml-1">Get a key here</a>.
                                </p>
                            </div>

                            <button
                                onClick={() => setShowSettings(false)}
                                className="w-full bg-purple-600 hover:bg-purple-500 text-white font-medium py-2 rounded-lg transition-colors"
                            >
                                Save & Close
                            </button>
                        </div>
                    </div>
                )}

                <main className="max-w-6xl mx-auto px-6 py-12 space-y-12">

                    <div className="text-center space-y-4">
                        <h2 className="text-4xl md:text-5xl font-extrabold tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-white via-purple-200 to-indigo-200 pb-2">
                            Analyze. Review. <span className="text-purple-400">Remaster.</span>
                        </h2>
                        <p className="text-lg text-slate-400 max-w-2xl mx-auto">
                            Upload your audio. Our AI will critique the production and suggest professional mastering & vocal effects to instantly polish your track.
                        </p>
                    </div>

                    <div className="grid lg:grid-cols-2 gap-8 items-start">

                        {/* Left Column: Upload & Player */}
                        <div className="space-y-6">
                            {!file ? (
                                <div
                                    className={`
                                            relative border-2 border-dashed rounded-2xl p-10 text-center transition-all duration-300 ease-in-out
                                            flex flex-col items-center justify-center min-h-[300px] cursor-pointer group
                                            ${dragActive
                                        ? 'border-purple-400 bg-purple-500/10 scale-[1.02]'
                                        : 'border-slate-700 hover:border-slate-600 hover:bg-slate-800/50 bg-slate-800/20'
                                    }
                                        `}
                                    onDragEnter={handleDrag}
                                    onDragLeave={handleDrag}
                                    onDragOver={handleDrag}
                                    onDrop={handleDrop}
                                    onClick={() => document.getElementById('audio-upload').click()}
                                >
                                    <input
                                        id="audio-upload"
                                        type="file"
                                        accept="audio/*"
                                        className="hidden"
                                        onChange={handleChange}
                                    />

                                    <div className="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mb-6 shadow-xl group-hover:scale-110 transition-transform duration-300 border border-slate-700">
                                        <Upload className="w-8 h-8 text-purple-400" />
                                    </div>
                                    <h3 className="text-xl font-semibold mb-2 text-white">Upload Audio File</h3>
                                    <p className="text-slate-400 text-sm mb-6 max-w-xs mx-auto">
                                        Drag & drop or click to browse<br/>
                                        <span className="text-slate-500 text-xs mt-2 block">(MP3, WAV, FLAC supported)</span>
                                    </p>
                                </div>
                            ) : (
                                <div className="bg-slate-800/50 border border-slate-700 rounded-2xl p-6 relative overflow-hidden">
                                    <button
                                        onClick={clearFile}
                                        className="absolute top-4 right-4 p-2 text-slate-400 hover:text-white hover:bg-slate-700 rounded-full transition-colors"
                                    >
                                        <X className="w-5 h-5" />
                                    </button>

                                    <div className="flex items-center gap-4 mb-6">
                                        <div className="w-12 h-12 bg-purple-500/20 text-purple-400 rounded-lg flex items-center justify-center">
                                            <FileAudio className="w-6 h-6" />
                                        </div>
                                        <div>
                                            <h3 className="font-medium text-white truncate max-w-[200px]">{file.name}</h3>
                                            <p className="text-xs text-slate-400">{(file.size / (1024 * 1024)).toFixed(2)} MB</p>
                                        </div>
                                    </div>

                                    <div className="bg-slate-900/50 rounded-xl p-4 mb-6 relative">
                                        <p className="text-xs text-slate-400 mb-2 uppercase tracking-wider font-bold">Original Audio</p>
                                        <audio
                                            ref={audioRef}
                                            src={audioUrl}
                                            controls
                                            className="w-full h-10 [&::-webkit-media-controls-panel]:bg-slate-200"
                                            onTimeUpdate={handleTimeUpdate}
                                            onSeeked={handleSeek}
                                        />

                                        {chords.length > 0 && (
                                            <div className="mt-4 flex items-center justify-between bg-slate-800 p-3 rounded-lg border border-slate-700">
                                                <div className="flex items-center gap-2">
                                                    <Ear className="w-4 h-4 text-purple-400" />
                                                    <span className="text-sm font-medium text-slate-300">Chord Narrator</span>
                                                </div>
                                                <label className="relative inline-flex items-center cursor-pointer">
                                                    <input
                                                        type="checkbox"
                                                        checked={enableChordVoice}
                                                        onChange={(e) => setEnableChordVoice(e.target.checked)}
                                                        className="sr-only peer"
                                                    />
                                                    <div className="w-9 h-5 bg-slate-600 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-purple-500/50 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-purple-600"></div>
                                                    <span className="ml-2 text-xs text-slate-400">{enableChordVoice ? 'On' : 'Off'}</span>
                                                </label>
                                            </div>
                                        )}
                                    </div>

                                    {!analysis && (
                                        <button
                                            onClick={analyzeAudio}
                                            disabled={loading}
                                            className={`
                                                    w-full py-3 px-6 rounded-xl font-semibold flex items-center justify-center gap-2 transition-all shadow-lg
                                                    ${loading
                                                ? 'bg-slate-700 text-slate-400 cursor-not-allowed'
                                                : 'bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500 text-white hover:shadow-purple-500/25 hover:scale-[1.02] active:scale-[0.98]'
                                            }
                                                `}
                                        >
                                            {loading ? (
                                                <div className="flex items-center gap-2">
                                                    <Loader2 className="w-5 h-5 animate-spin" />
                                                    {statusMessage || 'Processing...'}
                                                </div>
                                            ) : (
                                                <div className="flex items-center gap-2">
                                                    <Sparkles className="w-5 h-5" />
                                                    Generate Review & Fixes
                                                </div>
                                            )}
                                        </button>
                                    )}

                                    {/* AI FIX SECTION */}
                                    {analysis && fixParams && (
                                        <div className="mt-8 border-t border-slate-700 pt-6 animate-in fade-in slide-in-from-bottom-2">
                                            <h4 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                                                <Wand2 className="w-5 h-5 text-purple-400" />
                                                AI Suggested Fixes
                                            </h4>

                                            <div className="grid grid-cols-2 md:grid-cols-4 gap-2 mb-6 text-xs text-slate-400 bg-slate-900/50 p-3 rounded-lg border border-slate-700/50">
                                                <div className="flex flex-col">
                                                    <span className="text-slate-500">Bass</span>
                                                    <span className={fixParams.low_shelf_gain_db > 0 ? "text-green-400" : "text-slate-300"}>{fixParams.low_shelf_gain_db > 0 ? '+' : ''}{fixParams.low_shelf_gain_db}dB</span>
                                                </div>
                                                <div className="flex flex-col">
                                                    <span className="text-slate-500">Gain</span>
                                                    <span className="text-white">{fixParams.gain_db > 0 ? '+' : ''}{fixParams.gain_db}dB</span>
                                                </div>
                                                <div className="flex flex-col">
                                                    <span className="text-slate-500">Tune</span>
                                                    <span className={fixParams.pitch_correction_semitones !== 0 ? "text-yellow-400" : "text-slate-300"}>{fixParams.pitch_correction_semitones > 0 ? '+' : ''}{fixParams.pitch_correction_semitones}st</span>
                                                </div>
                                                <div className="flex flex-col">
                                                    <span className="text-slate-500">Vocal FX</span>
                                                    <span className="text-purple-400 uppercase font-bold text-[10px] tracking-wide">{fixParams.vocal_processing_mode?.replace('_', ' ')}</span>
                                                </div>
                                            </div>

                                            {!fixedAudioUrl ? (
                                                <button
                                                    onClick={applyAiFixes}
                                                    disabled={processingFix}
                                                    className="w-full py-3 px-6 rounded-xl font-semibold flex items-center justify-center gap-2 transition-all bg-slate-800 hover:bg-slate-700 border border-slate-600 text-purple-300 hover:text-purple-200"
                                                >
                                                    {processingFix ? <Loader2 className="w-5 h-5 animate-spin" /> : <Mic2 className="w-5 h-5" />}
                                                    {processingFix ? "Applying Vocal Processing..." : "Apply Mastering & Vocal FX"}
                                                </button>
                                            ) : (
                                                <div className="space-y-4">
                                                    <div className="bg-purple-500/10 border border-purple-500/30 rounded-xl p-4 animate-in zoom-in-95">
                                                        <div className="flex items-center justify-between mb-2">
                                                            <p className="text-xs text-purple-300 uppercase tracking-wider font-bold flex items-center gap-2">
                                                                <Sparkles className="w-3 h-3" /> Remastered Audio
                                                            </p>
                                                            <div className="flex gap-2">
                                                                <button
                                                                    onClick={reanalyzeAudio}
                                                                    disabled={reAnalyzing}
                                                                    className="text-xs bg-slate-700 hover:bg-slate-600 text-white px-3 py-1 rounded-md flex items-center gap-1 transition-colors"
                                                                >
                                                                    {reAnalyzing ? <Loader2 className="w-3 h-3 animate-spin" /> : <RefreshCw className="w-3 h-3" />}
                                                                    Verify Improvement
                                                                </button>
                                                                <a
                                                                    href={fixedAudioUrl}
                                                                    download={`remastered_${file.name.replace(/\.[^/.]+$/, "")}.wav`}
                                                                    className="text-xs bg-purple-600 hover:bg-purple-500 text-white px-3 py-1 rounded-md flex items-center gap-1 transition-colors"
                                                                >
                                                                    <Download className="w-3 h-3" /> Save WAV
                                                                </a>
                                                            </div>
                                                        </div>
                                                        <audio
                                                            src={fixedAudioUrl}
                                                            controls
                                                            className="w-full h-10 [&::-webkit-media-controls-panel]:bg-purple-100"
                                                        />
                                                    </div>

                                                    {/* Re-Analysis Results */}
                                                    {reAnalysis && (
                                                        <div className="bg-green-900/20 border border-green-500/30 rounded-xl p-4 animate-in fade-in slide-in-from-top-2">
                                                            <div className="flex items-center gap-2 mb-2">
                                                                <CheckCircle2 className="w-4 h-4 text-green-400" />
                                                                <h5 className="text-sm font-bold text-green-300">Re-Analysis Result</h5>
                                                            </div>
                                                            <div className="text-sm text-slate-300 leading-relaxed whitespace-pre-wrap">
                                                                {reAnalysis}
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            )}

                            {error && (
                                <div className="flex items-start gap-3 p-4 bg-red-500/10 border border-red-500/20 rounded-xl text-red-200 text-sm">
                                    <AlertCircle className="w-5 h-5 shrink-0 text-red-400 mt-0.5" />
                                    <p>{error}</p>
                                </div>
                            )}
                        </div>

                        {/* Right Column: Analysis Results */}
                        <div className="relative min-h-[400px]">
                            {!analysis && !loading && (
                                <div className="absolute inset-0 border-2 border-dashed border-slate-800 rounded-2xl flex flex-col items-center justify-center text-slate-600 p-8 text-center">
                                    <div className="w-16 h-16 mb-4 rounded-full bg-slate-800/50 flex items-center justify-center">
                                        <Sparkles className="w-6 h-6 opacity-20" />
                                    </div>
                                    <p className="text-lg font-medium">No analysis yet</p>
                                    <p className="text-sm">Upload a track and hit analyze to see the AI's review here.</p>
                                </div>
                            )}

                            {loading && (
                                <div className="absolute inset-0 bg-slate-800/30 border border-slate-700/50 rounded-2xl flex flex-col items-center justify-center p-8 text-center backdrop-blur-sm">
                                    <div className="relative w-20 h-20 mb-6">
                                        <div className="absolute inset-0 border-4 border-slate-700 rounded-full"></div>
                                        <div className="absolute inset-0 border-4 border-t-purple-500 border-r-transparent border-b-transparent border-l-transparent rounded-full animate-spin"></div>
                                    </div>
                                    <h3 className="text-xl font-semibold text-white mb-2">{statusMessage || 'Processing...'}</h3>
                                    {statusMessage.includes('Compressing') ? (
                                        <div className="text-slate-400 max-w-xs flex items-center justify-center gap-2">
                                            <Minimize2 className="w-4 h-4" />
                                            <span className="text-sm">Shrinking file size...</span>
                                        </div>
                                    ) : (
                                        <p className="text-slate-400 max-w-xs animate-pulse">
                                            The AI is listening to your track...
                                        </p>
                                    )}

                                </div>
                            )}

                            {analysis && (
                                <div className="h-full bg-slate-800/40 border border-slate-700 rounded-2xl p-6 md:p-8 animate-in fade-in slide-in-from-bottom-4 duration-500 shadow-2xl">
                                    <div className="flex items-center gap-2 mb-6 border-b border-slate-700/50 pb-4">
                                        <CheckCircle2 className="w-5 h-5 text-green-400" />
                                        <h3 className="text-lg font-semibold text-white">Analysis Complete</h3>
                                    </div>

                                    <div className="prose prose-invert prose-slate max-w-none">
                                        {analysis.split('\n').map((paragraph, idx) => {
                                            if (paragraph.startsWith('**') || paragraph.startsWith('##')) {
                                                return <h4 key={idx} className="text-purple-300 font-bold text-lg mt-6 mb-2">{paragraph.replace(/[#*]/g, '')}</h4>;
                                            } else if (paragraph.startsWith('* ') || paragraph.startsWith('- ')) {
                                                return <li key={idx} className="ml-4 text-slate-300 mb-1">{paragraph.replace(/[*-\s]/, '')}</li>;
                                            } else if (paragraph.trim() === '') {
                                                return null;
                                            }
                                            return <p key={idx} className="text-slate-300 leading-relaxed mb-4">{paragraph}</p>;
                                        })}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </main>
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<AudioCriticApp />);
</script>
</body>
</html>