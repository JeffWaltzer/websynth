<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Midi Weaver</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
    <!-- Favicon: Leaf of LÃ³rien -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22 fill=%22%23b4d4a4%22>ðŸŒ¿</text></svg>">
    <style>
        :root {
            --bg-primary: #3f3b36;
            --bg-secondary: #5e584f;
            --text-primary: #f2eade;
            --accent-interactive: #87A878;
            --glow-effect: #B4D4A4;
            --font-title: 'MedievalSharp', cursive;
            --font-body: 'Crimson Text', serif;
        }
        html { scroll-padding-bottom: 8rem; /* Space for footer & status bar */ }
        body { background-color: var(--bg-primary); color: var(--text-primary); font-family: var(--font-body); }
        .panel-title { font-family: var(--font-title); color: var(--text-primary); text-shadow: 0 0 8px rgba(242, 234, 222, 0.3); }
        .control-panel-item { background-color: var(--bg-secondary); border: 2px solid var(--accent-interactive); box-shadow: inset 0 2px 4px rgba(0,0,0,0.4), 0 1px 2px rgba(0,0,0,0.5), 0 0 7px var(--accent-interactive); }
        .control-panel label { font-weight: 600; color: var(--text-primary); opacity: 0.9; }
        .themed-input { width: 100%; background-color: var(--bg-primary); border: 1px solid var(--bg-secondary); color: var(--text-primary); border-radius: 0.5rem; padding: 0.5rem 0.75rem; transition: all 0.3s ease-in-out; box-shadow: inset 0 1px 3px rgba(0,0,0,0.5); }
        .themed-input:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(50%); }
        .themed-input:focus { outline: none; border-color: var(--glow-effect); box-shadow: 0 0 10px -2px var(--glow-effect), inset 0 1px 3px rgba(0,0,0,0.5); }
        .themed-scrollbar::-webkit-scrollbar { width: 12px; }
        .themed-scrollbar::-webkit-scrollbar-track { background: var(--bg-primary); }
        .themed-scrollbar::-webkit-scrollbar-thumb { background-color: var(--bg-secondary); border-radius: 10px; border: 2px solid var(--bg-primary); }
        .themed-scrollbar::-webkit-scrollbar-thumb:hover { background-color: var(--accent-interactive); }
        .log-box { background-color: rgba(0,0,0,0.2); font-family: var(--font-body); white-space: pre-wrap; word-wrap: break-word; border-top: 2px solid var(--accent-interactive); box-shadow: inset 0 5px 15px rgba(0,0,0,0.5); }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; box-shadow: 0 0 5px; transition: all 0.5s ease; }
        .status-dot.red { background-color: #ef4444; color: #ef4444; }
        .status-dot.green { background-color: var(--glow-effect); color: var(--glow-effect);}
        .status-dot.yellow { background-color: #eab308; color: #eab308; }
        .tooltip-container { position: relative; display: inline-block; }
        .tooltip { visibility: hidden; opacity: 0; background-color: var(--bg-primary); color: var(--text-primary); text-align: center; border-radius: 6px; padding: 8px 12px; position: absolute; z-index: 10; bottom: 110%; left: 50%; transform: translateX(-50%); width: max-content; max-width: 250px; border: 1px solid var(--accent-interactive); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4); transition: opacity 0.3s ease, visibility 0.3s ease; pointer-events: none; font-size: 0.875rem; }
        .tooltip-container:hover .tooltip { visibility: visible; opacity: 1; }
        #midi-setup-status { display: none; background-color: #4a443d; border: 2px solid #eab308; border-radius: 0.75rem; margin: 1.5rem auto 0 auto; padding: 1rem; max-width: 95%; }
        .chord-display { font-family: var(--font-body); text-align: center; font-size: 2.25rem; line-height: 2.5rem; color: var(--text-primary); text-shadow: 0 0 15px var(--glow-effect); }
        .chord-display-label { font-family: var(--font-title); font-size: 1.25rem; opacity: 0.8; }
        #status-bar { position: fixed; bottom: 0; left: 0; right: 0; padding: 0.25rem 1rem; background-color: rgba(0,0,0,0.4); backdrop-filter: blur(5px); border-top: 1px solid var(--accent-interactive); text-align: center; font-family: var(--font-body); z-index: 20; }

        /* Piano Keyboard Styles */
        .piano { display: flex; list-style: none; margin: 0; padding: 0; position: relative; width: 100%; height: 80px; border-radius: 0.5rem; overflow: hidden; background: #444; }
        .piano .key { border: 1px solid #000; }
        .piano .key.white { float: left; width: calc(100% / 36); /* 36 white keys in our range */ height: 100%; background: #fff; }
        .piano .key.black { position: absolute; width: calc(100% / 36 * 0.6); height: 60%; background: #222; z-index: 2; }
        .piano .key.active { background: var(--glow-effect); border-color: var(--accent-interactive); box-shadow: inset 0 0 10px var(--accent-interactive); }
    </style>
</head>
<body class="antialiased themed-scrollbar">

<div class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="p-4 sticky top-0 z-10 bg-black/10 backdrop-blur-sm">
        <div class="container mx-auto flex justify-between items-center border-b-2 border-solid pb-4" style="border-color: var(--accent-interactive);">
            <h1 class="panel-title text-4xl">Midi Weaver</h1>
            <div class="flex items-center gap-4">
                <div class="tooltip-container">
                    <button id="rescan-button" class="w-10 h-10 rounded-full bg-black/20 flex items-center justify-center text-2xl hover:bg-blue-800/50 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>
                    </button>
                    <span class="tooltip">Rescan for MIDI Devices</span>
                </div>
                <div class="tooltip-container">
                    <button id="panic-button" class="w-10 h-10 rounded-full bg-black/20 flex items-center justify-center text-2xl hover:bg-red-800/50 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
                    </button>
                    <span class="tooltip">Panic! Sends an "All Notes Off" message to silence stuck notes.</span>
                </div>
                <div id="midi-status" class="flex items-center bg-black/20 px-4 py-2 rounded-lg">
                    <span id="midi-status-dot" class="status-dot red"></span>
                    <span id="midi-status-text" class="text-sm">Awaiting MIDI Access...</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4 md:p-6 lg:p-8 flex-grow">
        <!-- MIDI Setup Status Box -->
        <div id="midi-setup-status"></div>

        <!-- Live Chord Display Panel -->
        <div class="control-panel-item p-4 rounded-xl mb-8">
            <h2 class="panel-title text-2xl text-center mb-4">Live Chord Display</h2>
            <div class="grid grid-cols-2 gap-4 divide-x-2 divide-green-900/50">
                <div class="px-2">
                    <p class="chord-display-label">Input</p>
                    <div id="input-chord-display" class="chord-display">-</div>
                </div>
                <div class="px-2">
                    <p class="chord-display-label">Output</p>
                    <div id="output-chord-display" class="chord-display">-</div>
                </div>
            </div>
        </div>

        <!-- Output Keyboard Panel -->
        <div class="control-panel-item p-4 rounded-xl mb-8">
            <h2 class="panel-title text-2xl text-center mb-2">Live Output Keyboard</h2>
            <ul id="piano-keyboard-container" class="piano"></ul>
        </div>

        <!-- Consolidated Controls Panel -->
        <div class="control-panel-item p-6 rounded-xl md:col-span-3">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-x-8 gap-y-6">
                <!-- Column 1: MIDI Routing -->
                <div class="space-y-4">
                    <h3 class="panel-title text-xl border-b border-white/10 pb-2">MIDI Routing</h3>
                    <div class="tooltip-container w-full"><label for="midi-in-select">Input Device</label><select id="midi-in-select" class="themed-input"></select><span class="tooltip">Select the physical or virtual MIDI controller.</span></div>
                    <div class="tooltip-container w-full"><label for="midi-out-select">Output Device</label><select id="midi-out-select" class="themed-input"></select><span class="tooltip">Select the device to play the generated chords.</span></div>
                </div>
                <!-- Column 2: Harmonizer -->
                <div class="space-y-4">
                    <h3 class="panel-title text-xl border-b border-white/10 pb-2">Harmonizer</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="tooltip-container"><label for="input-channel-select">In Ch.</label><select id="input-channel-select" class="themed-input"></select><span class="tooltip">Listen for notes on this MIDI channel.</span></div>
                        <div class="tooltip-container"><label for="output-channel-select">Out Ch.</label><select id="output-channel-select" class="themed-input"></select><span class="tooltip">Send chords on this MIDI channel.</span></div>
                    </div>
                    <div class="tooltip-container"><label for="chord-type-select">Chord Type</label><select id="chord-type-select" class="themed-input"><option value="major">Major</option><option value="minor">Minor</option><option value="diminished">Diminished</option><option value="augmented">Augmented</option><option value="sus2">Sus2</option><option value="sus4">Sus4</option><option value="major7">Major 7th</option><option value="minor7">Minor 7th</option><option value="dominant7">Dominant 7th</option><option value="power">Power Chord</option><option value="single">Single Note</option></select><span class="tooltip">The harmonic structure to generate from the input root note.</span></div>
                </div>
                <!-- Column 3: Voicing -->
                <div class="space-y-4">
                    <h3 class="panel-title text-xl border-b border-white/10 pb-2">Voicing</h3>
                    <div class="tooltip-container"><label for="inversion-select">Inversion</label><select id="inversion-select" class="themed-input"><option value="0">Root</option><option value="1">1st</option><option value="2">2nd</option><option value="3">3rd</option></select><span class="tooltip">Rearrange the chord's notes.</span></div>
                    <div class="tooltip-container"><label for="octave-shift-input" class="flex justify-between"><span>Octave Shift</span><span id="octave-shift-value" class="font-bold">0</span></label><input id="octave-shift-input" class="themed-input" type="range" min="-3" max="3" value="0" step="1"><span class="tooltip">Transpose the output chord.</span></div>
                </div>
                <!-- Column 4: Performance -->
                <div class="space-y-4">
                    <h3 class="panel-title text-xl border-b border-white/10 pb-2">Performance</h3>
                    <div class="tooltip-container w-full"><label for="add-note-select">Add Note</label><select id="add-note-select" class="themed-input"><option value="none">None</option><option value="add6">Add 6th</option><option value="add9">Add 9th</option></select><span class="tooltip">Add a color note to the chord.</span></div>
                    <div class="tooltip-container w-full"><label for="chord-spread-slider" class="flex justify-between"><span>Chord Spread</span><span id="chord-spread-value">0</span></label><input id="chord-spread-slider" type="range" min="0" max="3" value="0" class="themed-input"><span class="tooltip">Spread the voicing into higher octaves.</span></div>
                    <div class="tooltip-container w-full"><label for="strum-speed-slider" class="flex justify-between"><span>Strum Speed</span><span id="strum-speed-value">0ms</span></label><input id="strum-speed-slider" type="range" min="0" max="50" value="0" step="1" class="themed-input"><span class="tooltip">Delay notes to simulate a strum.</span></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Theory Log -->
    <footer class="container mx-auto p-4 md:px-6 lg:px-8 mb-12">
        <div class="flex-1">
            <h3 class="panel-title text-2xl mb-2">Music Theory</h3>
            <div id="theory-log" class="log-box themed-scrollbar h-48 p-4 overflow-y-auto text-base"></div>
        </div>
    </footer>

    <!-- Status Bar -->
    <div id="status-bar">Waiting for input...</div>
</div>

<script>
    // --- DOM Elements ---
    const midiStatusText = document.getElementById('midi-status-text');
    const midiStatusDot = document.getElementById('midi-status-dot');
    const panicButton = document.getElementById('panic-button');
    const rescanButton = document.getElementById('rescan-button');
    const midiSetupStatus = document.getElementById('midi-setup-status');
    const inputChordDisplay = document.getElementById('input-chord-display');
    const outputChordDisplay = document.getElementById('output-chord-display');
    const statusBar = document.getElementById('status-bar');
    const pianoKeyboardContainer = document.getElementById('piano-keyboard-container');
    const midiInSelect = document.getElementById('midi-in-select');
    const midiOutSelect = document.getElementById('midi-out-select');
    const inChannelSelect = document.getElementById('input-channel-select');
    const outChannelSelect = document.getElementById('output-channel-select');
    const chordTypeSelect = document.getElementById('chord-type-select');
    const inversionSelect = document.getElementById('inversion-select');
    const octaveShiftInput = document.getElementById('octave-shift-input');
    const octaveShiftValue = document.getElementById('octave-shift-value');
    const theoryLog = document.getElementById('theory-log');
    const addNoteSelect = document.getElementById('add-note-select');
    const chordSpreadSlider = document.getElementById('chord-spread-slider');
    const chordSpreadValue = document.getElementById('chord-spread-value');
    const strumSpeedSlider = document.getElementById('strum-speed-slider');
    const strumSpeedValue = document.getElementById('strum-speed-value');

    // --- Global State ---
    let midiAccess = null;
    let activeInputNotes = new Set();
    let currentlyPlayedOutputNotes = new Set();
    let chordDetectionTimeout = null;

    // --- Note & Chord Data ---
    const NOTE_NAMES = ["C", "Câ™¯", "D", "Dâ™¯", "E", "F", "Fâ™¯", "G", "Gâ™¯", "A", "Aâ™¯", "B"];
    const CHORD_INTERVALS = { major: [0, 4, 7], minor: [0, 3, 7], diminished: [0, 3, 6], augmented: [0, 4, 8], sus2: [0, 2, 7], sus4: [0, 5, 7], major7: [0, 4, 7, 11], minor7: [0, 3, 7, 10], dominant7: [0, 4, 7, 10], power: [0, 7], single: [0] };
    const ADD_NOTE_INTERVALS = { none: null, add6: 9, add9: 14 };
    const INTERVAL_NAMES = { '0': 'R', '1': 'm2', '2': 'M2', '3': 'm3', '4': 'M3', '5': 'P4', '6': 'd5', '7': 'P5', '8': 'A5', '9': 'M6', '10': 'm7', '11': 'M7', '12': 'P8', '13': 'm9', '14': 'M9' };

    const KNOWN_CHORDS = { '4,7': '<sup>maj</sup>', '3,7': '<sup>m</sup>', '3,6': '<sup>dim</sup>', '4,8': '<sup>aug</sup>', '4,7,11': '<sup>maj7</sup>', '3,7,10': '<sup>m7</sup>', '4,7,10': '<sup>dom7</sup>', '2,7': '<sup>sus2</sup>', '5,7': '<sup>sus4</sup>', '7': '<sup>5</sup>' };

    // --- Piano Keyboard Data ---
    const KEY_MAP = [ true, false, true, false, true, true, false, true, false, true, false, true ]; // true = white, false = black
    const PIANO_START_NOTE = 36; // C2
    const PIANO_END_NOTE = 96; // C7

    // --- Functions ---
    function logSystem(message, type = 'info') {
        const color = type === 'error' ? 'text-red-400' : 'text-gray-400';
        const html = `<p class="${color}"><span class="opacity-50">${new Date().toLocaleTimeString()}:</span> ${message}</p>`;
        theoryLog.insertAdjacentHTML('beforeend', html);
        theoryLog.scrollTop = theoryLog.scrollHeight;
    }

    function updateStatusBar(htmlMessage) {
        statusBar.innerHTML = htmlMessage;
    }

    function logTheory(detail) {
        const entry = document.createElement('div');
        entry.className = 'mb-2';
        entry.innerHTML = `<p class="text-base opacity-90 whitespace-pre-line">${detail}</p>`;
        theoryLog.innerHTML = ''; // Clear previous theory
        theoryLog.appendChild(entry);
    }

    function midiNoteToName(note, includeOctave = false) {
        if (note < 0 || note > 127) return 'N/A';
        const name = NOTE_NAMES[note % 12];
        if(includeOctave) {
            return name + (Math.floor(note / 12) - 1);
        }
        return name;
    }

    function getChordName(notes) {
        if (notes.length === 0) return { name: '-', root: null };
        const sortedNotes = [...notes].sort((a,b) => a-b);

        if (notes.length === 1) return { name: midiNoteToName(sortedNotes[0]), root: sortedNotes[0] };

        if (notes.length === 2) {
            const interval = sortedNotes[1] - sortedNotes[0];
            const intervalName = INTERVAL_NAMES[interval] || 'Interval';
            return { name: `${intervalName}`, root: sortedNotes[0] };
        }

        const uniquePitchClasses = [...new Set(sortedNotes.map(n => n % 12))];

        for (const potentialRoot of uniquePitchClasses) {
            const intervals = uniquePitchClasses
                .map(pitchClass => (pitchClass - potentialRoot + 12) % 12)
                .filter(interval => interval !== 0)
                .sort((a, b) => a - b);

            const intervalKey = intervals.join(',');
            if (KNOWN_CHORDS[intervalKey]) {
                const rootName = NOTE_NAMES[potentialRoot];
                const rootNote = sortedNotes.find(n => n % 12 === potentialRoot);
                return { name: `${rootName}${KNOWN_CHORDS[intervalKey]}`, root: rootNote };
            }
        }
        return { name: '...', root: sortedNotes[0] };
    }

    // New Piano Functions
    function createPianoKeyboard() {
        pianoKeyboardContainer.innerHTML = '';
        let whiteKeyCount = 0;
        for(let i = PIANO_START_NOTE; i <= PIANO_END_NOTE; i++) {
            if(KEY_MAP[i % 12]) whiteKeyCount++;
        }

        const whiteKeyWidth = 100 / whiteKeyCount;
        let whiteKeyIndex = 0;

        for(let i = PIANO_START_NOTE; i <= PIANO_END_NOTE; i++) {
            const isWhite = KEY_MAP[i % 12];
            const key = document.createElement('li');
            key.className = `key ${isWhite ? 'white' : 'black'}`;
            key.dataset.note = i;

            if (isWhite) {
                key.style.width = `${whiteKeyWidth}%`;
                whiteKeyIndex++;
            } else {
                key.style.left = `${(whiteKeyIndex - 0.5) * whiteKeyWidth}%`;
            }

            pianoKeyboardContainer.appendChild(key);
        }
    }

    function updatePianoKeyboard(notes, state) { // state is 'on' or 'off'
        for(const note of notes) {
            const key = pianoKeyboardContainer.querySelector(`[data-note="${note}"]`);
            if(key) {
                if(state === 'on') {
                    key.classList.add('active');
                } else {
                    key.classList.remove('active');
                }
            }
        }
    }

    function handleMIDIMessage(event) {
        const [command, note, velocity] = event.data;
        const channel = command & 0x0F;
        const messageType = command & 0xF0;

        if (channel !== parseInt(inChannelSelect.value)) return;

        if (messageType === 0x90 && velocity > 0) {
            activeInputNotes.add(note);
        } else if (messageType === 0x80 || (messageType === 0x90 && velocity === 0)) {
            activeInputNotes.delete(note);
        }

        if (chordDetectionTimeout) clearTimeout(chordDetectionTimeout);
        chordDetectionTimeout = setTimeout(processChordState, 50);
    }

    function processChordState() {
        stopAllOutputNotes();

        const notes = [...activeInputNotes];
        const rootNoteForHarmonization = notes.length > 0 ? Math.min(...notes) : null;
        const { name: inputChordName } = getChordName(notes);

        inputChordDisplay.innerHTML = inputChordName;

        if (rootNoteForHarmonization !== null) {
            const { chordNotes, explanation, suggestion, outputChordName } = generateOutputChord(rootNoteForHarmonization, inputChordName);
            outputChordDisplay.innerHTML = outputChordName;
            updateStatusBar(suggestion);
            logTheory(explanation);

            playOutputChord(chordNotes, 100);
            currentlyPlayedOutputNotes = new Set(chordNotes);
        } else {
            outputChordDisplay.innerHTML = '-';
        }
        if (notes.length === 0) {
            inputChordDisplay.innerHTML = '-';
            outputChordDisplay.innerHTML = '-';
            updateStatusBar('Waiting for input...');
            theoryLog.innerHTML = '';
        }
    }

    function playOutputChord(chordNotes, velocity) {
        updatePianoKeyboard(chordNotes, 'on'); // Update piano
        const output = midiAccess.outputs.get(midiOutSelect.value);
        if (!output) return;
        const noteOnCommand = 0x90 | parseInt(outChannelSelect.value);
        const strum = parseInt(strumSpeedSlider.value);
        chordNotes.forEach((n, i) => {
            if (n >= 0 && n <= 127) {
                const delay = i * strum;
                if (delay > 0) setTimeout(() => output.send([noteOnCommand, n, velocity]), delay);
                else output.send([noteOnCommand, n, velocity]);
            }
        });
    }

    function stopAllOutputNotes() {
        updatePianoKeyboard(currentlyPlayedOutputNotes, 'off'); // Update piano
        if (currentlyPlayedOutputNotes.size === 0) return;
        const output = midiAccess.outputs.get(midiOutSelect.value);
        if (!output) return;
        const noteOffCommand = 0x80 | parseInt(outChannelSelect.value);
        for (const note of currentlyPlayedOutputNotes) {
            if (note >= 0 && note <= 127) output.send([noteOffCommand, note, 0]);
        }
        currentlyPlayedOutputNotes.clear();
    }

    function generateOutputChord(rootNote, inputChordName) {
        const intervals = [...CHORD_INTERVALS[chordTypeSelect.value]];
        const addNote = ADD_NOTE_INTERVALS[addNoteSelect.value];
        if (addNote !== null && !intervals.includes(addNote)) intervals.push(addNote);

        let notes = intervals.map(interval => rootNote + interval);
        const inversion = parseInt(inversionSelect.value);
        for (let i = 0; i < inversion; i++) { if (notes.length > i) notes[i] += 12; }
        notes.sort((a,b) => a - b);

        const spread = parseInt(chordSpreadSlider.value);
        if(spread > 0) { notes.forEach((note, i) => { if (i > 0 && i <= spread) notes[i] += 12; }); }

        const octaveShift = parseInt(octaveShiftInput.value) * 12;
        const finalNotes = notes.map(note => note + octaveShift);

        const { name: outputChordName } = getChordName(finalNotes);
        const noteNames = finalNotes.map(n => midiNoteToName(n, true) ).join(', ');
        const intervalNames = intervals.sort((a,b) => a - b).map(i => INTERVAL_NAMES[i] || '?').join(', ');

        const suggestion = `Input: <strong>${inputChordName}</strong><span class="mx-2">â†’</span>Output: <strong>${outputChordName}</strong>`;
        const explanation = `Harmonizing from Root: ${midiNoteToName(rootNote, true)}\nFormula (${chordTypeSelect.options[chordTypeSelect.selectedIndex].text}): ${intervalNames}\nResulting Notes: ${noteNames}`;

        return { chordNotes: finalNotes, suggestion, explanation, outputChordName };
    }

    // --- Mock/Helper functions for full implementation ---
    populateChannels = () => { for (let i = 1; i <= 16; i++) { const option = document.createElement('option'); option.value = i - 1; option.textContent = i; inChannelSelect.appendChild(option.cloneNode(true)); outChannelSelect.appendChild(option.cloneNode(true)); } outChannelSelect.value = 1; };
    showMidiSetupStatus = (htmlMessage) => { midiSetupStatus.innerHTML = htmlMessage; midiSetupStatus.style.display = 'block'; };
    hideMidiSetupStatus = () => { midiSetupStatus.style.display = 'none'; };
    initializeMIDI = () => { if (navigator.requestMIDIAccess) { navigator.requestMIDIAccess({ sysex: false }).then(onMIDISuccess, onMIDIFailure); } else { midiStatusText.textContent = 'Not Supported'; midiStatusDot.className = 'status-dot red'; showMidiSetupStatus('<p class="font-bold text-center">Web MIDI API is not supported in this browser.</p><p class="text-center mt-2">Please try a modern browser like Chrome, Edge, or Opera.</p>'); } };
    onMIDISuccess = (access) => { midiAccess = access; midiStatusText.textContent = 'Connected'; midiStatusDot.className = 'status-dot green'; logSystem('MIDI connection successful.'); updateDeviceLists(); midiAccess.onstatechange = (event) => { logSystem(`MIDI device state changed: ${event.port.name} is ${event.port.state}.`); updateDeviceLists(); }; };
    onMIDIFailure = (error) => { midiStatusText.textContent = 'Access Denied'; midiStatusDot.className = 'status-dot red'; logSystem(`Failed to get MIDI access - ${error.name}`, 'error'); if (error.name === 'SecurityError' || error.name === 'NotAllowedError') { showMidiSetupStatus('<p class="font-bold text-center">MIDI Access Blocked by Browser</p><p class="text-center mt-2">You need to grant permission for this site to use MIDI. Please check your browser\'s site settings (usually a lock icon in the address bar) and allow MIDI access, then refresh the page.</p>'); } else { showMidiSetupStatus(`<p class="font-bold text-center">Could not access MIDI devices.</p><p class="text-center mt-2">Error: ${error.name}. Please try refreshing the page.</p>`); } };
    updateDeviceLists = () => { if (!midiAccess) return; let sid = midiInSelect.value, sod = midiOutSelect.value; midiInSelect.innerHTML = ''; midiOutSelect.innerHTML = ''; if (midiAccess.inputs.size === 0) { midiInSelect.innerHTML = '<option>No Inputs Found</option>'; } else { midiAccess.inputs.forEach(i => { const o = document.createElement('option'); o.value = i.id; o.textContent = i.name; midiInSelect.appendChild(o); }); } if (midiAccess.outputs.size === 0) { midiOutSelect.innerHTML = '<option>No Outputs Found</option>'; } else { midiAccess.outputs.forEach(o => { const p = document.createElement('option'); p.value = o.id; p.textContent = o.name; midiOutSelect.appendChild(p); }); } if (midiAccess.inputs.has(sid)) midiInSelect.value = sid; if (midiAccess.outputs.has(sod)) midiOutSelect.value = sod; if (midiAccess.inputs.size === 0 || midiAccess.outputs.size === 0) { showMidiSetupStatus('<p class="font-bold text-center">No MIDI Devices Found</p><p class="text-center mt-2">Please ensure your MIDI device is connected and turned on, then click the "Rescan" button in the header.</p>'); } else { hideMidiSetupStatus(); } attachMIDIMessageListener(); };
    attachMIDIMessageListener = () => { if (!midiAccess) return; midiAccess.inputs.forEach(i => i.onmidimessage = null); const ci = midiAccess.inputs.get(midiInSelect.value); if(ci) { ci.onmidimessage = handleMIDIMessage; logSystem(`Listening on: ${ci.name}`); } };
    setupEventListeners = () => { midiInSelect.addEventListener('change', () => attachMIDIMessageListener()); midiOutSelect.addEventListener('change', () => logSystem(`Selected Output: ${midiOutSelect.options[midiOutSelect.selectedIndex].text}`)); octaveShiftInput.addEventListener('input', e => octaveShiftValue.textContent = e.target.value); strumSpeedSlider.addEventListener('input', e => { strumSpeedValue.textContent = `${e.target.value}ms`; }); chordSpreadSlider.addEventListener('input', e => { chordSpreadValue.textContent = e.target.value; }); rescanButton.addEventListener('click', () => { logSystem('Manual MIDI device scan initiated.'); updateDeviceLists(); }); panicButton.addEventListener('click', () => { stopAllOutputNotes(); activeInputNotes.clear(); inputChordDisplay.innerHTML = '-'; outputChordDisplay.innerHTML = '-'; logSystem('Panic: All notes stopped.'); updateStatusBar('Waiting for input...'); theoryLog.innerHTML = ''; }); };

    window.addEventListener('DOMContentLoaded', () => {
        logSystem('Application loaded. Initializing MIDI...');
        midiStatusText.textContent = 'Initializing...';
        midiStatusDot.className = 'status-dot yellow';
        createPianoKeyboard();
        populateChannels();
        setupEventListeners();
        initializeMIDI();
    });
</script>
</body>
</html>
