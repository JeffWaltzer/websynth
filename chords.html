<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIDI Chord Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        .chord-display { min-height: 24px; }
        .chord-description-display {
            min-height: 15px;
            line-height: 1.1;
            font-size: 0.5rem;
        }
        .notes-list-display {
            min-height: 10px;
            font-size: 0.5rem;
        }
        /* Removed styles for .mini-notation-display, .staff-wrapper, .staff-slot-svg-container, .staff-slot-svg, .accidental-text */
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen h-screen flex flex-col items-center justify-center p-1 sm:p-2 overflow-hidden">

    <div class="w-full max-w-4xl flex flex-col h-full">
        <header class="mb-1 text-center">
            <h1 class="text-xl sm:text-2xl font-bold text-sky-400">MIDI Chord Monitor</h1>
            <div id="status" class="mt-1 text-xs sm:text-sm text-gray-400">Requesting MIDI access...</div>
            <div class="my-1 sm:my-2 w-full max-w-xs mx-auto">
                <label for="midi-device-select" class="block text-xs text-gray-400 mb-0.5 text-left">Select MIDI Input:</label>
                <select id="midi-device-select" class="bg-gray-700 border border-gray-600 text-gray-100 text-xs sm:text-sm rounded-md focus:ring-sky-500 focus:border-sky-500 block w-full p-1.5">
                    <option value="">Detecting devices...</option>
                </select>
            </div>
        </header>

        <main id="chord-grid" class="grid grid-cols-4 gap-1 sm:gap-2 flex-grow overflow-y-auto">
            </main>

        <footer class="text-center mt-1 sm:mt-2 text-xs text-gray-500">
            Chord detection may vary.
        </footer>
    </div>

    <script>
        const statusDiv = document.getElementById('status');
        const chordGrid = document.getElementById('chord-grid');
        const deviceSelect = document.getElementById('midi-device-select');
        const noteNames = ["C", "C♯", "D", "D♯", "E", "F", "F♯", "G", "G♯", "A", "A♯", "B"];

        let activeNotesByChannel = {};
        for (let i = 0; i < 16; i++) activeNotesByChannel[i] = new Set();

        let midiAccess = null;
        let selectedDeviceId = null;

        const chordFormulas = {
            '△7': [0,4,7,11],'m7': [0,3,7,10],'7': [0,4,7,10],'°7': [0,3,6,9],'ø7': [0,3,6,10],
            'm△7': [0,3,7,11],'+7': [0,4,8,10],'+△7': [0,4,8,11],'M6': [0,4,7,9],'m6': [0,3,7,9],
            '': [0,4,7],'m': [0,3,7],'°': [0,3,6],'+': [0,4,8],'sus4': [0,5,7],'sus2': [0,2,7],
            'add9': [0,2,4,7],'mAdd9': [0,2,3,7],'6/9': [0,2,4,7,9],
            'P1': [0],'m2': [0,1],'M2': [0,2],'m3': [0,3],'M3': [0,4],'P4': [0,5],'TT': [0,6],
            'P5': [0,7],'m6_int': [0,8],'M6_int': [0,9],'m7_int': [0,10],'M7_int': [0,11]
        };
        const sortedChordFormulas = Object.entries(chordFormulas)
            .sort(([,a],[,b]) => b.length - a.length);

        const chordDescriptions = {
            '':{name:"Major Triad (Stable, Bright)",comp:"Rel Minor/Dom V"},'m':{name:"Minor Triad (Somber, Emotional)",comp:"Rel Major/Dom V"},
            '7':{name:"Dominant 7th (Tense, Resolves)",comp:"Tonic (I)"},'△7':{name:"Major 7th (Rich, Jazzy)",comp:"ii m7"},
            'm7':{name:"Minor 7th (Smooth, Jazzy)",comp:"V7"},'°':{name:"Diminished Triad (Dissonant, Unstable)",comp:"Resolving Chord"},
            '+':{name:"Augmented Triad (Tense, Ethereal)",comp:"Resolving Chord"},'sus4':{name:"Suspended 4th (Open, Anticipates)",comp:"Major/Minor Triad"},
            'sus2':{name:"Suspended 2nd (Open, Bright)",comp:"Major Triad"},'ø7':{name:"Half-Diminished 7th (Jazzy Pre-Dom)",comp:"Dom 7th"},
            '°7':{name:"Diminished 7th (Very Tense, Symmetrical)",comp:"Resolving Chord"},'m△7':{name:"Minor Major 7th (Melancholic, Complex)",comp:"Dom 7th"},
            '+7':{name:"Augmented Dominant 7th (Altered Tension)",comp:"Resolving Minor/Major"},'+△7':{name:"Augmented Major 7th (Ethereal, Jazzy)",comp:"Minor 7th"},
            'M6':{name:"Major 6th (Stable, Sweet)",comp:"Rel m7"},'m6':{name:"Minor 6th (Rich, Melancholic)",comp:"ii ø7"},
            'add9':{name:"Added 9th (Rich Major)",comp:"Dom 7th"},'mAdd9':{name:"Minor Added 9th (Rich Minor)",comp:"Dom 7th"},
            '6/9':{name:"6/9 Chord (Lush, Jazzy)",comp:"Altered Dom"},'P1':{name:"Unison / Octave"},'m2':{name:"Minor 2nd Interval"},
            'M2':{name:"Major 2nd Interval"},'m3':{name:"Minor 3rd Interval"},'M3':{name:"Major 3rd Interval"},'P4':{name:"Perfect 4th Interval"},
            'TT':{name:"Tritone Interval"},'P5':{name:"Perfect 5th Interval"},'m6_int':{name:"Minor 6th Interval"},'M6_int':{name:"Major 6th Interval"},
            'm7_int':{name:"Minor 7th Interval"},'M7_int':{name:"Major 7th Interval"}
        };

        // Removed compactStaffLayout and getAccidentalChar function

        function initializeUI() {
            chordGrid.innerHTML = '';
            for (let i = 0; i < 16; i++) {
                const channelDiv = document.createElement('div');
                channelDiv.className = 'bg-gray-800 p-1 sm:p-2 rounded-md shadow-md text-center flex flex-col justify-between';
                // Removed notation-ch-${i} div from here
                channelDiv.innerHTML = `
                    <div>
                        <div class="text-[0.55rem] sm:text-xs text-gray-400 mb-0.5">CH ${i + 1}</div>
                        <div id="chord-ch-${i}" class="chord-display text-xs sm:text-sm md:text-base font-semibold text-sky-300 break-words leading-tight flex items-center justify-center">---</div>
                        <div id="desc-ch-${i}" class="chord-description-display text-sky-100 mt-0.5 break-words leading-tight"></div>
                        </div>
                    <div id="notes-ch-${i}" class="notes-list-display text-gray-500 mt-0.5 truncate"></div>
                `;
                chordGrid.appendChild(channelDiv);
            }
        }

        function requestMidiAccess() {
            if (navigator.requestMIDIAccess) {
                navigator.requestMIDIAccess({ sysex: false }).then(onMIDISuccess, onMIDIFailure);
            } else {
                statusDiv.textContent = "Web MIDI API not supported."; statusDiv.className = "mt-1 text-xs sm:text-sm text-red-400";
                deviceSelect.innerHTML = '<option value="">MIDI API not supported</option>';
            }
        }

        function onMIDISuccess(access) {
            midiAccess = access;
            populateDeviceList();
            midiAccess.onstatechange = populateDeviceList;
        }

        function onMIDIFailure() {
            statusDiv.textContent = "Failed to get MIDI access."; statusDiv.className = "mt-1 text-xs sm:text-sm text-red-400";
            deviceSelect.innerHTML = '<option value="">MIDI access failed</option>';
        }

        function populateDeviceList() {
            if (!midiAccess) return;
            const inputs = midiAccess.inputs;
            const previouslySelectedId = deviceSelect.value;
            deviceSelect.innerHTML = '';

            if (inputs.size === 0) {
                deviceSelect.innerHTML = '<option value="">No MIDI input devices found</option>';
                statusDiv.textContent = "MIDI access granted, but no input devices found.";
                statusDiv.className = "mt-1 text-xs sm:text-sm text-yellow-400";
                selectedDeviceId = null;
                attachListenerToSelectedDevice();
                return;
            }

            inputs.forEach(input => {
                const option = document.createElement('option');
                option.value = input.id;
                option.textContent = input.name || `Unknown Device ${input.id.substring(0,6)}`;
                deviceSelect.appendChild(option);
            });

            let foundPrevious = false;
            if (previouslySelectedId) {
                for (let i = 0; i < deviceSelect.options.length; i++) {
                    if (deviceSelect.options[i].value === previouslySelectedId) {
                        deviceSelect.selectedIndex = i;
                        foundPrevious = true;
                        break;
                    }
                }
            }
            if (!foundPrevious && deviceSelect.options.length > 0) {
                deviceSelect.selectedIndex = 0;
            }
            selectedDeviceId = deviceSelect.value;
            attachListenerToSelectedDevice();
        }

        function attachListenerToSelectedDevice() {
            if (!midiAccess) return;
            midiAccess.inputs.forEach(input => input.onmidimessage = null);

            if (selectedDeviceId && midiAccess.inputs.has(selectedDeviceId)) {
                const device = midiAccess.inputs.get(selectedDeviceId);
                if (device) {
                    device.onmidimessage = handleMIDIMessage;
                    statusDiv.textContent = `Listening to: ${device.name || 'Unknown Device'}`;
                    statusDiv.className = "mt-1 text-xs sm:text-sm text-green-400";
                } else {
                     statusDiv.textContent = "Selected MIDI device not found.";
                     statusDiv.className = "mt-1 text-xs sm:text-sm text-yellow-400";
                }
            } else if (midiAccess.inputs.size > 0) {
                 statusDiv.textContent = "Please select a MIDI device.";
                 statusDiv.className = "mt-1 text-xs sm:text-sm text-yellow-400";
            }
        }

        deviceSelect.addEventListener('change', () => {
            selectedDeviceId = deviceSelect.value;
            for (let i = 0; i < 16; i++) {
                activeNotesByChannel[i].clear();
                updateChannelDisplay(i);
            }
            attachListenerToSelectedDevice();
        });

        function handleMIDIMessage(event) {
            const command = event.data[0] >> 4;
            const channel = event.data[0] & 0x0f;
            const note = event.data[1];
            const velocity = event.data[2];

            switch (command) {
                case 9: if (velocity > 0) activeNotesByChannel[channel].add(note);
                        else activeNotesByChannel[channel].delete(note); break;
                case 8: activeNotesByChannel[channel].delete(note); break;
            }
            updateChannelDisplay(channel);
        }

        function midiNoteToName(midiNote) { return noteNames[midiNote % 12]; }
        function arraysEqual(a,b) {
            if (a === b) return true; if (a == null || b == null) return false; if (a.length !== b.length) return false;
            for (let i = 0; i < a.length; ++i) if (a[i] !== b[i]) return false; return true;
        }

        function identifyChord(notesSet) {
            const notes = Array.from(notesSet).sort((a, b) => a - b);
            let chordName = "---"; let noteList = ""; let description = "";

            if (notes.length === 0) return { chordName, noteList, description };
            const uniquePitchClasses = [...new Set(notes.map(n => n % 12))].sort((a,b)=>a-b);
            noteList = notes.map(n => midiNoteToName(n) + Math.floor(n/12 -1)).join(' ');

            if (uniquePitchClasses.length === 1) {
                chordName = noteNames[uniquePitchClasses[0]];
                const descObj = chordDescriptions['P1'];
                if(descObj) {description = descObj.name; if(descObj.comp) description += ` (Comp: ${descObj.comp})`;}
                return { chordName, noteList, description };
            }
            for (const rootCandidatePitchClass of uniquePitchClasses) {
                const intervals = uniquePitchClasses.map(pc => (pc - rootCandidatePitchClass + 12) % 12).sort((a,b)=>a-b);
                for (const [suffix, formulaIntervals] of sortedChordFormulas) {
                    if (arraysEqual(intervals, formulaIntervals)) {
                        chordName = noteNames[rootCandidatePitchClass] + suffix;
                        const descObj = chordDescriptions[suffix];
                        if(descObj) {description = descObj.name; if(descObj.comp) description += ` (Comp: ${descObj.comp})`;}
                        return { chordName, noteList, description };
                    }
                }
            }
            chordName = uniquePitchClasses.map(pc => noteNames[pc]).join(' ');
            return { chordName, noteList, description };
        }

        // Removed generateSimplifiedNotation function

        function updateChannelDisplay(channel) {
            const chordResult = identifyChord(activeNotesByChannel[channel]);
            // Removed call to generateSimplifiedNotation and notationEl

            const chordEl = document.getElementById(`chord-ch-${channel}`);
            const descEl = document.getElementById(`desc-ch-${channel}`);
            const notesEl = document.getElementById(`notes-ch-${channel}`);
            // Removed notationEl from query selectors

            if (chordEl) chordEl.textContent = chordResult.chordName;
            if (descEl) {
                descEl.textContent = chordResult.description;
                descEl.title = (descEl.scrollHeight > descEl.clientHeight || descEl.scrollWidth > descEl.clientWidth) ? chordResult.description : '';
            }
            // Removed update for notationEl
            if (notesEl) {
                notesEl.textContent = chordResult.noteList;
                notesEl.title = (notesEl.scrollWidth > notesEl.clientWidth) ? chordResult.noteList : '';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeUI();
            requestMidiAccess();
        });
    </script>
</body>
</html>
