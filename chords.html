<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIDI Chord Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        .chord-display { min-height: 24px; }
        .chord-description-display {
            min-height: 15px;
            line-height: 1.1;
            font-size: 0.55rem;
        }
        .notes-list-display {
            min-height: 10px;
            font-size: 0.5rem;
        }
        .recommendations-display {
            min-height: 10px;
            line-height: 1.1;
            font-size: 0.5rem;
        }
        .channel-card.active-flash {
            background-color: #075985 !important; /* sky-800, slightly darker for flash */
            transition: background-color 0.05s ease-out;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen h-screen flex flex-col items-center justify-center p-1 sm:p-2 overflow-hidden">

    <div class="w-full max-w-4xl flex flex-col h-full">
        <header class="mb-1 text-center">
            <h1 class="text-xl sm:text-2xl font-bold text-sky-400">MIDI Chord Monitor</h1>
            <div id="status" class="mt-1 text-xs sm:text-sm text-gray-400">Requesting MIDI access...</div>
            <div class="my-1 sm:my-2 w-full max-w-xs mx-auto">
                <label for="midi-device-select" class="block text-xs text-gray-400 mb-0.5 text-left">Select MIDI Input:</label>
                <select id="midi-device-select" class="bg-gray-700 border border-gray-600 text-gray-100 text-xs sm:text-sm rounded-md focus:ring-sky-500 focus:border-sky-500 block w-full p-1.5">
                    <option value="">Detecting devices...</option>
                </select>
            </div>
        </header>

        <main id="chord-grid" class="grid grid-cols-4 gap-1 sm:gap-2 flex-grow overflow-y-auto">
            </main>

        <footer class="text-center mt-1 sm:mt-2 text-xs text-gray-500">
            Chord detection may vary. Recommendations are suggestions.
        </footer>
    </div>

    <script>
        const statusDiv = document.getElementById('status');
        const chordGrid = document.getElementById('chord-grid');
        const deviceSelect = document.getElementById('midi-device-select');
        const noteNames = ["C", "C♯", "D", "D♯", "E", "F", "F♯", "G", "G♯", "A", "A♯", "B"];

        let activeNotesByChannel = {};
        for (let i = 0; i < 16; i++) activeNotesByChannel[i] = new Set();

        let midiAccess = null;
        let selectedDeviceId = null;

        // Chord Formulas: Suffix and intervals from the root (0)
        // Comments indicate example chord with C as root
        const chordFormulas = {
            // 13ths
            '13':   [0, 2, 4, 7, 9, 10],  // C13 (C-E-G-Bb-D-A)
            'm13':  [0, 2, 3, 7, 9, 10],  // Cm13 (C-Eb-G-Bb-D-A)
            '△13':  [0, 2, 4, 7, 9, 11],  // C△13 (C-E-G-B-D-A) (Major 13th)

            // 11ths
            '11':   [0, 2, 5, 7, 10],     // C11 (C-G-Bb-D-F)
            'm11':  [0, 2, 3, 5, 7, 10],  // Cm11 (C-Eb-G-Bb-D-F)
            '△11':  [0, 2, 4, 5, 7, 11],  // C△11 (C-E-G-B-D-F) (Major 11th)

            // 9ths
            '△9':   [0, 2, 4, 7, 11],     // C△9 (C-E-G-B-D) (Major 9th)
            'm9':   [0, 2, 3, 7, 10],     // Cm9 (C-Eb-G-Bb-D) (minor 9th)
            '9':    [0, 2, 4, 7, 10],     // C9 (C-E-G-Bb-D) (Dominant 9th)
            'm△9':  [0, 2, 3, 7, 11],     // Cm△9 (C-Eb-G-B-D) (Minor Major 9th)

            // Altered Dominants & Lydian Dominant
            '7♯9':  [0, 3, 4, 7, 10],     // C7#9 (C-E-G-Bb-D#)
            '7♭9':  [0, 1, 4, 7, 10],     // C7b9 (C-E-G-Bb-Db)
            '7♭5':  [0, 4, 6, 10],        // C7b5 (C-E-Gb-Bb)
            '7♯11': [0, 4, 6, 7, 10],     // C7#11 (C-E-G-Bb-F#) (Lydian Dominant)
            '7alt': [0, 1, 3, 4, 6, 8, 10], // C7alt (example structure for C Super Locrian)

            // Sevenths
            '△7':   [0, 4, 7, 11],        // C△7 (C-E-G-B) (Major 7th)
            '△7♯11':[0, 4, 6, 7, 11],     // C△7#11 (C-E-G-B-F#) (Lydian Major)
            'm7':   [0, 3, 7, 10],        // Cm7 (C-Eb-G-Bb) (minor 7th)
            '7':    [0, 4, 7, 10],        // C7 (C-E-G-Bb) (Dominant 7th)
            '°7':   [0, 3, 6, 9],         // C°7 (C-Eb-Gb-Bbb) (Diminished 7th)
            'ø7':   [0, 3, 6, 10],        // Cø7 (C-Eb-Gb-Bb) (Half-diminished 7th, m7b5)
            'm△7':  [0, 3, 7, 11],        // Cm△7 (C-Eb-G-B) (minor Major 7th)
            '+7':   [0, 4, 8, 10],        // C+7 (C-E-G#-Bb) (Augmented Dominant 7th)
            '+△7':  [0, 4, 8, 11],        // C+△7 (C-E-G#-B) (Augmented Major 7th)
            '7sus4':[0, 5, 7, 10],        // C7sus4 (C-F-G-Bb)

            // Sixths & 6/9
            'M6':   [0, 4, 7, 9],         // CM6 (C-E-G-A) (Major 6th)
            'm6':   [0, 3, 7, 9],         // Cm6 (C-Eb-G-A) (minor 6th)
            'm6/9': [0, 2, 3, 7, 9],      // Cm6/9 (C-Eb-G-A-D)

            // Prog Rock additions
            '9sus4':  [0, 2, 5, 7],       // C9sus4 (C-F-G-D) (no 7th)
            'm7(11)':[0, 3, 5, 7, 10],    // Cm7(11) (C-Eb-F-G-Bb) (no 9th)
            'add♯4':  [0, 4, 6, 7],       // Cadd#4 (C-E-F#-G) (Lydian Triad)
            'm(♭6)':  [0, 3, 7, 8],       // Cm(b6) (C-Eb-G-Ab) (minor add flat 6)

            // Triads & Basic Suspended
            '':     [0, 4, 7],            // C (C-E-G) (Major Triad)
            'm':    [0, 3, 7],            // Cm (C-Eb-G) (minor Triad)
            '°':    [0, 3, 6],            // C° (C-Eb-Gb) (Diminished Triad)
            '+':    [0, 4, 8],            // C+ (C-E-G#) (Augmented Triad)
            'sus4': [0, 5, 7],            // Csus4 (C-F-G)
            'sus2': [0, 2, 7],            // Csus2 (C-D-G)

            // Added Note Chords
            'add9':    [0, 2, 4, 7],      // Cadd9 (C-E-G-D)
            'mAdd9':   [0, 2, 3, 7],      // CmAdd9 (C-Eb-G-D)
            '6/9':     [0, 2, 4, 7, 9],   // C6/9 (C-E-G-A-D)

            // Intervals
            'P1': [0], 'm2': [0, 1], 'M2': [0, 2], 'm3': [0, 3], 'M3': [0, 4],
            'P4': [0, 5], 'TT': [0, 6], 'P5': [0, 7], 'm6_int': [0, 8], 'M6_int': [0, 9],
            'm7_int': [0, 10], 'M7_int': [0, 11]
        };
        const sortedChordFormulas = Object.entries(chordFormulas)
            .sort(([,a],[,b]) => b.length - a.length);

        // Chord descriptions: Suffix, full name, and recommendations (comp field)
        // Comp field now contains comma-separated chord names for suggestions
        const chordDescriptions = {
            '△13':{ name: "Major 13th", comp: "Dm9, G13" },
            'm13':{ name: "Minor 13th", comp: "G7alt" },
            '13': { name: "Dominant 13th", comp: "F△7" },
            '△11':{ name: "Major 11th", comp: "Bm7" },
            'm11':{ name: "Minor 11th", comp: "G7alt" },
            '11': { name: "Dominant 11th (no 3rd)", comp: "F△7" },
            '△9': { name: "Major 9th", comp: "Dm9, G13" },
            'm9': { name: "Minor 9th", comp: "G13, C△9" },
            '9':  { name: "Dominant 9th", comp: "F△7" },
            'm△9':{ name: "Minor Major 9th", comp: "G7alt"},
            '7♯9':{ name: "Dominant 7th ♯9", comp: "Fm7" },
            '7♭9':{ name: "Dominant 7th ♭9", comp: "Fm7, F△7" },
            '7♭5':{ name: "Dominant 7th ♭5", comp: "F△7" },
            '7♯11':{name: "Dominant 7th ♯11", comp: "F△7"},
            '7alt':{name: "Altered Dominant", comp: "Fm7, F△7"},
            '△7': { name: "Major 7th", comp: "Dm7, G7" },
            '△7♯11':{name: "Major 7th ♯11", comp: "Bm7, E7alt"},
            'm7': { name: "Minor 7th", comp: "G7, F△7" },
            '7':  { name: "Dominant 7th", comp: "F△7" },
            '°7': { name: "Diminished 7th", comp: "F, Fm" },
            'ø7': { name: "Half-Diminished 7th", comp: "G7alt, Fm" },
            'm△7':{ name: "Minor Major 7th", comp: "G7alt" },
            '+7': { name: "Augmented Dom 7th", comp: "Fm, F" },
            '+△7':{ name: "Augmented Major 7th", comp: "Dm7" },
            '7sus4':{name: "Dominant 7th sus 4", comp: "G7, F" },
            'M6': { name: "Major 6th", comp: "Dm7, G7" },
            'm6': { name: "Minor 6th", comp: "Dø7, G7alt" },
            'm6/9':{ name: "Minor 6/9", comp: "Dø7, G7alt"},
            '5':    { name: "Power Chord", comp: "F5, Bb5" },
            '9sus4':{ name: "Suspended 9th (no 7th)", comp: "G9, C△9" },
            'm7(11)':{ name: "Minor 7th add 11 (no 9th)", comp: "G9" },
            'add♯4':{ name: "Major add #4 (Lydian Triad)", comp: "G△7#11" },
            'm(♭6)':{ name: "Minor add flat 6", comp: "G7b9" },
            '':   { name: "Major Triad", comp: "F, G, Am" },
            'm':  { name: "Minor Triad", comp: "Eb, Ab, G" },
            '°':  { name: "Diminished Triad", comp: "F, Fm" },
            '+':  { name: "Augmented Triad", comp: "F, Fm" },
            'sus4':{name: "Suspended 4th", comp: "C, Cm" },
            'sus2':{name: "Suspended 2nd", comp: "C" },
            'add9': { name: "Major Add 9", comp: "F△9, G9" },
            'mAdd9':{ name: "Minor Add 9", comp: "Ab△9" },
            '6/9':  { name: "6/9 Chord", comp: "Dm9, G13" },
            'P1': { name: "Unison / Octave", comp: "" }, 'm2': { name: "Minor 2nd Int", comp: "" },
            'M2': { name: "Major 2nd Int", comp: "" }, 'm3': { name: "Minor 3rd Int", comp: "" },
            'M3': { name: "Major 3rd Int", comp: "" }, 'P4': { name: "Perfect 4th Int", comp: "" },
            'TT': { name: "Tritone Int", comp: "" }, 'P5': { name: "Perfect 5th Int", comp: "" },
            'm6_int':{ name: "Minor 6th Int", comp: "" },'M6_int':{ name: "Major 6th Int", comp: "" },
            'm7_int':{ name: "Minor 7th Int", comp: "" },'M7_int':{ name: "Major 7th Int", comp: "" }
        };

        function initializeUI() {
            chordGrid.innerHTML = '';
            for (let i = 0; i < 16; i++) {
                const channelDiv = document.createElement('div');
                channelDiv.id = `channel-card-${i}`;
                channelDiv.className = 'channel-card bg-gray-800 p-1 sm:p-2 rounded-md shadow-md text-center flex flex-col justify-between';
                channelDiv.innerHTML = `
                    <div>
                        <div class="text-[0.55rem] sm:text-xs text-gray-400 mb-0.5">CH ${i + 1}</div>
                        <div id="chord-ch-${i}" class="chord-display text-xs sm:text-sm md:text-base font-semibold text-sky-300 break-words leading-tight flex items-center justify-center">---</div>
                        <div id="desc-ch-${i}" class="chord-description-display text-sky-100 mt-0.5 break-words leading-tight"></div>
                        <div class="text-[0.5rem] text-gray-400 mt-1">Suggestions:</div>
                        <div id="reco-ch-${i}" class="recommendations-display text-teal-300 leading-tight">---</div>
                    </div>
                    <div id="notes-ch-${i}" class="notes-list-display text-gray-500 mt-0.5 truncate">---</div>
                `;
                chordGrid.appendChild(channelDiv);
            }
        }

        function requestMidiAccess() {
            if (navigator.requestMIDIAccess) {
                navigator.requestMIDIAccess({ sysex: false }).then(onMIDISuccess, onMIDIFailure);
            } else {
                statusDiv.textContent = "Web MIDI API not supported."; statusDiv.className = "mt-1 text-xs sm:text-sm text-red-400";
                deviceSelect.innerHTML = '<option value="">MIDI API not supported</option>';
            }
        }

        function onMIDISuccess(access) {
            midiAccess = access;
            populateDeviceList();
            midiAccess.onstatechange = populateDeviceList;
        }

        function onMIDIFailure() {
            statusDiv.textContent = "Failed to get MIDI access."; statusDiv.className = "mt-1 text-xs sm:text-sm text-red-400";
            deviceSelect.innerHTML = '<option value="">MIDI access failed</option>';
        }

        function populateDeviceList() {
            if (!midiAccess) return;
            const inputs = midiAccess.inputs;
            const previouslySelectedId = deviceSelect.value;
            deviceSelect.innerHTML = '';

            if (inputs.size === 0) {
                deviceSelect.innerHTML = '<option value="">No MIDI input devices found</option>';
                statusDiv.textContent = "MIDI access granted, but no input devices found.";
                statusDiv.className = "mt-1 text-xs sm:text-sm text-yellow-400";
                selectedDeviceId = null;
                attachListenerToSelectedDevice();
                return;
            }

            inputs.forEach(input => {
                const option = document.createElement('option');
                option.value = input.id;
                option.textContent = input.name || `Unknown Device ${input.id.substring(0,6)}`;
                deviceSelect.appendChild(option);
            });

            let foundPrevious = false;
            if (previouslySelectedId) {
                for (let i = 0; i < deviceSelect.options.length; i++) {
                    if (deviceSelect.options[i].value === previouslySelectedId) {
                        deviceSelect.selectedIndex = i;
                        foundPrevious = true;
                        break;
                    }
                }
            }
            if (!foundPrevious && deviceSelect.options.length > 0) {
                deviceSelect.selectedIndex = 0;
            }
            selectedDeviceId = deviceSelect.value;
            attachListenerToSelectedDevice();
        }

        function attachListenerToSelectedDevice() {
            if (!midiAccess) return;
            midiAccess.inputs.forEach(input => input.onmidimessage = null);

            if (selectedDeviceId && midiAccess.inputs.has(selectedDeviceId)) {
                const device = midiAccess.inputs.get(selectedDeviceId);
                if (device) {
                    device.onmidimessage = handleMIDIMessage;
                    statusDiv.textContent = `Listening to: ${device.name || 'Unknown Device'}`;
                    statusDiv.className = "mt-1 text-xs sm:text-sm text-green-400";
                } else {
                     statusDiv.textContent = "Selected MIDI device not found.";
                     statusDiv.className = "mt-1 text-xs sm:text-sm text-yellow-400";
                }
            } else if (midiAccess.inputs.size > 0) {
                 statusDiv.textContent = "Please select a MIDI device.";
                 statusDiv.className = "mt-1 text-xs sm:text-sm text-yellow-400";
            }
        }

        deviceSelect.addEventListener('change', () => {
            selectedDeviceId = deviceSelect.value;
            for (let i = 0; i < 16; i++) {
                activeNotesByChannel[i].clear();
                updateChannelDisplay(i);
            }
            attachListenerToSelectedDevice();
        });

        function handleMIDIMessage(event) {
            const command = event.data[0] >> 4;
            const channel = event.data[0] & 0x0f;
            const note = event.data[1];
            const velocity = event.data[2];

            let stateChanged = false;
            switch (command) {
                case 9:
                    if (velocity > 0) {
                        const sizeBefore = activeNotesByChannel[channel].size;
                        activeNotesByChannel[channel].add(note);
                        if (activeNotesByChannel[channel].size > sizeBefore) {
                            stateChanged = true;
                            const channelCard = document.getElementById(`channel-card-${channel}`);
                            if (channelCard) {
                                channelCard.classList.add('active-flash');
                                setTimeout(() => {
                                    channelCard.classList.remove('active-flash');
                                }, 150);
                            }
                        }
                    } else {
                        if (activeNotesByChannel[channel].delete(note)) {
                            stateChanged = true;
                        }
                    }
                    break;
                case 8:
                    if (activeNotesByChannel[channel].delete(note)) {
                        stateChanged = true;
                    }
                    break;
                case 11:
                    if (event.data[1] === 123 && velocity === 0) {
                        if (activeNotesByChannel[channel].size > 0) {
                            activeNotesByChannel[channel].clear();
                            stateChanged = true;
                        }
                        console.log(`All notes off for CH ${channel + 1}`);
                    }
                    break;
            }

             if (stateChanged || (command === 9 && velocity > 0)) {
                updateChannelDisplay(channel);
             } else if (!stateChanged && (command === 8 || (command === 9 && velocity ===0))){
                  if(activeNotesByChannel[channel].size === 0) updateChannelDisplay(channel);
             }
        }

        // Helper to get note name with octave (e.g., C4, F#3)
        function midiNoteToNameWithOctave(midiNote) {
            const octave = Math.floor(midiNote / 12) - 1; // MIDI C4=60, C0=-1, so C4 is octave 4.
            return noteNames[midiNote % 12] + octave;
        }

        function arraysEqual(a,b) {
            if (a === b) return true; if (a == null || b == null) return false; if (a.length !== b.length) return false;
            for (let i = 0; i < a.length; ++i) if (a[i] !== b[i]) return false; return true;
        }

        // Helper to get notes for a suggested chord name
        function getNotesForSuggestedChord(fullChordName) {
            let rootName = "";
            let suffix = "";
            // Regex to extract root (C, C#, Db, etc.) and suffix (m7, △9, etc.)
            const match = fullChordName.match(/^([A-Ga-g][#♯b♭]?)(.*)$/);
            if (match) {
                rootName = match[1].replace('b', '♭').replace('#','♯'); // Normalize accidentals
                suffix = match[2];
            } else {
                return ""; // Cannot parse
            }

            const rootPitchClass = noteNames.indexOf(rootName);
            if (rootPitchClass === -1) return ""; // Unknown root

            const intervals = chordFormulas[suffix];
            if (!intervals) {
                console.warn(`No formula found for suffix: '${suffix}' in suggested chord: '${fullChordName}'`);
                return ""; // Unknown suffix
            }

            // Assume a base octave for suggestions, e.g., C4 as MIDI 60
            // This places the root of the suggested chord in the '4' octave (e.g. C4, F#4)
            const baseMidiRoot = 60 + rootPitchClass;

            const chordNotes = intervals.map(interval => {
                const midiNote = baseMidiRoot + interval;
                return midiNoteToNameWithOctave(midiNote);
            });
            return chordNotes.join('-');
        }


        function identifyChord(notesSet) {
            const notes = Array.from(notesSet).sort((a, b) => a - b);
            let chordName = "---"; let noteList = ""; let description = ""; let recommendations = "";

            if (notes.length === 0) return { chordName, noteList, description, recommendations };

            const uniquePitchClasses = [...new Set(notes.map(n => n % 12))].sort((a,b)=>a-b);
            noteList = notes.map(n => midiNoteToNameWithOctave(n)).join(' '); // Use helper for octave

            if (uniquePitchClasses.length === 1) {
                chordName = noteNames[uniquePitchClasses[0]];
                const descObj = chordDescriptions['P1'];
                if(descObj) {
                    description = descObj.name;
                    if (descObj.comp) {
                         recommendations = descObj.comp.split(',')
                            .map(s => s.trim()).filter(s => s)
                            .map(cn => {
                                const notesOfSugg = getNotesForSuggestedChord(cn);
                                return notesOfSugg ? `${cn} (${notesOfSugg})` : cn;
                            }).join('; ');
                    }
                }
                return { chordName, noteList, description, recommendations };
            }

            for (const rootCandidatePitchClass of uniquePitchClasses) {
                const intervals = uniquePitchClasses.map(pc => (pc - rootCandidatePitchClass + 12) % 12).sort((a,b)=>a-b);
                for (const [suffix, formulaIntervals] of sortedChordFormulas) {
                    if (arraysEqual(intervals, formulaIntervals)) {
                        let currentSuffix = suffix;
                        if (suffix === 'P5' && uniquePitchClasses.length === 2 && notes.length >=2) {
                            currentSuffix = '5'; // Power Chord
                        }

                        chordName = noteNames[rootCandidatePitchClass] + currentSuffix;

                        const descObj = chordDescriptions[currentSuffix];
                        if(descObj) {
                            description = descObj.name;
                            if (descObj.comp) {
                                recommendations = descObj.comp.split(',') // Split by comma
                                    .map(s => s.trim()) // Trim whitespace
                                    .filter(s => s)      // Remove empty strings
                                    .map(chordNameSuggestion => {
                                        const notesOfSuggestion = getNotesForSuggestedChord(chordNameSuggestion);
                                        return notesOfSuggestion ? `${chordNameSuggestion} (${notesOfSuggestion})` : chordNameSuggestion;
                                    })
                                    .join('; '); // Join with semicolon and space for display
                            }
                        }
                        return { chordName, noteList, description, recommendations };
                    }
                }
            }
            chordName = uniquePitchClasses.map(pc => noteNames[pc]).join(' ');
            return { chordName, noteList, description, recommendations };
        }

        function updateChannelDisplay(channel) {
            const chordResult = identifyChord(activeNotesByChannel[channel]);

            const chordEl = document.getElementById(`chord-ch-${channel}`);
            const descEl = document.getElementById(`desc-ch-${channel}`);
            const notesEl = document.getElementById(`notes-ch-${channel}`);
            const recoEl = document.getElementById(`reco-ch-${channel}`);

            if (chordEl) chordEl.textContent = chordResult.chordName || "---";

            if (descEl) {
                const newDescription = chordResult.description || "";
                descEl.textContent = newDescription;
                descEl.title = (newDescription && (descEl.scrollHeight > descEl.clientHeight || descEl.scrollWidth > descEl.clientWidth)) ? newDescription : '';
            }

            if (recoEl) {
                const newRecommendations = chordResult.recommendations || "---";
                recoEl.textContent = newRecommendations;
                recoEl.title = (newRecommendations && newRecommendations !== "---" && (recoEl.scrollHeight > recoEl.clientHeight || recoEl.scrollWidth > recoEl.clientWidth)) ? newRecommendations : '';
            }

            if (notesEl) {
                if (activeNotesByChannel[channel].size === 0) {
                    notesEl.textContent = "---";
                    notesEl.title = '';
                } else {
                    const newNoteList = chordResult.noteList || "";
                    notesEl.textContent = newNoteList;
                    notesEl.title = (newNoteList && (notesEl.scrollHeight > notesEl.clientHeight || notesEl.scrollWidth > notesEl.clientWidth)) ? newNoteList : '';
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeUI();
            requestMidiAccess();
        });
    </script>
</body>
</html>
