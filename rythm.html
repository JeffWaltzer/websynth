<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rhythm King 77 - Websynth (MIDI Only)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #3a3a3a;
            color: #f0e6d2;
            overscroll-behavior: none;
            font-size: 12px;
        }
        .main-container {
            margin-bottom: 2rem;
        }
        .synth-panel {
            background-color: #5a4a3a;
            border: 2px solid #7a6a5a;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5), inset 0 2px 4px rgba(255,255,255,0.1);
            padding: 0.4rem;
            margin-bottom: 0.5rem;
            transition: opacity 0.4s ease-in-out, filter 0.4s ease-in-out, border-color 0.4s ease-in-out, box-shadow 0.4s ease-in-out;
        }
        select.no-midi-error {
            border-color: #ef4444 !important; /* Tailwind's red-500 */
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.4);
        }
        .control-slider-container {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        .number-input-container {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        .slider-button, .number-input-button {
            background-color: #7a6a5a;
            color: #f0e6d2;
            border: 1px solid #5a4a3a;
            border-radius: 4px;
            padding: 0.1rem 0.3rem;
            font-size: 0.8rem;
            font-weight: bold;
            line-height: 1;
            cursor: pointer;
            user-select: none;
        }
        .slider-button:hover, .number-input-button:hover {
            background-color: #9a8a7a;
        }

        .control-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 17.5px;
            background: #4a3a2a;
            border-radius: 8.75px;
            border: 1px solid #3a2a1a;
            outline: none;
            cursor: pointer;
            flex-grow: 1;
        }
        .control-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 30px;
            height: 30px;
            background: #c0b090;
            border-radius: 6.25px;
            border: 2px solid #3a2a1a;
            cursor: grab;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .control-slider::-moz-range-thumb {
            width: 30px;
            height: 30px;
            background: #c0b090;
            border-radius: 6.25px;
            border: 2px solid #3a2a1a;
            cursor: grab;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .master-control-panel .control-slider {
            height: 24px;
        }
        .master-control-panel .control-slider::-webkit-slider-thumb {
            width: 30px;
            height: 30px;
        }
        .master-control-panel .control-slider::-moz-range-thumb {
            width: 30px;
            height: 30px;
        }
        .push-button {
            font-family: 'Orbitron', sans-serif;
            background-color: #7a6a5a;
            color: #f0e6d2;
            border: 2px solid #5a4a3a;
            padding: 0.3rem 0.6rem;
            border-radius: 6px;
            text-transform: uppercase;
            font-weight: bold;
            font-size: 0.6rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3), inset 0 1px 1px rgba(255,255,255,0.2);
            transition: all 0.1s ease-in-out;
            height: 28px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .push-button.icon-button {
            font-size: 0.9rem;
            padding: 0.4rem;
        }
        .push-button:active, .push-button.active {
            background-color: #9a8a7a;
            box-shadow: 0 1px 2px rgba(0,0,0,0.4), inset 0 2px 3px rgba(0,0,0,0.2);
            transform: translateY(1px);
        }

        #playStopButton {
            width: 28px;
            height: 28px;
            padding: 0;
            flex-shrink: 0;
            font-size: 1rem;
            border-radius: 6px;
        }

        #playStopButton.play-state {
            background-color: #9b59b6; /* Purple */
            color: white;
            border-color: #8e44ad;
        }
        #playStopButton.play-state:hover {
            background-color: #8e44ad;
        }

        #playStopButton.stop-state {
            background-color: #e74c3c; /* Red */
            color: white;
            border-color: #c0392b;
        }
        #playStopButton.stop-state:hover {
            background-color: #c0392b;
        }

        .learn-cc-button, .note-learn-button, .randomize-button, .default-settings-button, .master-randomize-button, .re-init-midi-button, .save-load-button {
            color: white;
            padding: 0.15rem 0.35rem;
            font-size: 0.6rem;
            border-radius: 3px;
        }
        .learn-cc-button { background-color: #4CAF50; flex-shrink: 0; padding: 0.1rem 0.4rem; font-size: 0.75rem;}
        .note-learn-button { background-color: #f44336; padding: 0.1rem 0.4rem; font-size: 0.75rem;}
        .randomize-button { background-color: #2196F3; }
        .default-settings-button { background-color: #607D8B; }
        .master-randomize-button { background-color: #FFC107; color: #333; }
        .re-init-midi-button { background-color: #9C27B0; }
        .save-load-button { background-color: #8E44AD; }
        .learn-cc-button.learning, .note-learn-button.learning { background-color: #FF9800; }

        .pattern-display {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 0.2rem;
            height: 24px;
        }
        .pattern-step {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #7a6a5a;
            margin: 0 1.5px;
            transition: background-color 0.1s, transform 0.1s, box-shadow 0.1s;
        }
        .pattern-step.active { background-color: #f0ad4e; }
        .pattern-step.current {
            transform: scale(1.25);
            box-shadow: 0 0 5px #f0ad4e;
        }
        label {
            display: block;
            margin-bottom: 0.1rem;
            font-size: 0.65rem;
            text-transform: uppercase;
            font-family: 'Orbitron', sans-serif;
            white-space: nowrap;
            margin-right: 0.5rem;
        }
        select, input[type="number"] {
            background-color: #4a3a2a;
            border: 1px solid #7a6a5a;
            color: #f0e6d2;
            padding: 0.3rem;
            border-radius: 5px;
            width: 100%;
            font-size: 0.75rem;
        }
        .master-control-panel select, .master-control-panel input[type="number"] {
            padding: 0.4rem 0.3rem;
        }
        .master-control-panel .number-input-container input[type="number"] {
            padding: 0.3rem;
            text-align: center;
            flex-grow: 1;
        }

        input[type="text"] {
            background-color: #4a3a2a;
            border: 1px solid #7a6a5a;
            color: #f0e6d2;
            padding: 0.3rem;
            border-radius: 5px;
            width: 100%;
            font-size: 0.75rem;
        }
        .value-display {
            font-family: 'Orbitron', sans-serif;
            color: #f0ad4e;
            font-size: 0.75rem;
            min-width: 25px;
            text-align: right;
            flex-grow: 1;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 0.2rem;
        }
        .control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.1rem;
        }
        .checkbox-label-container {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.7rem;
            margin-top: 0.2rem;
            cursor: pointer;
        }
        .checkbox-label-container input[type="checkbox"] {
            width: 12px;
            height: 12px;
            accent-color: #f0ad4e;
        }

        #sequencerTracksContainer {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(336px, 1fr));
            gap: 0.75rem;
        }
        #sequencerWrapperPanel {
            flex-grow: 1;
        }

        #sequencerWrapperPanel.stopped {
            opacity: 0.5;
            filter: saturate(0.2);
        }
        #sequencerWrapperPanel.stopped .pattern-step.active,
        #sequencerWrapperPanel.stopped .pattern-step.current {
            background-color: #7a6a5a !important;
            transform: scale(1) !important;
            box-shadow: none !important;
        }

        #sequencerTracksContainer > .synth-panel {
            margin-bottom: 0;
            flex: 1 1 auto;
        }
        #statusBar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #2a2a2a;
            color: #f0e6d2;
            padding: 0.5rem;
            text-align: center;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none;
            font-family: 'Inter', sans-serif;
            text-transform: none;
            white-space: nowrap;
            overflow: hidden;
            z-index: 1001;
        }
        #statusBar.visible {
            opacity: 1;
            pointer-events: auto;
        }
        #statusBar-content {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
        }

        .explanation-text-footer {
            font-size: 0.75rem;
            line-height: 1.4;
            color: #c0b090;
            text-align: center;
            padding: 1rem 0.5rem;
            max-width: 600px;
            margin: 1rem auto 0 auto;
        }
        .note-input-group {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .note-input-group > input {
            flex-grow: 1;
        }
        .disco-flash {
            transition: background-color 0.05s ease-in-out !important;
        }
        .control-flash {
            transition: background-color 0.1s ease-out;
            background-color: #f0ad4e !important;
        }

        /* Music Mode Styles */
        #musicModePanel {
            display: none;
            flex-direction: column;
            gap: 0.5rem;
        }
        body.music-mode-active #musicModePanel {
            display: flex;
        }
        #appContainer {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        #mainContent {
            flex-grow: 1;
            min-width: 0;
        }
        #musicModeLog {
            height: 6.5rem;
            background-color: rgba(0,0,0,0.2);
            border-radius: 6px;
            padding: 0.25rem;
            font-size: 0.65rem;
            line-height: 1.3;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse;
            color: #f0ad4e;
        }
        #musicModeLog > div {
            padding: 0 0.25rem;
        }
        #channelVolumesContainer .control-group {
            padding: 0 0.2rem;
            margin-bottom: 0.1rem;
        }
        #channelVolumesContainer .control-header {
            margin-bottom: 0;
        }
        #channelVolumesContainer .control-slider {
            height: 12px;
        }
        #channelVolumesContainer .control-slider::-webkit-slider-thumb {
            width: 20px;
            height: 20px;
        }
        #channelVolumesContainer .control-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
        }
        #channelVolumesContainer label {
            font-size: 0.6rem;
        }

        #bottom-panels-container {
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }
    </style>
</head>
<body class="p-1 md:p-2">

<header class="text-center mb-3">
    <h1 class="text-2xl md:text-3xl font-bold" style="font-family: 'Orbitron', sans-serif; color: #f0ad4e;">Rhythm King 77</h1>
    <p class="text-xs md:text-sm">Euclidean MIDI Sequencer</p>
</header>

<div id="appContainer">
    <!-- Main App Content -->
    <div id="mainContent" class="flex-grow">
        <div class="flex flex-col gap-3 main-container">
            <div id="sequencerWrapperPanel" class="w-full synth-panel">
                <h2 class="text-base font-semibold mb-2 text-center" style="font-family: 'Orbitron', sans-serif;">Euclidean Sequencer</h2>
                <div id="sequencerTracksContainer">
                </div>
            </div>

            <div id="bottom-panels-container" class="flex flex-col lg:flex-row gap-3">
                <div id="masterControlPanel" class="lg:w-1/4 synth-panel flex flex-col gap-2 master-control-panel">
                    <h2 class="text-base font-semibold mb-1 text-center" style="font-family: 'Orbitron', sans-serif;">Master Control</h2>

                    <div class="flex justify-center items-center gap-2 flex-wrap mb-2 px-2">
                        <button id="playStopButton" class="push-button icon-button" title="Start or stop all sequences">&#x25B6;</button>
                        <button id="saveStateButton" class="push-button save-load-button icon-button" title="Save the current state of all tracks, tempo, and MIDI settings to your browser's local storage.">&#128190;</button>
                        <button id="loadStateButton" class="push-button save-load-button icon-button" title="Load the last saved state from your browser's local storage.">&#128193;</button>
                    </div>
                    <div class="flex justify-center items-center gap-2 flex-wrap mb-2 px-2">
                        <button id="defaultSettingsButton" class="push-button default-settings-button flex-grow" title="Reset all tracks to a default starting pattern.">DEFAULTS</button>
                        <button id="masterRandomizeButton" class="push-button master-randomize-button flex-grow" title="Randomize the parameters for all currently active tracks.">RANDOM</button>
                        <button id="reInitMidiButton" class="push-button re-init-midi-button flex-grow" title="Rescan for available MIDI output devices.">RESET MIDI</button>
                    </div>

                    <div class="control-group">
                        <div><label for="numTracksInput">Number of Tracks:</label></div>
                        <div class="number-input-container">
                            <button class="number-input-button" data-target="numTracksInput" data-action="decrement" title="Decrease number of tracks">&minus;</button>
                            <input type="number" id="numTracksInput" min="1" max="12" value="4" title="Set the total number of sequencer tracks (1-12).">
                            <button class="number-input-button" data-target="numTracksInput" data-action="increment" title="Increase number of tracks">+</button>
                        </div>
                    </div>

                    <div class="control-group">
                        <div class="control-header">
                            <label for="bpmSlider">Tempo:</label>
                            <span id="bpmValue" class="value-display">35</span>
                            <button id="bpmSliderLearnCc" class="learn-cc-button ml-2" data-param-id="bpmSlider" title="Map Master Tempo to a MIDI CC">L</button>
                        </div>
                        <div class="control-slider-container">
                            <button class="slider-button" data-target="bpmSlider" data-action="decrement" title="Decrease Tempo">&minus;</button>
                            <input type="range" id="bpmSlider" min="20" max="240" value="35" class="control-slider" title="Adjust master tempo (20-240 BPM)">
                            <button class="slider-button" data-target="bpmSlider" data-action="increment" title="Increase Volume">+</button>
                        </div>
                    </div>

                    <div class="control-group">
                        <div class="control-header">
                            <label for="masterVolumeSlider">Volume:</label>
                            <span id="masterVolumeValue" class="value-display">100</span>
                            <button id="masterVolumeLearnCc" class="learn-cc-button ml-2" data-param-id="masterVolumeSlider" title="Map Master Volume to MIDI CC #7">L</button>
                        </div>
                        <div class="control-slider-container">
                            <button class="slider-button" data-target="masterVolumeSlider" data-action="decrement" title="Decrease Volume">&minus;</button>
                            <input type="range" id="masterVolumeSlider" min="0" max="127" value="100" class="control-slider" title="Adjust master volume (MIDI CC #7)">
                            <button class="slider-button" data-target="masterVolumeSlider" data-action="increment" title="Increase Volume">+</button>
                        </div>
                    </div>

                    <div class="control-group">
                        <label class="checkbox-label-container" title="Lock all 'Steps' sliders together. Changing one will change all.">
                            <input type="checkbox" id="lockStepsCheckbox"> Lock All Steps
                        </label>
                    </div>

                    <div class="control-group">
                        <label class="checkbox-label-container" title="Toggle the Music Mode panel for generative, automatic randomization.">
                            <input type="checkbox" id="musicModeToggle"> Music Mode
                        </label>
                    </div>

                    <div class="control-group">
                        <label for="midiOutSelect">MIDI Output:</label>
                        <select id="midiOutSelect" title="Select MIDI output device">
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="midiChannelSelect">Global MIDI Ch:</label>
                        <select id="midiChannelSelect" title="Select global MIDI channel (1-16)">
                        </select>
                    </div>
                    <div class="mt-auto pt-1">
                        <p class="text-xs text-center">User ID: <span id="userIdDisplay" class="font-mono"></span></p>
                    </div>
                </div>

                <div id="musicModePanel" class="synth-panel lg:w-1/4">
                    <h2 class="text-base font-semibold mb-1 text-center" style="font-family: 'Orbitron', sans-serif;">Music Mode</h2>
                    <div class="control-group">
                        <div class="control-header">
                            <label for="randomIntervalSlider">Interval (Bars):</label>
                            <span id="randomIntervalValue" class="value-display">4</span>
                        </div>
                        <div class="control-slider-container">
                            <button class="slider-button" data-target="randomIntervalSlider" data-action="decrement" title="Decrease Interval">&minus;</button>
                            <input type="range" id="randomIntervalSlider" min="1" max="16" value="4" class="control-slider" title="Set the interval in bars for automatic randomization.">
                            <button class="slider-button" data-target="randomIntervalSlider" data-action="increment" title="Increase Interval">+</button>
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="font-bold text-xs uppercase" style="font-family: 'Orbitron', sans-serif;">Randomize:</label>
                        <label class="checkbox-label-container"><input type="checkbox" id="randomizeNoteCheck" checked title="Allow Music Mode to randomize track notes."> Notes</label>
                        <label class="checkbox-label-container"><input type="checkbox" id="randomizePulsesCheck" title="Allow Music Mode to randomize track pulses."> Pulses</label>
                        <label class="checkbox-label-container"><input type="checkbox" id="randomizeRotationCheck" title="Allow Music Mode to randomize track rotation."> Rotation</label>
                        <label class="checkbox-label-container"><input type="checkbox" id="randomizeScaleCheck" title="Allow Music Mode to change the musical scale."> Scale</label>
                    </div>
                    <div class="control-group">
                        <label class="checkbox-label-container" title="When checked, Music Mode randomizes all active tracks at once. When unchecked, it randomizes one track at a time.">
                            <input type="checkbox" id="multiTrackRandomToggle"> Multi-Track Random
                        </label>
                    </div>
                    <div class="control-group mt-2">
                        <button id="musicModeNextButton" class="push-button w-full" title="Manually trigger the next generative step.">Next</button>
                    </div>
                    <div class="control-group mt-2">
                        <label class="font-bold text-xs uppercase" style="font-family: 'Orbitron', sans-serif;">Log</label>
                        <div id="musicModeLog"></div>
                    </div>
                </div>
                <div id="channelVolumesWrapper" class="synth-panel flex-grow">
                    <h2 class="text-base font-semibold mb-2 text-center" style="font-family: 'Orbitron', sans-serif;">Channel Volumes</h2>
                    <div id="channelVolumesContainer" class="grid grid-cols-4 sm:grid-cols-4 md:grid-cols-4 lg:grid-cols-4 gap-x-3 gap-y-1">
                    </div>
                </div>
            </div>
        </div>


        <div id="explanationContainer" class="explanation-text-footer">
            <p>
                Euclidean rhythms are generated by distributing beats (pulses) as evenly as possible over a set number of time steps, creating natural, complex polyrhythms.
            </p>
        </div>

    </div>
</div>
<div id="statusBar"><div id="statusBar-content"></div></div>

<script>
    // --- DOM Elements ---
    const playStopButton = document.getElementById('playStopButton');
    const defaultSettingsButton = document.getElementById('defaultSettingsButton');
    const masterRandomizeButton = document.getElementById('masterRandomizeButton');
    const saveStateButton = document.getElementById('saveStateButton');
    const loadStateButton = document.getElementById('loadStateButton');
    const reInitMidiButton = document.getElementById('reInitMidiButton');
    const numTracksInput = document.getElementById('numTracksInput');
    const lockStepsCheckbox = document.getElementById('lockStepsCheckbox');
    const bpmSlider = document.getElementById('bpmSlider');
    const bpmValue = document.getElementById('bpmValue');
    const bpmSliderLearnCc = document.getElementById('bpmSliderLearnCc');
    const masterVolumeSlider = document.getElementById('masterVolumeSlider');
    const masterVolumeValue = document.getElementById('masterVolumeValue');
    const masterVolumeLearnCc = document.getElementById('masterVolumeLearnCc');
    const midiOutSelect = document.getElementById('midiOutSelect');
    const midiChannelSelect = document.getElementById('midiChannelSelect');
    const sequencerWrapperPanel = document.getElementById('sequencerWrapperPanel');
    const sequencerTracksContainer = document.getElementById('sequencerTracksContainer');
    const channelVolumesContainer = document.getElementById('channelVolumesContainer');
    const userIdDisplay = document.getElementById('userIdDisplay');
    const statusBar = document.getElementById('statusBar');
    const statusBarContent = document.getElementById('statusBar-content');
    const masterControlPanel = document.getElementById('masterControlPanel');
    const channelVolumesWrapper = document.getElementById('channelVolumesWrapper');
    // Music Mode Elements
    const musicModeToggle = document.getElementById('musicModeToggle');
    const randomIntervalSlider = document.getElementById('randomIntervalSlider');
    const randomIntervalValue = document.getElementById('randomIntervalValue');
    const randomizeNoteCheck = document.getElementById('randomizeNoteCheck');
    const randomizePulsesCheck = document.getElementById('randomizePulsesCheck');
    const randomizeRotationCheck = document.getElementById('randomizeRotationCheck');
    const randomizeScaleCheck = document.getElementById('randomizeScaleCheck');
    const multiTrackRandomToggle = document.getElementById('multiTrackRandomToggle');
    const musicModeNextButton = document.getElementById('musicModeNextButton');
    const musicModeLog = document.getElementById('musicModeLog');

    let midiAccess = null;
    let midiOutput = null;
    let selectedMidiChannel = 1;
    let numTracks = 4;
    const MAX_TRACKS = 12;
    let sequencerTracks = [];
    let transportLoops = [];
    let currentLearningControl = null;
    let noteLearningTrack = null;
    let midiCcMap = {};
    const STATE_STORAGE_KEY = 'rhythmKing77_state_v3';
    let statusTimeout = null;
    let statusMessageActive = false;
    let stepsLocked = false;
    let globalLockedSteps = 8;
    let currentRandomizationScale = [];
    let currentScaleName = '';
    let channelVolumes = new Array(16).fill(100);
    let noteHistory = [];
    const MAX_NOTE_HISTORY = 30;
    let timedRandomEvent = null;
    let autosaveTimeout = null;
    let allowAutosave = true;
    let logClearTimeout = null;
    let messageInterval = null;


    // --- Harmony Engine ---
    const SCALES = {
        'Major': [0, 2, 4, 5, 7, 9, 11], 'Minor': [0, 2, 3, 5, 7, 8, 10],
        'Dorian': [0, 2, 3, 5, 7, 9, 10], 'Phrygian': [0, 1, 3, 5, 7, 8, 10],
        'Lydian': [0, 2, 4, 6, 7, 9, 11], 'Mixolydian': [0, 2, 4, 5, 7, 9, 10],
        'Locrian': [0, 1, 3, 5, 6, 8, 10], 'Major Pentatonic': [0, 2, 4, 7, 9],
        'Minor Pentatonic': [0, 3, 5, 7, 10], 'Blues': [0, 3, 5, 6, 7, 10],
        'Harmonic Minor': [0, 2, 3, 5, 7, 8, 11]
    };
    const NOTE_NAMES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

    const helpfulMessages = [
        "Use the 'L' buttons to map your MIDI controller's knobs and faders.",
        "Try 'Music Mode' for a generative, ambient experience.",
        "Click the 'Random' button on a track for instant inspiration.",
        "You can save your entire session to the browser with the save icon.",
        "Holding +/- buttons will quickly change slider values."
    ];

    let autoRepeatTimeoutId = null;
    let autoRepeatIntervalId = null;
    const AUTO_REPEAT_DELAY = 500;
    const AUTO_REPEAT_INTERVAL = 100;

    function updateStatusBar() {
        if (statusMessageActive) return;

        let statusText = ``;
        if (Tone.Transport.state === 'started' && currentScaleName) {
            statusText = `Current Scale: ${currentScaleName}`;
        }

        statusBarContent.textContent = statusText;
        statusBar.classList.toggle('visible', !!statusText);
    }

    function showHelpfulMessage() {
        if (Tone.Transport.state === 'stopped') return;
        const randomIndex = Math.floor(Math.random() * helpfulMessages.length);
        showStatusMessage(helpfulMessages[randomIndex], 4000);
    }

    function showStatusMessage(message, duration = 3000) {
        if(statusTimeout) clearTimeout(statusTimeout);
        statusMessageActive = true;
        statusBarContent.textContent = message;
        statusBar.classList.add('visible');
        statusTimeout = setTimeout(() => {
            statusMessageActive = false;
            updateStatusBar();
        }, duration);
    }

    function addNoteToHistory(noteName) {
        if (noteHistory.length > MAX_NOTE_HISTORY) {
            noteHistory.pop();
        }
        noteHistory.unshift(noteName);
        // Note display removed from status bar, but history is kept for potential future use
    }


    function generateEuclideanPattern(pulses, steps) {
        if (pulses > steps || pulses <= 0 || steps <= 0) return Array(steps).fill(0);
        let groups = [];
        for (let i = 0; i < steps; i++) groups.push(i < pulses ? [1] : [0]);
        let remainder = pulses, divisor = steps - pulses;
        while (true) {
            if (divisor === 0 || remainder === 0) break;
            if (divisor > remainder) {
                [remainder, divisor] = [divisor, remainder];
                let ones = [], zeros = [];
                groups.forEach(g => (g[0] === 1 ? ones : zeros).push(g));
                groups = zeros.concat(ones);
            }
            if (remainder === 0) break;
            for (let i = 0; i < divisor; i++) {
                if (groups[i] && groups[remainder + i]) groups[i].push(...groups[remainder + i]);
                else break;
            }
            groups.splice(remainder, divisor);
            remainder -= divisor;
        }
        let pattern = [].concat(...groups);
        if (pattern.length !== steps) pattern = pattern.length < steps ? pattern.concat(Array(steps - pattern.length).fill(0)) : pattern.slice(0, steps);
        return pattern;
    }

    function rotatePattern(pattern, rotation) {
        const len = pattern.length;
        if (len === 0) return [];
        const r = ((rotation % len) + len) % len;
        return pattern.slice(r).concat(pattern.slice(0, r));
    }

    function requestSaveState() {
        if (!allowAutosave) return;
        if (autosaveTimeout) clearTimeout(autosaveTimeout);
        autosaveTimeout = setTimeout(saveState, 500); // Debounce save requests
    }

    function saveState() {
        const state = {
            numTracks: numTracks,
            bpm: parseInt(bpmSlider.value),
            masterVolume: parseInt(masterVolumeSlider.value),
            channelVolumes: channelVolumes,
            midiOutputId: midiOutput ? midiOutput.id : null,
            globalMidiChannel: selectedMidiChannel,
            stepsLocked: stepsLocked,
            globalLockedSteps: globalLockedSteps,
            tracks: sequencerTracks.map(t => ({
                pulses: t.pulses, steps: t.steps, rotation: t.rotation, note: t.note,
                velocity: t.velocity, active: t.active, channelOverride: t.channelOverride
            })),
            midiCcMap: midiCcMap,
            musicMode: {
                enabled: musicModeToggle.checked,
                interval: randomIntervalSlider.value,
                randomize: {
                    note: randomizeNoteCheck.checked,
                    pulses: randomizePulsesCheck.checked,
                    rotation: randomizeRotationCheck.checked,
                    scale: randomizeScaleCheck.checked,
                },
                multiTrack: multiTrackRandomToggle.checked
            },
            currentScaleName: currentScaleName
        };
        try {
            localStorage.setItem(STATE_STORAGE_KEY, JSON.stringify(state));
        }
        catch (e) { console.error("Save failed:", e); showStatusMessage("Error saving state.", 5000); }
    }

    async function applyState(state, isPlaying) {
        if (!isPlaying && Tone.Transport.state === 'started') {
            await Tone.Transport.stop();
        }

        numTracks = (state && state.numTracks) || 4;

        bpmSlider.value = (state && state.bpm) || 120;
        Tone.Transport.bpm.value = bpmSlider.value;

        masterVolumeSlider.value = (state && state.masterVolume) || 100;
        channelVolumes = (state && state.channelVolumes) || new Array(16).fill(100);
        selectedMidiChannel = (state && state.globalMidiChannel) || 1;
        stepsLocked = (state && state.stepsLocked) || false;
        globalLockedSteps = (state && state.globalLockedSteps) || 8;
        midiCcMap = (state && state.midiCcMap) || {};
        currentScaleName = (state && state.currentScaleName) || '';

        numTracksInput.value = numTracks;
        bpmValue.textContent = bpmSlider.value;
        masterVolumeValue.textContent = masterVolumeSlider.value;
        lockStepsCheckbox.checked = stepsLocked;
        midiChannelSelect.value = selectedMidiChannel;

        const musicModeState = state ? state.musicMode : null;
        musicModeToggle.checked = musicModeState ? musicModeState.enabled : false;
        document.body.classList.toggle('music-mode-active', musicModeToggle.checked);
        randomIntervalSlider.value = musicModeState ? musicModeState.interval : 4;
        randomIntervalValue.textContent = randomIntervalSlider.value;
        randomizeNoteCheck.checked = musicModeState ? musicModeState.randomize.note : true;
        randomizePulsesCheck.checked = musicModeState ? musicModeState.randomize.pulses : false;
        randomizeRotationCheck.checked = musicModeState ? musicModeState.randomize.rotation : false;
        randomizeScaleCheck.checked = musicModeState ? musicModeState.randomize.scale : false;
        multiTrackRandomToggle.checked = musicModeState ? musicModeState.multiTrack : false;

        createChannelVolumeUI();
        sequencerTracksContainer.innerHTML = '';
        musicModeLog.innerHTML = '';

        transportLoops.forEach(l => l && l.dispose());
        transportLoops = [];
        sequencerTracks = [];

        for (let i = 0; i < numTracks; i++) {
            createSequencerTrackUI(i);
            if (state && state.tracks && state.tracks[i]) {
                const savedTrack = state.tracks[i];
                const track = sequencerTracks[i];
                Object.assign(track, savedTrack);

                track.ui.pulsesSlider.value = track.pulses; track.ui.pulsesValue.textContent = track.pulses;
                track.ui.stepsSlider.value = track.steps; track.ui.stepsValue.textContent = track.steps;
                track.ui.rotationSlider.max = track.steps > 0 ? track.steps - 1 : 0;
                track.ui.rotationSlider.value = track.rotation; track.ui.rotationValue.textContent = track.rotation;
                track.ui.noteInput.value = Tone.Frequency(track.note, "midi").toNote();
                track.ui.velocitySlider.value = track.velocity; track.ui.velocityValue.textContent = track.velocity;
                track.ui.toggleButton.classList.toggle('active', track.active);
                track.ui.toggleButton.textContent = track.active ? 'ON' : 'OFF';
                track.ui.channelOverrideSelect.value = track.channelOverride;
            }
        }

        sequencerTracks.forEach(updateTrackPattern);

        if (state && state.midiOutputId && Array.from(midiOutSelect.options).some(o => o.value === state.midiOutputId)) {
            midiOutSelect.value = state.midiOutputId;
            updateMidiOutput();
        }
        setupTimedRandomization();
        updateStatusBar();
    }

    async function loadStateAndRebuild() {
        allowAutosave = false;
        try {
            const savedStateJSON = localStorage.getItem(STATE_STORAGE_KEY);
            if (!savedStateJSON) {
                showStatusMessage("No saved state found.");
                return;
            }
            const state = JSON.parse(savedStateJSON);
            const isPlaying = Tone.Transport.state === 'started';
            await applyState(state, isPlaying);
            showStatusMessage("State Loaded Successfully!");
        } catch(e) {
            showStatusMessage("Error loading state. Data might be corrupt.", 5000);
            console.error("Failed to load state:", e);
        } finally {
            setTimeout(() => { allowAutosave = true; }, 100);
        }
    }


    async function setupMIDI() {
        try {
            if (!navigator.requestMIDIAccess) { showStatusMessage('Web MIDI API not supported.'); return; }
            if (midiAccess) midiAccess.inputs.forEach(i => i.onmidimessage = null);
            midiAccess = await navigator.requestMIDIAccess({ sysex: false });
            populateMidiDeviceList();
            midiAccess.addEventListener('statechange', populateMidiDeviceList);
            midiAccess.inputs.forEach(i => i.onmidimessage = handleMidiMessage);
        } catch (err) { showStatusMessage('MIDI Access Denied/Not Supported.'); }
    }

    reInitMidiButton.addEventListener('click', async () => {
        showStatusMessage("Resetting all MIDI channels...", 1500);
        if (Tone.Transport.state === 'started') {
            await Tone.Transport.stop();
        }
        for (let i = 1; i <= 16; i++) {
            if (midiOutput) {
                // All Sound Off
                midiOutput.send([0xB0 + (i - 1), 120, 0]);
                // All Notes Off
                midiOutput.send([0xB0 + (i - 1), 123, 0]);
            }
        }
        await setupMIDI();
    });

    function populateMidiDeviceList() {
        if (!midiAccess) return;
        const savedStateJSON = localStorage.getItem(STATE_STORAGE_KEY);
        const saved = savedStateJSON ? JSON.parse(savedStateJSON) : {};
        const prefId = saved.midiOutputId || (midiOutput ? midiOutput.id : null);
        midiOutSelect.innerHTML = '';
        let count = 0, firstOut = null, foundPref = false;
        midiAccess.outputs.forEach(out => {
            const opt = new Option(out.name, out.id);
            midiOutSelect.add(opt);
            if (!firstOut) firstOut = out;
            if (out.id === prefId) foundPref = true;
            count++;
        });
        if (count === 0) midiOutSelect.add(new Option("No MIDI Devices Found", ""));
        else midiOutSelect.value = (foundPref && prefId) ? prefId : (firstOut ? firstOut.id : '');
        updateMidiOutput();
    }

    function updateMidiOutput() {
        const noMidi = !midiAccess || !midiOutSelect.value || (midiOutSelect.options.length > 0 && midiOutSelect.options[0].text === "No MIDI Devices Found");
        midiOutput = noMidi ? null : midiAccess.outputs.get(midiOutSelect.value);
        midiOutSelect.classList.toggle('no-midi-error', !midiOutput);
    }
    midiOutSelect.addEventListener('change', () => { requestSaveState(); });

    function sendMidiCC(cc, value, channel) {
        if (midiOutput) midiOutput.send([0xB0 + (channel - 1), cc, value]);
    }
    function sendMidiNoteOn(note, vel, ch) { if (midiOutput) midiOutput.send([0x90 + (ch - 1), note, vel]); }
    function sendMidiNoteOff(note, ch) { if (midiOutput) midiOutput.send([0x80 + (ch - 1), note, 0]); }
    function sendAllNotesOff(ch) { if (midiOutput) midiOutput.send([0xB0 + (ch - 1), 123, 0]); }

    function handleMidiMessage(event) {
        const cmd = event.data[0] & 0xF0, ch = (event.data[0] & 0x0F) + 1;
        if (cmd === 0x90 && event.data[2] > 0 && noteLearningTrack) {
            const { track, button } = noteLearningTrack;
            track.note = event.data[1];
            track.channelOverride = ch;
            track.ui.noteInput.value = Tone.Frequency(track.note, "midi").toNote();
            track.ui.channelOverrideSelect.value = ch;
            button.classList.remove('learning');
            button.textContent = 'Learn';
            showStatusMessage(`Track ${track.id + 1} set to Note: ${track.ui.noteInput.value} on Ch: ${ch}.`);
            noteLearningTrack = null;
            requestSaveState();
            return;
        }
        if (cmd === 0xB0) {
            const cc = event.data[1], val = event.data[2];
            if (currentLearningControl) {
                const { paramId, button, originalText } = currentLearningControl;
                midiCcMap[paramId] = { cc, channel: ch };
                button.classList.remove('learning');
                button.textContent = originalText;
                showStatusMessage(`Control mapped to CC#${cc} on Ch ${ch}.`);
                currentLearningControl = null;
                requestSaveState();
            } else {
                for (const pId in midiCcMap) {
                    const map = midiCcMap[pId];
                    if (map.cc === cc && map.channel === ch) {
                        const el = document.getElementById(pId);
                        if (!el) continue;
                        const min = parseFloat(el.min) || 0;
                        const max = parseFloat(el.max) || 127;
                        const step = parseFloat(el.step) || 1;
                        const newValue = min + (((max - min) * val) / 127);
                        el.value = Math.round(newValue / step) * step;

                        el.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                }
            }
        }
    }

    function cancelAllLearnModes(notify = true) {
        if (currentLearningControl) {
            currentLearningControl.button.classList.remove('learning');
            currentLearningControl.button.textContent = currentLearningControl.originalText;
            currentLearningControl = null;
            if(notify) showStatusMessage("MIDI CC Learn cancelled.");
        }
        if (noteLearningTrack) {
            noteLearningTrack.button.classList.remove('learning');
            noteLearningTrack.button.textContent = 'Learn';
            noteLearningTrack = null;
            if(notify) showStatusMessage("Note Learn cancelled.");
        }
    }

    function startNoteLearn(track, button) {
        const wasLearning = noteLearningTrack && noteLearningTrack.track === track;
        cancelAllLearnModes(false);
        if (wasLearning) return;
        noteLearningTrack = { track, button };
        button.classList.add('learning');
        button.textContent = '...';
        showStatusMessage(`Listening for MIDI Note for Track ${track.id + 1}...`);
    }

    function startLearnCc(paramId, button) {
        const wasLearning = currentLearningControl && currentLearningControl.button === button;
        const readableParamId = paramId.replace(/([A-Z])/g, ' $1').replace(/(\d+)/g, ' Track $1').replace(/^./, str => str.toUpperCase());
        cancelAllLearnModes(false);
        if (wasLearning) return;
        currentLearningControl = { paramId, button, originalText: button.textContent };
        button.classList.add('learning');
        button.textContent = '...';
        showStatusMessage(`Listening for MIDI CC for ${readableParamId}...`);
    }

    function adjustControlValue(targetId, action) {
        const el = document.getElementById(targetId);
        if (!el) return;
        let val = parseFloat(el.value), step = parseFloat(el.step) || 1;
        const min = parseFloat(el.min), max = parseFloat(el.max);
        val += (action === 'increment' ? step : -step);
        el.value = Math.max(min, Math.min(max, val));
        el.dispatchEvent(new Event(el.id === 'numTracksInput' ? 'change' : 'input', { bubbles: true }));
    }

    document.addEventListener('mousedown', (e) => {
        const button = e.target.closest('.slider-button, .number-input-button');
        if (button) {
            startAutoRepeat(button.dataset.target, button.dataset.action);
        }
    });
    document.addEventListener('mouseup', stopAutoRepeat);
    document.addEventListener('mouseleave', stopAutoRepeat);
    document.addEventListener('touchstart', (e) => {
        const button = e.target.closest('.slider-button, .number-input-button');
        if (button) {
            e.preventDefault();
            startAutoRepeat(button.dataset.target, button.dataset.action);
        }
    }, { passive: false });
    document.addEventListener('touchend', stopAutoRepeat);

    function startAutoRepeat(target, action) { stopAutoRepeat(); adjustControlValue(target, action); autoRepeatTimeoutId = setTimeout(() => { autoRepeatIntervalId = setInterval(() => adjustControlValue(target, action), AUTO_REPEAT_INTERVAL); }, AUTO_REPEAT_DELAY); }
    function stopAutoRepeat() { clearTimeout(autoRepeatTimeoutId); clearInterval(autoRepeatIntervalId); }

    bpmSlider.addEventListener('input', (e) => {
        const newBpm = parseInt(e.target.value);
        Tone.Transport.bpm.value = newBpm;
        bpmValue.textContent = newBpm;
        requestSaveState();
    });

    masterVolumeSlider.addEventListener('input', (e) => {
        const newVolume = parseInt(e.target.value);
        masterVolumeValue.textContent = newVolume;
        for (let i = 0; i < 16; i++) {
            channelVolumes[i] = newVolume;
            const slider = document.getElementById(`channelVolume${i+1}`);
            const valueDisplay = document.getElementById(`channelVolumeValue${i+1}`);
            if(slider) slider.value = newVolume;
            if(valueDisplay) valueDisplay.textContent = newVolume;
            sendMidiCC(7, newVolume, i + 1);
        }
        requestSaveState();
    });

    function setHarmoniousRandomizationScale() {
        const scaleNames = Object.keys(SCALES);
        const randomScaleName = scaleNames[Math.floor(Math.random() * scaleNames.length)];
        const randomRootNote = Math.floor(Math.random() * 12);
        const scaleIntervals = SCALES[randomScaleName];

        currentRandomizationScale = [];
        for (let octave = 2; octave <= 5; octave++) {
            for (const interval of scaleIntervals) {
                const midiNote = 12 * octave + randomRootNote + interval;
                if (midiNote <= 127) {
                    currentRandomizationScale.push(midiNote);
                }
            }
        }
        const rootNoteName = NOTE_NAMES[randomRootNote];
        currentScaleName = `${rootNoteName} ${randomScaleName}`;
        logChange(`Scale -> ${currentScaleName}`);
        updateStatusBar();
    }

    masterRandomizeButton.addEventListener('click', () => {
        setHarmoniousRandomizationScale();
        sequencerTracks.forEach(t => t.active && randomizeTrackParameters(t));
    });

    function randomizeTrackParameters(track, options = { note: true, pulses: true, rotation: true }, shouldLog = true) {
        let changes = [];
        if (currentRandomizationScale.length === 0) {
            setHarmoniousRandomizationScale();
        }
        if (options.pulses) {
            const oldPulses = track.pulses;
            track.pulses = Math.floor(Math.random() * (track.steps * 2/3)) + 1;
            track.ui.pulsesSlider.value = track.ui.pulsesValue.textContent = track.pulses;
            flashControl(track.ui.pulsesSlider);
            changes.push(`P: ${oldPulses}→${track.pulses}`);
        }
        if (options.rotation) {
            const oldRotation = track.rotation;
            track.rotation = track.steps > 0 ? Math.floor(Math.random() * track.steps) : 0;
            track.ui.rotationSlider.value = track.ui.rotationValue.textContent = track.rotation;
            flashControl(track.ui.rotationSlider);
            changes.push(`R: ${oldRotation}→${track.rotation}`);
        }
        if (options.note) {
            const oldNote = Tone.Frequency(track.note, "midi").toNote();
            track.note = currentRandomizationScale[Math.floor(Math.random() * currentRandomizationScale.length)];
            const newNote = Tone.Frequency(track.note, "midi").toNote();
            track.ui.noteInput.value = newNote;
            flashControl(track.ui.noteInput);
            changes.push(`N: ${oldNote}→${newNote}`);
        }
        if (shouldLog && changes.length > 0) {
            logChange(`T${track.id + 1}: ${changes.join(', ')}`);
        }
        updateTrackPattern(track);
    }

    function flashControl(element) {
        element.classList.add('control-flash');
        setTimeout(() => {
            element.classList.remove('control-flash');
        }, 500);
    }

    defaultSettingsButton.addEventListener('click', async () => {
        allowAutosave = false;
        try {
            const defaults = {
                bpm: 120,
                tracks: [
                    {p:4,s:8,r:0,n:"C3", v: 100, a: true, c: 'global'},
                    {p:3,s:8,r:2,n:"E3", v: 100, a: true, c: 'global'},
                    {p:5,s:8,r:4,n:"G3", v: 100, a: true, c: 'global'},
                    {p:7,s:16,r:0,n:"B3", v: 90, a: true, c: 'global'}
                ],
                musicMode: {
                    enabled: true,
                    interval: 4,
                    randomize: { note: true, pulses: true, rotation: true, scale: true },
                    multiTrack: true
                }
            };
            const defaultState = {
                numTracks: defaults.tracks.length,
                bpm: defaults.bpm,
                tracks: defaults.tracks.map(d => ({
                    pulses: d.p, steps: d.s, rotation: d.r, note: Tone.Frequency(d.n).toMidi(),
                    velocity: d.v, active: d.a, channelOverride: d.c
                })),
                musicMode: defaults.musicMode
            };
            await applyState(defaultState, Tone.Transport.state === 'started');
            showStatusMessage("Defaults loaded.");
        } finally {
            setTimeout(() => { allowAutosave = true; }, 100);
        }
    });


    lockStepsCheckbox.addEventListener('change', (e) => {
        stepsLocked = e.target.checked;
        if (stepsLocked) {
            globalLockedSteps = sequencerTracks.length > 0 ? sequencerTracks[0].steps : 8;
            synchronizeAllTrackSteps(globalLockedSteps);
        } else {
            sequencerTracks.forEach(t => t.ui && (t.ui.stepsSlider.disabled = false));
        }
        requestSaveState();
    });

    function synchronizeAllTrackSteps(newSteps) {
        globalLockedSteps = newSteps;
        sequencerTracks.forEach(t => {
            t.steps = newSteps;
            if (!t.ui) return;
            Object.assign(t.ui.stepsSlider, { value: newSteps, disabled: stepsLocked });
            t.ui.stepsValue.textContent = newSteps;
            if (t.pulses > t.steps) { t.ui.pulsesSlider.value = t.ui.pulsesValue.textContent = t.pulses = t.steps > 0 ? t.steps : 1; }
            t.ui.stepsSlider.min = t.pulses;
            t.ui.rotationSlider.max = t.steps > 0 ? t.steps - 1 : 0;
            if (t.rotation >= t.steps) { t.ui.rotationSlider.value = t.ui.rotationValue.textContent = t.rotation = t.steps > 0 ? t.rotation % t.steps : 0; }
            updateTrackPattern(t);
        });
    }

    function createSequencerTrackUI(trackIndex) {
        let initialSteps = stepsLocked ? globalLockedSteps : 8;
        let initialPulses = Math.floor(Math.random() * initialSteps / 2) + 1;
        let initialRotation = Math.floor(Math.random() * initialSteps);

        const trackDiv = document.createElement('div');
        trackDiv.className = 'synth-panel p-2 flex flex-col disco-flash';
        trackDiv.innerHTML = `
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-sm font-semibold" style="font-family: 'Orbitron', sans-serif;">Track ${trackIndex + 1}</h3>
                <div>
                    <button id="randomizeTrack${trackIndex}" class="randomize-button" title="Randomize Pulses, Rotate, and Note">Random</button>
                    <button id="trackToggle${trackIndex}" class="push-button text-xs py-1 px-2 ml-1 active" title="Toggle this track ON or OFF">ON</button>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-x-3 gap-y-1 mb-2">
                <div class="control-group">
                    <div class="control-header">
                        <label for="pulses${trackIndex}">Pulses:</label>
                        <span id="pulsesValue${trackIndex}" class="value-display">${initialPulses}</span>
                        <button class="learn-cc-button ml-2" data-param-id="pulses${trackIndex}" title="Map Pulses to MIDI CC">L</button>
                    </div>
                    <div class="control-slider-container"><button class="slider-button" data-target="pulses${trackIndex}" data-action="decrement">&minus;</button><input type="range" id="pulses${trackIndex}" min="1" max="32" value="${initialPulses}" class="control-slider"><button class="slider-button" data-target="pulses${trackIndex}" data-action="increment">+</button></div>
                </div>
                <div class="control-group">
                    <div class="control-header">
                        <label for="steps${trackIndex}">Steps:</label>
                        <span id="stepsValue${trackIndex}" class="value-display">${initialSteps}</span>
                        <button class="learn-cc-button ml-2" data-param-id="steps${trackIndex}" title="Map Steps to MIDI CC">L</button>
                    </div>
                    <div class="control-slider-container"><button class="slider-button" data-target="steps${trackIndex}" data-action="decrement">&minus;</button><input type="range" id="steps${trackIndex}" min="1" max="32" value="${initialSteps}" class="control-slider"><button class="slider-button" data-target="steps${trackIndex}" data-action="increment">+</button></div>
                </div>
                <div class="control-group">
                    <div class="control-header">
                        <label for="rotation${trackIndex}">Rotate:</label>
                        <span id="rotationValue${trackIndex}" class="value-display">${initialRotation}</span>
                        <button class="learn-cc-button ml-2" data-param-id="rotation${trackIndex}" title="Map Rotation to MIDI CC">L</button>
                    </div>
                    <div class="control-slider-container"><button class="slider-button" data-target="rotation${trackIndex}" data-action="decrement">&minus;</button><input type="range" id="rotation${trackIndex}" min="0" max="${initialSteps-1}" value="${initialRotation}" class="control-slider"><button class="slider-button" data-target="rotation${trackIndex}" data-action="increment">+</button></div>
                </div>
                <div class="control-group">
                    <div class="control-header">
                        <label for="velocity${trackIndex}">Vel:</label>
                        <span id="velocityValue${trackIndex}" class="value-display">100</span>
                        <button class="learn-cc-button ml-2" data-param-id="velocity${trackIndex}" title="Map Velocity to MIDI CC">L</button>
                    </div>
                    <div class="control-slider-container"><button class="slider-button" data-target="velocity${trackIndex}" data-action="decrement">&minus;</button><input type="range" id="velocity${trackIndex}" min="1" max="127" value="100" class="control-slider"><button class="slider-button" data-target="velocity${trackIndex}" data-action="increment">+</button></div>
                </div>
                <div class="control-group">
                    <label for="channelOverride${trackIndex}" class="mb-1">Channel:</label>
                    <select id="channelOverride${trackIndex}" class="text-xs p-1 h-full" title="MIDI Channel Override"><option value="global">Global</option>${Array.from({length:16},(_,i)=>`<option value="${i+1}">${i+1}</option>`).join('')}</select>
                </div>
                <div class="control-group">
                    <label for="note${trackIndex}" class="mb-1">Note:</label>
                    <div class="note-input-group"><input type="text" id="note${trackIndex}" value="C3" class="text-xs p-1"><button id="noteLearn${trackIndex}" class="note-learn-button">L</button></div>
                </div>
            </div>
            <div id="patternDisplay${trackIndex}" class="pattern-display my-1"></div>
        `;
        sequencerTracksContainer.appendChild(trackDiv);

        const track = {
            id: trackIndex, active: true, pulses: initialPulses, steps: initialSteps, rotation: initialRotation,
            note: Tone.Frequency("C3").toMidi(), velocity: 100, channelOverride: 'global',
            pattern: [], currentStep: 0,
            ui: {
                panel: trackDiv,
                toggleButton: document.getElementById(`trackToggle${trackIndex}`),
                randomizeButton: document.getElementById(`randomizeTrack${trackIndex}`),
                pulsesSlider: document.getElementById(`pulses${trackIndex}`), pulsesValue: document.getElementById(`pulsesValue${trackIndex}`),
                stepsSlider: document.getElementById(`steps${trackIndex}`), stepsValue: document.getElementById(`stepsValue${trackIndex}`),
                rotationSlider: document.getElementById(`rotation${trackIndex}`), rotationValue: document.getElementById(`rotationValue${trackIndex}`),
                noteInput: document.getElementById(`note${trackIndex}`), noteLearnButton: document.getElementById(`noteLearn${trackIndex}`),
                velocitySlider: document.getElementById(`velocity${trackIndex}`), velocityValue: document.getElementById(`velocityValue${trackIndex}`),
                channelOverrideSelect: document.getElementById(`channelOverride${trackIndex}`),
                patternDisplay: document.getElementById(`patternDisplay${trackIndex}`),
            }
        };

        if (currentRandomizationScale.length > 0) {
            track.note = currentRandomizationScale[Math.floor(Math.random() * currentRandomizationScale.length)];
        } else {
            track.note = 48 + Math.floor(Math.random() * 24); // C3 to B4
        }
        track.ui.noteInput.value = Tone.Frequency(track.note, "midi").toNote();

        track.ui.randomizeButton.addEventListener('click', () => {randomizeTrackParameters(track); requestSaveState()});
        track.ui.toggleButton.addEventListener('click', () => {
            track.active = !track.active;
            track.ui.toggleButton.classList.toggle('active', track.active);
            track.ui.toggleButton.textContent = track.active ? 'ON' : 'OFF';
            if (!track.active) {
                const ch = (track.channelOverride !== 'global') ? track.channelOverride : selectedMidiChannel;
                sendMidiNoteOff(track.note, ch);
            }
            requestSaveState();
        });
        track.ui.pulsesSlider.addEventListener('input', e => {
            track.pulses = parseInt(e.target.value);
            track.ui.pulsesValue.textContent = track.pulses;
            track.ui.stepsSlider.min = track.pulses;
            updateTrackPattern(track);
            requestSaveState();
        });
        track.ui.stepsSlider.addEventListener('input', e => {
            const newSteps = parseInt(e.target.value);
            if (stepsLocked) synchronizeAllTrackSteps(newSteps);
            else {
                track.steps = newSteps;
                if (track.steps < track.pulses) track.steps = e.target.value = track.pulses;
                track.ui.stepsValue.textContent = track.steps;
                track.ui.rotationSlider.max = track.steps > 0 ? track.steps - 1 : 0;
                if (track.rotation >= track.steps) track.ui.rotationSlider.value = track.ui.rotationValue.textContent = track.rotation = 0;
                updateTrackPattern(track);
            }
            requestSaveState();
        });
        track.ui.rotationSlider.addEventListener('input', e => {
            track.rotation = parseInt(e.target.value);
            track.ui.rotationValue.textContent = track.rotation;
            updateTrackPattern(track);
            requestSaveState();
        });
        track.ui.noteInput.addEventListener('change', e => {
            try { track.note = Tone.Frequency(e.target.value.toUpperCase()).toMidi(); }
            catch { e.target.value = Tone.Frequency(track.note, "midi").toNote(); }
            requestSaveState();
        });
        track.ui.velocitySlider.addEventListener('input', e => {
            track.velocity = parseInt(e.target.value);
            track.ui.velocityValue.textContent = track.velocity;
            requestSaveState();
        });
        track.ui.noteLearnButton.addEventListener('click', () => startNoteLearn(track, track.ui.noteLearnButton));
        track.ui.channelOverrideSelect.addEventListener('change', e => {
            track.channelOverride = e.target.value;
            requestSaveState();
        });

        trackDiv.querySelectorAll('.learn-cc-button').forEach(btn => {
            btn.textContent = 'L';
            btn.addEventListener('click', () => startLearnCc(btn.dataset.paramId, btn))
        });
        sequencerTracks.push(track);
    }

    function createChannelVolumeUI() {
        channelVolumesContainer.innerHTML = '';
        for(let i=1; i<=16; i++) {
            const volDiv = document.createElement('div');
            volDiv.className = 'control-group';
            volDiv.innerHTML = `
                 <div class="control-header">
                     <label for="channelVolume${i}">Ch ${i}:</label>
                     <span id="channelVolumeValue${i}" class="value-display">${channelVolumes[i-1]}</span>
                     <button class="learn-cc-button ml-2" data-param-id="channelVolume${i}">L</button>
                 </div>
                 <div class="control-slider-container">
                     <input type="range" id="channelVolume${i}" min="0" max="127" value="${channelVolumes[i-1]}" class="control-slider">
                 </div>
            `;
            channelVolumesContainer.appendChild(volDiv);

            const slider = volDiv.querySelector(`#channelVolume${i}`);
            const valueDisplay = volDiv.querySelector(`#channelVolumeValue${i}`);
            const learnBtn = volDiv.querySelector('.learn-cc-button');

            slider.addEventListener('input', e => {
                const newVolume = parseInt(e.target.value);
                valueDisplay.textContent = newVolume;
                channelVolumes[i-1] = newVolume;
                sendMidiCC(7, newVolume, i);
                requestSaveState();
            });
            learnBtn.addEventListener('click', () => startLearnCc(`channelVolume${i}`, learnBtn));
        }
    }

    function updateTrackPattern(track) {
        track.pattern = generateEuclideanPattern(track.pulses, track.steps);
        track.pattern = rotatePattern(track.pattern, track.rotation);
        track.currentStep = 0;
        renderPatternDisplay(track);
        setupTrackLoop(track);
    }

    function renderPatternDisplay(track) {
        if (!track || !track.ui.patternDisplay) return;
        track.ui.patternDisplay.innerHTML = '';
        if (track.steps === 0 || !track.pattern) return;
        for (let i = 0; i < track.steps; i++) {
            const step = document.createElement('div');
            step.className = 'pattern-step';
            if (track.pattern[i] === 1) step.classList.add('active');
            if (i === track.currentStep && Tone.Transport.state === "started" && track.active) step.classList.add('current');
            track.ui.patternDisplay.appendChild(step);
        }
    }

    function setupTrackLoop(track) {
        if (transportLoops[track.id]) {
            transportLoops[track.id].stop(0).dispose();
            transportLoops[track.id] = null;
        }
        if (track.steps === 0 || !track.pattern.length) { renderPatternDisplay(track); return; }

        transportLoops[track.id] = new Tone.Sequence((time, value) => {
            const ch = (track.channelOverride !== 'global') ? parseInt(track.channelOverride) : selectedMidiChannel;
            if (track.active && value === 1) {
                sendMidiNoteOn(track.note, track.velocity, ch);
                addNoteToHistory(Tone.Frequency(track.note, "midi").toNote());

                Tone.Transport.scheduleOnce(() => {
                    sendMidiNoteOff(track.note, ch);
                }, time + Tone.Time("16n").toSeconds() * 0.8);

                Tone.Draw.schedule(() => {
                    const panel = track.ui.panel;
                    if (!panel) return;
                    panel.style.backgroundColor = `hsl(${Math.random() * 360}, 70%, 85%)`; // Pastel colors
                    setTimeout(() => { panel.style.backgroundColor = ''; }, 90);
                }, time);
            }
            Tone.Draw.schedule(() => {
                track.currentStep = (track.currentStep + 1) % track.steps;
                renderPatternDisplay(track);
            }, time);
        }, track.pattern, `${track.steps}n`);

        if (Tone.Transport.state === 'started') {
            transportLoops[track.id].start(0);
        }
    }

    function logChange(message) {
        if (logClearTimeout) clearTimeout(logClearTimeout);
        const entry = document.createElement('div');
        entry.textContent = message;
        musicModeLog.prepend(entry);
        while (musicModeLog.children.length > 6) {
            musicModeLog.removeChild(musicModeLog.lastChild);
        }
        logClearTimeout = setTimeout(() => {
            musicModeLog.innerHTML = '';
        }, 5000);
    }

    function triggerGenerativeStep() {
        const randomizeScale = randomizeScaleCheck.checked;
        if (randomizeScale) {
            setHarmoniousRandomizationScale();
        }

        const activeTracks = sequencerTracks.filter(t => t.active);
        if (activeTracks.length === 0) return;

        const options = {
            note: randomizeNoteCheck.checked,
            pulses: randomizePulsesCheck.checked,
            rotation: randomizeRotationCheck.checked
        };

        if (multiTrackRandomToggle.checked) {
            if (!randomizeScale) {
                logChange("Multi-track randomize");
            }
            activeTracks.forEach(track => randomizeTrackParameters(track, options, false));
        } else {
            const trackToRandomize = activeTracks[Math.floor(Math.random() * activeTracks.length)];
            randomizeTrackParameters(trackToRandomize, options, true);
        }
        requestSaveState();
    }

    function setupTimedRandomization() {
        if (timedRandomEvent) {
            Tone.Transport.clear(timedRandomEvent);
            timedRandomEvent = null;
        }
        if (musicModeToggle.checked) {
            const interval = `${randomIntervalSlider.value}m`;
            timedRandomEvent = Tone.Transport.scheduleRepeat((time) => {
                Tone.Draw.schedule(() => {
                    triggerGenerativeStep();
                }, time);
            }, interval, "1m");
        }
    }

    musicModeToggle.addEventListener('change', (e) => {
        document.body.classList.toggle('music-mode-active', e.target.checked);
        if (e.target.checked) {
            randomizeNoteCheck.checked = true;
            randomizePulsesCheck.checked = true;
            randomizeRotationCheck.checked = true;
            randomizeScaleCheck.checked = true;
            multiTrackRandomToggle.checked = true;
        }
        setupTimedRandomization();
        requestSaveState();
    });

    randomIntervalSlider.addEventListener('input', e => {
        randomIntervalValue.textContent = e.target.value;
    });
    randomIntervalSlider.addEventListener('change', ()=> {setupTimedRandomization(); requestSaveState();});
    musicModeNextButton.addEventListener('click', triggerGenerativeStep);

    [randomizeNoteCheck, randomizePulsesCheck, randomizeRotationCheck, randomizeScaleCheck, multiTrackRandomToggle].forEach(el => {
        el.addEventListener('change', requestSaveState);
    });

    Tone.Transport.on('start', () => {
        sequencerWrapperPanel.classList.remove('stopped');
        playStopButton.innerHTML = '&#x25A0;';
        playStopButton.classList.add('active', 'stop-state');
        playStopButton.classList.remove('play-state');
        transportLoops.forEach(loop => loop && loop.start(0));
    });

    Tone.Transport.on('stop', () => {
        sequencerWrapperPanel.classList.add('stopped');
        playStopButton.innerHTML = '&#x25B6;';
        playStopButton.classList.remove('active', 'stop-state');
        playStopButton.classList.add('play-state');

        const allChannelsInUse = new Set([selectedMidiChannel]);
        sequencerTracks.forEach(t => {
            const ch = (t.channelOverride !== 'global') ? parseInt(t.channelOverride) : selectedMidiChannel;
            sendMidiNoteOff(t.note, ch);
            if (t.channelOverride !== 'global') {
                allChannelsInUse.add(parseInt(t.channelOverride));
            }
        });
        allChannelsInUse.forEach(ch => sendAllNotesOff(ch));
        sequencerTracks.forEach(t => { t.currentStep = 0; renderPatternDisplay(t); });
        transportLoops.forEach(loop => loop && loop.stop(0));
    });


    function updateTrackCount(newCount) {
        const oldCount = numTracks;

        if (newCount > oldCount) {
            for (let i = oldCount; i < newCount; i++) {
                createSequencerTrackUI(i);
                updateTrackPattern(sequencerTracks[i]);
            }
        } else if (newCount < oldCount) {
            for (let i = oldCount - 1; i >= newCount; i--) {
                const trackToRemove = sequencerTracks[i];
                if (trackToRemove && trackToRemove.ui && trackToRemove.ui.panel) {
                    trackToRemove.ui.panel.remove();
                }
                if (transportLoops[i]) {
                    transportLoops[i].stop(0).dispose();
                }
            }
            sequencerTracks.length = newCount;
            transportLoops.length = newCount;
        }

        numTracks = newCount;
        requestSaveState();
    }


    numTracksInput.addEventListener('change', (e) => {
        let count = Math.max(1, Math.min(MAX_TRACKS, parseInt(e.target.value) || numTracks));
        e.target.value = count;
        if (count !== numTracks) {
            updateTrackCount(count);
        }
    });

    playStopButton.addEventListener('click', async () => {
        if (Tone.context.state !== 'running') {
            await Tone.start();
            showStatusMessage("Audio Context Started.");
        }

        if (Tone.Transport.state === 'started') {
            Tone.Transport.stop();
        } else {
            sequencerTracks.forEach(t => setupTrackLoop(t));
            Tone.Transport.start();
        }
    });

    midiChannelSelect.addEventListener('change', e => {
        selectedMidiChannel = parseInt(e.target.value);
        requestSaveState();
    });

    saveStateButton.addEventListener('click', ()=>{
        saveState();
        showStatusMessage("State Saved!", 2000);
    });
    loadStateButton.addEventListener('click', loadStateAndRebuild);

    for (let i = 1; i <= 16; i++) midiChannelSelect.add(new Option(`Ch ${i}`, i));

    async function init() {
        userIdDisplay.textContent = crypto.randomUUID().substring(0,8);
        playStopButton.classList.add('play-state');
        const savedStateJSON = localStorage.getItem(STATE_STORAGE_KEY);

        let isFirstLoad = !savedStateJSON;

        if (!isFirstLoad) {
            await applyState(JSON.parse(savedStateJSON), false);
        } else {
            setHarmoniousRandomizationScale(); // Set an initial scale
            await applyState({}, false);
            await defaultSettingsButton.click();
        }

        await setupMIDI();

        sequencerWrapperPanel.classList.add('stopped');
        showStatusMessage("Rhythm King 77 Initialized!", 3000);
        setInterval(showHelpfulMessage, 15000); // Start showing helpful tips
    }
    window.onload = init;
</script>
</body>
</html>
