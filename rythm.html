<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rhythm King 77 - Websynth (MIDI Only)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #3a3a3a;
            color: #f0e6d2;
            overscroll-behavior: none;
            font-size: 13px;
        }
        .synth-panel {
            background-color: #5a4a3a;
            border: 2px solid #7a6a5a;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5), inset 0 2px 4px rgba(255,255,255,0.1);
            padding: 0.5rem;
            margin-bottom: 0.75rem;
            transition: opacity 0.4s ease-in-out;
        }
        .control-slider-container {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        .number-input-container {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        .slider-button, .number-input-button {
            background-color: #7a6a5a;
            color: #f0e6d2;
            border: 1px solid #5a4a3a;
            border-radius: 4px;
            padding: 0.1rem 0.3rem;
            font-size: 0.8rem;
            font-weight: bold;
            line-height: 1;
            cursor: pointer;
            user-select: none;
        }
        .slider-button:hover, .number-input-button:hover {
            background-color: #9a8a7a;
        }

        .control-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 17.5px;
            background: #4a3a2a;
            border-radius: 8.75px;
            border: 1px solid #3a2a1a;
            outline: none;
            cursor: pointer;
            flex-grow: 1;
        }
        .control-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 30px;
            height: 30px;
            background: #c0b090;
            border-radius: 6.25px;
            border: 2px solid #3a2a1a;
            cursor: grab;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .control-slider::-moz-range-thumb {
            width: 30px;
            height: 30px;
            background: #c0b090;
            border-radius: 6.25px;
            border: 2px solid #3a2a1a;
            cursor: grab;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .master-control-panel .control-slider {
            height: 30px;
        }
        .master-control-panel .control-slider::-webkit-slider-thumb {
            width: 37.5px;
            height: 37.5px;
        }
        .master-control-panel .control-slider::-moz-range-thumb {
            width: 37.5px;
            height: 37.5px;
        }
        .push-button {
            font-family: 'Orbitron', sans-serif;
            background-color: #7a6a5a;
            color: #f0e6d2;
            border: 2px solid #5a4a3a;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            text-transform: uppercase;
            font-weight: bold;
            font-size: 0.75rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3), inset 0 1px 1px rgba(255,255,255,0.2);
            transition: all 0.1s ease-in-out;
        }
        .push-button:active, .push-button.active {
            background-color: #9a8a7a;
            box-shadow: 0 1px 2px rgba(0,0,0,0.4), inset 0 2px 3px rgba(0,0,0,0.2);
            transform: translateY(1px);
        }
        .learn-cc-button, .note-learn-button, .randomize-button, .default-settings-button, .master-randomize-button, .re-init-midi-button {
            color: white;
            padding: 0.15rem 0.35rem;
            font-size: 0.6rem;
            border-radius: 3px;
        }
        .learn-cc-button { background-color: #4CAF50; flex-shrink: 0; }
        .note-learn-button { background-color: #f44336; }
        .randomize-button { background-color: #2196F3; }
        .default-settings-button { background-color: #607D8B; }
        .master-randomize-button { background-color: #FFC107; color: #333; }
        .re-init-midi-button { background-color: #9C27B0; }
        .learn-cc-button.learning, .note-learn-button.learning { background-color: #FF9800; }

        .pattern-display {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 0.2rem;
            height: 24px;
        }
        .pattern-step {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #7a6a5a;
            margin: 0 1.5px;
            transition: background-color 0.1s;
        }
        .pattern-step.active { background-color: #f0ad4e; }
        .pattern-step.current {
            transform: scale(1.25);
            box-shadow: 0 0 5px #f0ad4e;
        }
        label {
            display: block;
            margin-bottom: 0.1rem;
            font-size: 0.65rem;
            text-transform: uppercase;
            font-family: 'Orbitron', sans-serif;
            white-space: nowrap;
            margin-right: 0.5rem;
        }
        select, input[type="number"] {
            background-color: #4a3a2a;
            border: 1px solid #7a6a5a;
            color: #f0e6d2;
            padding: 0.3rem;
            border-radius: 5px;
            width: 100%;
            font-size: 0.75rem;
        }
        .master-control-panel select, .master-control-panel input[type="number"] {
            padding: 0.6rem 0.3rem;
        }
        .master-control-panel .number-input-container input[type="number"] {
            padding: 0.3rem;
            text-align: center;
            flex-grow: 1;
        }

        input[type="text"] {
            background-color: #4a3a2a;
            border: 1px solid #7a6a5a;
            color: #f0e6d2;
            padding: 0.3rem;
            border-radius: 5px;
            width: 100%;
            font-size: 0.75rem;
        }
        .value-display {
            font-family: 'Orbitron', sans-serif;
            color: #f0ad4e;
            font-size: 0.75rem;
            min-width: 25px;
            text-align: right;
            flex-grow: 1;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 0.2rem;
        }
        .control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.1rem;
        }
        .checkbox-label-container {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.7rem;
            margin-top: 0.2rem;
            cursor: pointer;
        }
        .checkbox-label-container input[type="checkbox"] {
            width: 12px;
            height: 12px;
            accent-color: #f0ad4e;
        }

        #sequencerTracksContainer {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 0.75rem;
        }
        #sequencerTracksContainer.stopped .synth-panel {
            opacity: 0.65;
        }
        @media (min-width: 1400px) {
            #sequencerTracksContainer {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        #sequencerTracksContainer > .synth-panel {
            margin-bottom: 0;
        }
        #statusBar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #2a2a2a;
            color: #f0e6d2;
            padding: 0.5rem;
            text-align: center;
            font-size: 0.8rem;
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none;
        }
        #statusBar.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .explanation-text-footer {
            font-size: 0.75rem;
            line-height: 1.4;
            color: #c0b090;
            text-align: center;
            padding: 1rem 0.5rem;
            max-width: 600px;
            margin: 1rem auto 0 auto;
        }
        .note-input-group {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .note-input-group > input {
            flex-grow: 1;
        }
        .disco-flash {
            transition: background-color 0.05s ease-in-out !important;
        }
    </style>
</head>
<body class="p-1 md:p-2 pb-12">

<header class="text-center mb-3">
    <h1 class="text-2xl md:text-3xl font-bold" style="font-family: 'Orbitron', sans-serif; color: #f0ad4e;">Rhythm King 77</h1>
    <p class="text-xs md:text-sm">Euclidean MIDI Sequencer</p>
</header>

<div class="flex flex-col xl:flex-row gap-3">
    <div class="flex flex-col md:flex-row xl:flex-col gap-3">
        <!-- Global Controls & MIDI Settings Panel -->
        <div class="md:flex-none md:max-w-xs synth-panel flex flex-col gap-2 master-control-panel">
            <h2 class="text-base font-semibold mb-1 text-center" style="font-family: 'Orbitron', sans-serif;">Master Control</h2>

            <button id="playStopButton" class="push-button w-full" title="Start or stop all sequences">Play</button>
            <div class="flex gap-1 mt-1">
                <button id="defaultSettingsButton" class="push-button w-1/2 default-settings-button" title="Load default patterns for all tracks">Defaults</button>
                <button id="masterRandomizeButton" class="push-button w-1/2 master-randomize-button" title="Randomize all active tracks">Rnd All</button>
            </div>
            <button id="reInitMidiButton" class="push-button w-full mt-1 re-init-midi-button" title="Re-initialize MIDI devices and send All Notes Off">Re-Init MIDI</button>

            <div class="control-group">
                <div><label for="numTracksInput">Number of Tracks:</label></div>
                <div class="number-input-container">
                    <button class="number-input-button" data-target="numTracksInput" data-action="decrement" title="Decrease number of tracks">-</button>
                    <input type="number" id="numTracksInput" min="1" max="8" value="4" title="Set number of sequencer tracks (1-8)">
                    <button class="number-input-button" data-target="numTracksInput" data-action="increment" title="Increase number of tracks">+</button>
                </div>
            </div>

            <div class="control-group">
                <label class="checkbox-label-container" title="When checked, all tracks share the same 'Steps' value">
                    <input type="checkbox" id="lockStepsCheckbox"> Lock All Steps
                </label>
            </div>

            <div class="control-group">
                <div class="control-header">
                    <label for="bpmSlider">Tempo:</label>
                    <span id="bpmValue" class="value-display">120</span>
                    <button id="bpmSliderLearnCc" class="learn-cc-button ml-2" data-param-id="bpmSlider" title="Map Master Tempo to a MIDI CC">Learn</button>
                </div>
                <div class="control-slider-container">
                    <button class="slider-button" data-target="bpmSlider" data-action="decrement" title="Decrease Tempo">-</button>
                    <input type="range" id="bpmSlider" min="20" max="240" value="120" class="control-slider" title="Adjust master tempo (20-240 BPM)">
                    <button class="slider-button" data-target="bpmSlider" data-action="increment" title="Increase Tempo">+</button>
                </div>
            </div>

            <div class="control-group">
                <div class="control-header">
                    <label for="masterVolumeSlider">Volume:</label>
                    <span id="masterVolumeValue" class="value-display">100</span>
                    <button id="masterVolumeLearnCc" class="learn-cc-button ml-2" data-param-id="masterVolumeSlider" title="Map Master Volume to MIDI CC #7">Learn</button>
                </div>
                <div class="control-slider-container">
                    <button class="slider-button" data-target="masterVolumeSlider" data-action="decrement" title="Decrease Volume">-</button>
                    <input type="range" id="masterVolumeSlider" min="0" max="127" value="100" class="control-slider" title="Adjust master volume (MIDI CC #7)">
                    <button class="slider-button" data-target="masterVolumeSlider" data-action="increment" title="Increase Volume">+</button>
                </div>
            </div>

            <div class="control-group">
                <label for="midiOutSelect">MIDI Output:</label>
                <select id="midiOutSelect" title="Select MIDI output device">
                    <option value="">No MIDI Devices Found</option>
                </select>
            </div>
            <div class="control-group">
                <label for="midiChannelSelect">Global MIDI Ch:</label>
                <select id="midiChannelSelect" title="Select global MIDI channel (1-16)">
                    <!-- Options 1-16 will be populated by JS -->
                </select>
            </div>
            <div class="mt-auto pt-1">
                <p class="text-xs text-center">User ID: <span id="userIdDisplay" class="font-mono"></span></p>
            </div>
        </div>

        <!-- Channel Volumes Panel -->
        <div class="flex-grow synth-panel">
            <h2 class="text-base font-semibold mb-2 text-center" style="font-family: 'Orbitron', sans-serif;">Channel Volumes</h2>
            <div id="channelVolumesContainer" class="grid grid-cols-2 md:grid-cols-4 xl:grid-cols-2 gap-x-3 gap-y-1">
                <!-- Channel volumes will be generated here -->
            </div>
        </div>
    </div>


    <!-- Sequencer Tracks Panel -->
    <div class="flex-grow synth-panel">
        <h2 class="text-base font-semibold mb-2 text-center" style="font-family: 'Orbitron', sans-serif;">Euclidean Sequencer</h2>
        <div id="sequencerTracksContainer" class="stopped">
            <!-- Tracks will be generated here by JS -->
        </div>
    </div>
</div>

<div id="explanationContainer" class="explanation-text-footer">
    <p>
        Euclidean rhythms are musical rhythms generated by distributing a number of beats (pulses) as evenly as possible over a set number of time steps.
        This creates natural-sounding, often complex polyrhythms found in various world music traditions.
    </p>
</div>
<div id="statusBar">Status Message Here</div>

<script>
    // --- DOM Elements ---
    const playStopButton = document.getElementById('playStopButton');
    const defaultSettingsButton = document.getElementById('defaultSettingsButton');
    const masterRandomizeButton = document.getElementById('masterRandomizeButton');
    const reInitMidiButton = document.getElementById('reInitMidiButton');
    const numTracksInput = document.getElementById('numTracksInput');
    const lockStepsCheckbox = document.getElementById('lockStepsCheckbox');
    const bpmSlider = document.getElementById('bpmSlider');
    const bpmValue = document.getElementById('bpmValue');
    const bpmSliderLearnCc = document.getElementById('bpmSliderLearnCc');
    const masterVolumeSlider = document.getElementById('masterVolumeSlider');
    const masterVolumeValue = document.getElementById('masterVolumeValue');
    const masterVolumeLearnCc = document.getElementById('masterVolumeLearnCc');
    const midiOutSelect = document.getElementById('midiOutSelect');
    const midiChannelSelect = document.getElementById('midiChannelSelect');
    const sequencerTracksContainer = document.getElementById('sequencerTracksContainer');
    const channelVolumesContainer = document.getElementById('channelVolumesContainer');
    const userIdDisplay = document.getElementById('userIdDisplay');
    const statusBar = document.getElementById('statusBar');

    let midiAccess = null;
    let midiOutput = null;
    let selectedMidiChannel = 1;
    let numTracks = 4;
    const MAX_TRACKS = 8;
    let sequencerTracks = [];
    let transportLoops = [];
    let currentLearningControl = null;
    let noteLearningTrack = null;
    let midiCcMap = {};
    const SETTINGS_KEY = 'rhythmKing77Settings_v10'; // Incremented version
    let statusTimeout = null;
    let stepsLocked = false;
    let globalLockedSteps = 16;
    let currentRandomizationScale = [];
    let channelVolumes = new Array(16).fill(100);

    // --- Harmony Engine ---
    const SCALES = {
        'Major': [0, 2, 4, 5, 7, 9, 11], 'Minor': [0, 2, 3, 5, 7, 8, 10],
        'Dorian': [0, 2, 3, 5, 7, 9, 10], 'Phrygian': [0, 1, 3, 5, 7, 8, 10],
        'Lydian': [0, 2, 4, 6, 7, 9, 11], 'Mixolydian': [0, 2, 4, 5, 7, 9, 10],
        'Locrian': [0, 1, 3, 5, 6, 8, 10], 'Major Pentatonic': [0, 2, 4, 7, 9],
        'Minor Pentatonic': [0, 3, 5, 7, 10], 'Blues': [0, 3, 5, 6, 7, 10],
        'Harmonic Minor': [0, 2, 3, 5, 7, 8, 11]
    };
    const NOTE_NAMES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];


    let autoRepeatTimeoutId = null;
    let autoRepeatIntervalId = null;
    const AUTO_REPEAT_DELAY = 500;
    const AUTO_REPEAT_INTERVAL = 100;

    function showStatusMessage(message, duration = 3000) {
        statusBar.textContent = message;
        statusBar.classList.add('visible');
        if (statusTimeout) clearTimeout(statusTimeout);
        statusTimeout = setTimeout(() => {
            statusBar.classList.remove('visible');
        }, duration);
    }

    function generateEuclideanPattern(pulses, steps) {
        if (pulses > steps || pulses <= 0 || steps <= 0) return Array(steps).fill(0);
        let groups = [];
        for (let i = 0; i < steps; i++) groups.push(i < pulses ? [1] : [0]);
        let remainder = pulses, divisor = steps - pulses;
        while (true) {
            if (divisor === 0 || remainder === 0) break;
            if (divisor > remainder) {
                [remainder, divisor] = [divisor, remainder];
                let ones = [], zeros = [];
                groups.forEach(g => (g[0] === 1 ? ones : zeros).push(g));
                groups = zeros.concat(ones);
            }
            if (remainder === 0) break;
            for (let i = 0; i < divisor; i++) {
                if (groups[i] && groups[remainder + i]) groups[i].push(...groups[remainder + i]);
                else break;
            }
            groups.splice(remainder, divisor);
            remainder -= divisor;
        }
        let pattern = [].concat(...groups);
        if (pattern.length !== steps) pattern = pattern.length < steps ? pattern.concat(Array(steps - pattern.length).fill(0)) : pattern.slice(0, steps);
        return pattern;
    }

    function rotatePattern(pattern, rotation) {
        const len = pattern.length;
        if (len === 0) return [];
        const r = ((rotation % len) + len) % len;
        return pattern.slice(r).concat(pattern.slice(0, r));
    }

    function saveSettings() {
        const settings = {
            numTracks: numTracks,
            bpm: parseInt(bpmSlider.value),
            masterVolume: parseInt(masterVolumeSlider.value),
            channelVolumes: channelVolumes,
            midiOutputId: midiOutput ? midiOutput.id : null,
            globalMidiChannel: selectedMidiChannel,
            stepsLocked: stepsLocked,
            globalLockedSteps: globalLockedSteps,
            tracks: sequencerTracks.map(t => ({
                pulses: t.pulses, steps: t.steps, rotation: t.rotation, note: t.note,
                velocity: t.velocity, active: t.active, channelOverride: t.channelOverride
            })),
            midiCcMap: midiCcMap
        };
        try { localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings)); }
        catch (e) { showStatusMessage("Error saving settings.", 5000); }
    }

    function loadSettings() {
        const saved = localStorage.getItem(SETTINGS_KEY);
        if (saved) {
            try {
                const s = JSON.parse(saved);
                if (s.numTracks !== undefined && s.numTracks > 0) numTracks = s.numTracks;
                if (s.bpm !== undefined) bpmSlider.value = s.bpm;
                if (s.masterVolume !== undefined) masterVolumeSlider.value = s.masterVolume;
                if (s.channelVolumes && s.channelVolumes.length === 16) channelVolumes = s.channelVolumes;
                if (s.globalMidiChannel !== undefined) selectedMidiChannel = s.globalMidiChannel;
                if (s.stepsLocked !== undefined) stepsLocked = s.stepsLocked;
                if (s.globalLockedSteps !== undefined) globalLockedSteps = s.globalLockedSteps;
                if (s.midiCcMap) midiCcMap = s.midiCcMap;
                return s;
            } catch (e) {
                localStorage.removeItem(SETTINGS_KEY);
                showStatusMessage("Corrupted settings cleared.", 5000);
            }
        }
        return null;
    }

    async function setupMIDI() {
        try {
            if (!navigator.requestMIDIAccess) { showStatusMessage('Web MIDI API not supported.'); return; }
            if (midiAccess) midiAccess.inputs.forEach(i => i.onmidimessage = null);
            midiAccess = await navigator.requestMIDIAccess({ sysex: false });
            populateMidiDeviceList();
            midiAccess.addEventListener('statechange', populateMidiDeviceList);
            midiAccess.inputs.forEach(i => i.onmidimessage = handleMidiMessage);
            showStatusMessage("MIDI re-initialized.", 2000);
        } catch (err) { showStatusMessage('MIDI Access Denied/Not Supported.'); }
    }

    reInitMidiButton.addEventListener('click', async () => {
        showStatusMessage("Re-initializing MIDI...", 1500);
        if (midiOutput) for (let i = 1; i <= 16; i++) sendAllNotesOff(i);
        if (Tone.Transport.state === 'started') playStopButton.click();
        Tone.Transport.cancel(0);
        transportLoops.forEach(l => l && l.stop(0).dispose());
        transportLoops = [];
        sequencerTracks.forEach(t => { t.currentStep = 0; t.stepCounterForUI = 0; renderPatternDisplay(t); });
        await setupMIDI();
    });

    function populateMidiDeviceList() {
        if (!midiAccess) return;
        const saved = JSON.parse(localStorage.getItem(SETTINGS_KEY) || '{}');
        const prefId = saved.midiOutputId || (midiOutput ? midiOutput.id : null);
        midiOutSelect.innerHTML = '';
        let count = 0, firstOut = null, foundPref = false;
        midiAccess.outputs.forEach(out => {
            const opt = new Option(out.name, out.id);
            midiOutSelect.add(opt);
            if (!firstOut) firstOut = out;
            if (out.id === prefId) foundPref = true;
            count++;
        });
        if (count === 0) midiOutSelect.add(new Option("No MIDI Devices Found", ""));
        else midiOutSelect.value = (foundPref && prefId) ? prefId : (firstOut ? firstOut.id : '');
        updateMidiOutput();
    }

    function updateMidiOutput() {
        midiOutput = (!midiAccess || !midiOutSelect.value) ? null : midiAccess.outputs.get(midiOutSelect.value);
    }
    midiOutSelect.addEventListener('change', () => { updateMidiOutput(); saveSettings(); });

    function sendMidiCC(cc, value, channel) {
        if (midiOutput) midiOutput.send([0xB0 + (channel - 1), cc, value]);
    }
    function sendMidiNoteOn(note, vel, ch) { if (midiOutput) midiOutput.send([0x90 + (ch - 1), note, vel]); }
    function sendMidiNoteOff(note, ch) { if (midiOutput) midiOutput.send([0x80 + (ch - 1), note, 0]); }
    function sendAllNotesOff(ch) { if (midiOutput) midiOutput.send([0xB0 + (ch - 1), 123, 0]); }

    function handleMidiMessage(event) {
        const cmd = event.data[0] & 0xF0, ch = (event.data[0] & 0x0F) + 1;
        if (cmd === 0x90 && event.data[2] > 0 && noteLearningTrack) {
            const { track, button } = noteLearningTrack;
            track.note = event.data[1];
            track.channelOverride = ch;
            track.ui.noteInput.value = Tone.Frequency(track.note, "midi").toNote();
            track.ui.channelOverrideSelect.value = ch;
            button.classList.remove('learning');
            button.textContent = 'Learn';
            showStatusMessage(`Track ${track.id + 1} set to Note: ${track.ui.noteInput.value} on Ch: ${ch}.`);
            noteLearningTrack = null;
            saveSettings();
            return;
        }
        if (cmd === 0xB0) {
            const cc = event.data[1], val = event.data[2];
            if (currentLearningControl) {
                const { paramId, button, originalText } = currentLearningControl;
                midiCcMap[paramId] = { cc, channel: ch };
                button.classList.remove('learning');
                button.textContent = originalText;
                showStatusMessage(`Control mapped to CC#${cc} on Ch ${ch}.`);
                currentLearningControl = null;
                saveSettings();
            } else {
                for (const pId in midiCcMap) {
                    const map = midiCcMap[pId];
                    if (map.cc === cc && map.channel === ch) {
                        const el = document.getElementById(pId);
                        if (!el) continue;
                        const min = parseFloat(el.min) || 0;
                        const max = parseFloat(el.max) || 127;
                        const step = parseFloat(el.step) || 1;
                        const newValue = min + (((max - min) * val) / 127);
                        el.value = Math.round(newValue / step) * step;

                        el.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                }
            }
        }
    }

    function cancelAllLearnModes(notify = true) {
        if (currentLearningControl) {
            currentLearningControl.button.classList.remove('learning');
            currentLearningControl.button.textContent = currentLearningControl.originalText;
            currentLearningControl = null;
            if(notify) showStatusMessage("MIDI CC Learn cancelled.");
        }
        if (noteLearningTrack) {
            noteLearningTrack.button.classList.remove('learning');
            noteLearningTrack.button.textContent = 'Learn';
            noteLearningTrack = null;
            if(notify) showStatusMessage("Note Learn cancelled.");
        }
    }

    function startNoteLearn(track, button) {
        const wasLearning = noteLearningTrack && noteLearningTrack.track === track;
        cancelAllLearnModes(false);
        if (wasLearning) return;
        noteLearningTrack = { track, button };
        button.classList.add('learning');
        button.textContent = '...';
        showStatusMessage(`Listening for MIDI Note for Track ${track.id + 1}...`);
    }

    function startLearnCc(paramId, button) {
        const wasLearning = currentLearningControl && currentLearningControl.button === button;
        const readableParamId = paramId.replace(/([A-Z])/g, ' $1').replace(/(\d+)/g, ' Track $1').replace(/^./, str => str.toUpperCase());
        cancelAllLearnModes(false);
        if (wasLearning) return;
        currentLearningControl = { paramId, button, originalText: button.textContent };
        button.classList.add('learning');
        button.textContent = '...';
        showStatusMessage(`Listening for MIDI CC for ${readableParamId}...`);
    }

    function adjustControlValue(targetId, action) {
        const el = document.getElementById(targetId);
        if (!el) return;
        let val = parseFloat(el.value), step = parseFloat(el.step) || 1;
        const min = parseFloat(el.min), max = parseFloat(el.max);
        val += (action === 'increment' ? step : -step);
        el.value = Math.max(min, Math.min(max, val));
        el.dispatchEvent(new Event(el.id === 'numTracksInput' ? 'change' : 'input', { bubbles: true }));
    }
    document.addEventListener('mousedown', (e) => { if (e.target.matches('.slider-button, .number-input-button')) startAutoRepeat(e.target.dataset.target, e.target.dataset.action); });
    document.addEventListener('mouseup', stopAutoRepeat);
    document.addEventListener('mouseleave', (e) => { if (e.target.matches('.slider-button, .number-input-button')) stopAutoRepeat(); });
    document.addEventListener('touchstart', (e) => { if (e.target.matches('.slider-button, .number-input-button')) { e.preventDefault(); startAutoRepeat(e.target.dataset.target, e.target.dataset.action); } }, { passive: false });
    document.addEventListener('touchend', stopAutoRepeat);
    function startAutoRepeat(target, action) { stopAutoRepeat(); adjustControlValue(target, action); autoRepeatTimeoutId = setTimeout(() => { autoRepeatIntervalId = setInterval(() => adjustControlValue(target, action), AUTO_REPEAT_INTERVAL); }, AUTO_REPEAT_DELAY); }
    function stopAutoRepeat() { clearTimeout(autoRepeatTimeoutId); clearInterval(autoRepeatIntervalId); }

    bpmSlider.addEventListener('input', (e) => {
        const newBpm = parseInt(e.target.value);
        Tone.Transport.bpm.value = newBpm;
        bpmValue.textContent = newBpm;
        saveSettings();
    });
    if (bpmSliderLearnCc) bpmSliderLearnCc.addEventListener('click', () => startLearnCc('bpmSlider', bpmSliderLearnCc));

    masterVolumeSlider.addEventListener('input', (e) => {
        const newVolume = parseInt(e.target.value);
        masterVolumeValue.textContent = newVolume;
        // Update all individual channel volumes and send MIDI CC
        for (let i = 0; i < 16; i++) {
            channelVolumes[i] = newVolume;
            const slider = document.getElementById(`channelVolume${i+1}`);
            const valueDisplay = document.getElementById(`channelVolumeValue${i+1}`);
            if(slider) slider.value = newVolume;
            if(valueDisplay) valueDisplay.textContent = newVolume;
            sendMidiCC(7, newVolume, i + 1);
        }
        saveSettings();
    });
    if(masterVolumeLearnCc) masterVolumeLearnCc.addEventListener('click', () => startLearnCc('masterVolumeSlider', masterVolumeLearnCc));


    function setHarmoniousRandomizationScale() {
        const scaleNames = Object.keys(SCALES);
        const randomScaleName = scaleNames[Math.floor(Math.random() * scaleNames.length)];
        const randomRootNote = Math.floor(Math.random() * 12);
        const scaleIntervals = SCALES[randomScaleName];

        currentRandomizationScale = [];
        for (let octave = 2; octave <= 5; octave++) {
            for (const interval of scaleIntervals) {
                const midiNote = 12 * octave + randomRootNote + interval;
                if (midiNote <= 127) {
                    currentRandomizationScale.push(midiNote);
                }
            }
        }
        const rootNoteName = NOTE_NAMES[randomRootNote];
        showStatusMessage(`Randomizing with ${rootNoteName} ${randomScaleName} scale.`);
    }

    masterRandomizeButton.addEventListener('click', () => {
        setHarmoniousRandomizationScale();
        sequencerTracks.forEach(t => t.active && randomizeTrackParameters(t));
        saveSettings();
    });

    function randomizeTrackParameters(track) {
        if (currentRandomizationScale.length === 0) {
            setHarmoniousRandomizationScale();
        }
        track.pulses = Math.floor(Math.random() * (track.steps * 2/3)) + 1;
        track.rotation = track.steps > 0 ? Math.floor(Math.random() * track.steps) : 0;
        track.note = currentRandomizationScale[Math.floor(Math.random() * currentRandomizationScale.length)];
        track.ui.pulsesSlider.value = track.ui.pulsesValue.textContent = track.pulses;
        track.ui.rotationSlider.value = track.ui.rotationValue.textContent = track.rotation;
        track.ui.noteInput.value = Tone.Frequency(track.note, "midi").toNote();
        updateTrackPattern(track);
    }

    defaultSettingsButton.addEventListener('click', () => {
        const defaults = [ {p:4,s:16,r:0,n:"C3"}, {p:3,s:16,r:2,n:"E3"}, {p:5,s:16,r:1,n:"G#3"}, {p:7,s:16,r:3,n:"B3"} ];
        sequencerTracks.forEach((t, i) => {
            const d = defaults[i % defaults.length];
            t.steps = stepsLocked ? globalLockedSteps : d.s;
            t.pulses = d.p > t.steps ? t.steps : d.p;
            t.rotation = d.r % t.steps;
            t.note = Tone.Frequency(d.n).toMidi();
            t.active = true; t.channelOverride = 'global'; t.velocity = 100;
            Object.assign(t.ui.stepsSlider, { value: t.steps, min: t.pulses }); t.ui.stepsValue.textContent = t.steps;
            Object.assign(t.ui.pulsesSlider, { value: t.pulses }); t.ui.pulsesValue.textContent = t.pulses;
            Object.assign(t.ui.rotationSlider, { value: t.rotation, max: t.steps > 0 ? t.steps - 1 : 0 }); t.ui.rotationValue.textContent = t.rotation;
            t.ui.noteInput.value = Tone.Frequency(t.note, "midi").toNote();
            t.ui.velocitySlider.value = t.ui.velocityValue.textContent = t.velocity;
            t.ui.toggleButton.classList.add('active'); t.ui.toggleButton.textContent = 'ON';
            t.ui.channelOverrideSelect.value = t.channelOverride;
            updateTrackPattern(t);
        });
        saveSettings();
        showStatusMessage("Defaults loaded.");
    });

    lockStepsCheckbox.addEventListener('change', (e) => {
        stepsLocked = e.target.checked;
        if (stepsLocked) {
            globalLockedSteps = sequencerTracks.length > 0 ? sequencerTracks[0].steps : 16;
            synchronizeAllTrackSteps(globalLockedSteps);
        } else {
            sequencerTracks.forEach(t => t.ui && (t.ui.stepsSlider.disabled = false));
        }
        saveSettings();
        showStatusMessage(stepsLocked ? `Steps Locked to ${globalLockedSteps}` : "Steps Unlocked");
    });

    function synchronizeAllTrackSteps(newSteps) {
        globalLockedSteps = newSteps;
        sequencerTracks.forEach(t => {
            t.steps = newSteps;
            if (!t.ui) return;
            Object.assign(t.ui.stepsSlider, { value: newSteps, disabled: stepsLocked });
            t.ui.stepsValue.textContent = newSteps;
            if (t.pulses > t.steps) { t.ui.pulsesSlider.value = t.ui.pulsesValue.textContent = t.pulses = t.steps > 0 ? t.steps : 1; }
            t.ui.stepsSlider.min = t.pulses;
            t.ui.rotationSlider.max = t.steps > 0 ? t.steps - 1 : 0;
            if (t.rotation >= t.steps) { t.ui.rotationSlider.value = t.ui.rotationValue.textContent = t.rotation = t.steps > 0 ? t.rotation % t.steps : 0; }
            updateTrackPattern(t);
        });
        saveSettings();
    }

    function createSequencerTrackUI(trackIndex) {
        let initialSteps = stepsLocked ? globalLockedSteps : 16;
        let initialPulses = Math.floor(Math.random() * initialSteps / 2) + 1;
        let initialRotation = Math.floor(Math.random() * initialSteps);

        const trackDiv = document.createElement('div');
        trackDiv.className = 'synth-panel p-2 flex flex-col disco-flash';
        trackDiv.innerHTML = `
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-sm font-semibold" style="font-family: 'Orbitron', sans-serif;">Track ${trackIndex + 1}</h3>
                <div>
                    <button id="randomizeTrack${trackIndex}" class="randomize-button" title="Randomize Pulses, Rotate, and Note">Random</button>
                    <button id="trackToggle${trackIndex}" class="push-button text-xs py-1 px-2 ml-1 active" title="Toggle this track ON or OFF">ON</button>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-x-3 gap-y-1 mb-2">
                <div class="control-group">
                    <div class="control-header">
                        <label for="pulses${trackIndex}">Pulses:</label>
                        <span id="pulsesValue${trackIndex}" class="value-display">${initialPulses}</span>
                        <button class="learn-cc-button ml-2" data-param-id="pulses${trackIndex}" title="Map Pulses to MIDI CC">Learn</button>
                    </div>
                    <div class="control-slider-container"><button class="slider-button" data-target="pulses${trackIndex}" data-action="decrement">-</button><input type="range" id="pulses${trackIndex}" min="1" max="32" value="${initialPulses}" class="control-slider"><button class="slider-button" data-target="pulses${trackIndex}" data-action="increment">+</button></div>
                </div>
                <div class="control-group">
                    <div class="control-header">
                        <label for="steps${trackIndex}">Steps:</label>
                        <span id="stepsValue${trackIndex}" class="value-display">${initialSteps}</span>
                        <button class="learn-cc-button ml-2" data-param-id="steps${trackIndex}" title="Map Steps to MIDI CC">Learn</button>
                    </div>
                    <div class="control-slider-container"><button class="slider-button" data-target="steps${trackIndex}" data-action="decrement">-</button><input type="range" id="steps${trackIndex}" min="1" max="32" value="${initialSteps}" class="control-slider"><button class="slider-button" data-target="steps${trackIndex}" data-action="increment">+</button></div>
                </div>
                <div class="control-group">
                    <div class="control-header">
                        <label for="rotation${trackIndex}">Rotate:</label>
                        <span id="rotationValue${trackIndex}" class="value-display">${initialRotation}</span>
                        <button class="learn-cc-button ml-2" data-param-id="rotation${trackIndex}" title="Map Rotation to MIDI CC">Learn</button>
                    </div>
                    <div class="control-slider-container"><button class="slider-button" data-target="rotation${trackIndex}" data-action="decrement">-</button><input type="range" id="rotation${trackIndex}" min="0" max="${initialSteps-1}" value="${initialRotation}" class="control-slider"><button class="slider-button" data-target="rotation${trackIndex}" data-action="increment">+</button></div>
                </div>
                <div class="control-group">
                    <div class="control-header">
                        <label for="velocity${trackIndex}">Vel:</label>
                        <span id="velocityValue${trackIndex}" class="value-display">100</span>
                        <button class="learn-cc-button ml-2" data-param-id="velocity${trackIndex}" title="Map Velocity to MIDI CC">Learn</button>
                    </div>
                    <div class="control-slider-container"><button class="slider-button" data-target="velocity${trackIndex}" data-action="decrement">-</button><input type="range" id="velocity${trackIndex}" min="1" max="127" value="100" class="control-slider"><button class="slider-button" data-target="velocity${trackIndex}" data-action="increment">+</button></div>
                </div>
                <div class="control-group">
                    <label for="channelOverride${trackIndex}" class="mb-1">Channel:</label>
                    <select id="channelOverride${trackIndex}" class="text-xs p-1 h-full" title="MIDI Channel Override"><option value="global">Global</option>${Array.from({length:16},(_,i)=>`<option value="${i+1}">${i+1}</option>`).join('')}</select>
                </div>
                <div class="control-group">
                    <label for="note${trackIndex}" class="mb-1">Note:</label>
                    <div class="note-input-group"><input type="text" id="note${trackIndex}" value="C3" class="text-xs p-1"><button id="noteLearn${trackIndex}" class="note-learn-button">Learn</button></div>
                </div>
            </div>
            <div id="patternDisplay${trackIndex}" class="pattern-display my-1"></div>
        `;
        sequencerTracksContainer.appendChild(trackDiv);

        const track = {
            id: trackIndex, active: true, pulses: initialPulses, steps: initialSteps, rotation: initialRotation,
            note: Tone.Frequency("C3").toMidi(), velocity: 100, channelOverride: 'global',
            pattern: [], currentStep: 0,
            ui: {
                panel: trackDiv,
                toggleButton: document.getElementById(`trackToggle${trackIndex}`),
                randomizeButton: document.getElementById(`randomizeTrack${trackIndex}`),
                pulsesSlider: document.getElementById(`pulses${trackIndex}`), pulsesValue: document.getElementById(`pulsesValue${trackIndex}`),
                stepsSlider: document.getElementById(`steps${trackIndex}`), stepsValue: document.getElementById(`stepsValue${trackIndex}`),
                rotationSlider: document.getElementById(`rotation${trackIndex}`), rotationValue: document.getElementById(`rotationValue${trackIndex}`),
                noteInput: document.getElementById(`note${trackIndex}`), noteLearnButton: document.getElementById(`noteLearn${trackIndex}`),
                velocitySlider: document.getElementById(`velocity${trackIndex}`), velocityValue: document.getElementById(`velocityValue${trackIndex}`),
                channelOverrideSelect: document.getElementById(`channelOverride${trackIndex}`),
                patternDisplay: document.getElementById(`patternDisplay${trackIndex}`),
            }
        };

        if (currentRandomizationScale.length > 0) {
            track.note = currentRandomizationScale[Math.floor(Math.random() * currentRandomizationScale.length)];
        } else {
            track.note = 48 + Math.floor(Math.random() * 24); // C3 to B4
        }
        track.ui.noteInput.value = Tone.Frequency(track.note, "midi").toNote();

        track.ui.randomizeButton.addEventListener('click', () => randomizeTrackParameters(track));
        track.ui.toggleButton.addEventListener('click', () => {
            track.active = !track.active;
            track.ui.toggleButton.classList.toggle('active', track.active);
            track.ui.toggleButton.textContent = track.active ? 'ON' : 'OFF';
            if (!track.active) {
                const ch = (track.channelOverride !== 'global') ? track.channelOverride : selectedMidiChannel;
                sendMidiNoteOff(track.note, ch);
            }
            saveSettings();
        });
        track.ui.pulsesSlider.addEventListener('input', e => {
            track.pulses = parseInt(e.target.value);
            track.ui.pulsesValue.textContent = track.pulses;
            track.ui.stepsSlider.min = track.pulses;
            updateTrackPattern(track); saveSettings();
        });
        track.ui.stepsSlider.addEventListener('input', e => {
            const newSteps = parseInt(e.target.value);
            if (stepsLocked) synchronizeAllTrackSteps(newSteps);
            else {
                track.steps = newSteps;
                if (track.steps < track.pulses) track.steps = e.target.value = track.pulses;
                track.ui.stepsValue.textContent = track.steps;
                track.ui.rotationSlider.max = track.steps > 0 ? track.steps - 1 : 0;
                if (track.rotation >= track.steps) track.ui.rotationSlider.value = track.ui.rotationValue.textContent = track.rotation = 0;
                updateTrackPattern(track);
            }
            saveSettings();
        });
        track.ui.rotationSlider.addEventListener('input', e => {
            track.rotation = parseInt(e.target.value);
            track.ui.rotationValue.textContent = track.rotation;
            updateTrackPattern(track); saveSettings();
        });
        track.ui.noteInput.addEventListener('change', e => {
            try { track.note = Tone.Frequency(e.target.value.toUpperCase()).toMidi(); saveSettings(); }
            catch { e.target.value = Tone.Frequency(track.note, "midi").toNote(); }
        });
        track.ui.velocitySlider.addEventListener('input', e => {
            track.velocity = parseInt(e.target.value);
            track.ui.velocityValue.textContent = track.velocity;
            saveSettings();
        });
        track.ui.noteLearnButton.addEventListener('click', () => startNoteLearn(track, track.ui.noteLearnButton));
        track.ui.channelOverrideSelect.addEventListener('change', e => {
            track.channelOverride = e.target.value;
            saveSettings();
        });

        trackDiv.querySelectorAll('.learn-cc-button').forEach(btn => {
            btn.textContent = 'Learn';
            btn.addEventListener('click', () => startLearnCc(btn.dataset.paramId, btn))
        });
        sequencerTracks.push(track);
    }

    function createChannelVolumeUI() {
        channelVolumesContainer.innerHTML = '';
        for(let i=1; i<=16; i++) {
            const volDiv = document.createElement('div');
            volDiv.className = 'control-group';
            volDiv.innerHTML = `
                 <div class="control-header">
                    <label for="channelVolume${i}">Ch ${i}:</label>
                    <span id="channelVolumeValue${i}" class="value-display">${channelVolumes[i-1]}</span>
                    <button class="learn-cc-button ml-2" data-param-id="channelVolume${i}">L</button>
                </div>
                <div class="control-slider-container">
                    <input type="range" id="channelVolume${i}" min="0" max="127" value="${channelVolumes[i-1]}" class="control-slider">
                </div>
            `;
            channelVolumesContainer.appendChild(volDiv);

            const slider = volDiv.querySelector(`#channelVolume${i}`);
            const valueDisplay = volDiv.querySelector(`#channelVolumeValue${i}`);
            const learnBtn = volDiv.querySelector('.learn-cc-button');

            slider.addEventListener('input', e => {
                const newVolume = parseInt(e.target.value);
                valueDisplay.textContent = newVolume;
                channelVolumes[i-1] = newVolume;
                sendMidiCC(7, newVolume, i);
                saveSettings();
            });
            learnBtn.addEventListener('click', () => startLearnCc(`channelVolume${i}`, learnBtn));
        }
    }

    function updateTrackPattern(track) {
        track.pattern = generateEuclideanPattern(track.pulses, track.steps);
        track.pattern = rotatePattern(track.pattern, track.rotation);
        track.currentStep = 0;
        renderPatternDisplay(track);
        setupTrackLoop(track);
    }

    function renderPatternDisplay(track) {
        if (!track || !track.ui.patternDisplay) return;
        track.ui.patternDisplay.innerHTML = '';
        if (track.steps === 0 || !track.pattern) return;
        for (let i = 0; i < track.steps; i++) {
            const step = document.createElement('div');
            step.className = 'pattern-step';
            if (track.pattern[i] === 1) step.classList.add('active');
            if (i === track.currentStep && Tone.Transport.state === "started" && track.active) step.classList.add('current');
            track.ui.patternDisplay.appendChild(step);
        }
    }

    function setupTrackLoop(track) {
        if (transportLoops[track.id]) transportLoops[track.id].stop(0).dispose();
        if (track.steps === 0 || !track.pattern.length) { renderPatternDisplay(track); return; }

        transportLoops[track.id] = new Tone.Sequence((time, value) => {
            const ch = (track.channelOverride !== 'global') ? parseInt(track.channelOverride) : selectedMidiChannel;
            if (track.active && value === 1) {
                sendMidiNoteOn(track.note, track.velocity, ch);
                Tone.Transport.scheduleOnce(() => sendMidiNoteOff(track.note, ch), time + Tone.Time(`${track.steps}n`).toSeconds() * 0.8);

                Tone.Draw.schedule(() => {
                    const panel = track.ui.panel;
                    if (!panel) return;
                    panel.style.backgroundColor = `hsl(${Math.random() * 360}, 70%, 85%)`; // Pastel colors
                    setTimeout(() => { panel.style.backgroundColor = ''; }, 90);
                }, time);
            }
            Tone.Draw.schedule(() => {
                track.currentStep = (track.currentStep + 1) % track.steps;
                renderPatternDisplay(track);
            }, time);
        }, track.pattern, `${track.steps}n`).start(0);
    }

    Tone.Transport.on('start', () => sequencerTracksContainer.classList.remove('stopped'));
    Tone.Transport.on('stop', () => {
        sequencerTracksContainer.classList.add('stopped');
        sequencerTracks.forEach(t => { t.currentStep = 0; renderPatternDisplay(t); });
    });


    function updateTrackCount(newCount) {
        const oldCount = numTracks;

        if (newCount > oldCount) {
            for (let i = oldCount; i < newCount; i++) {
                createSequencerTrackUI(i);
                updateTrackPattern(sequencerTracks[i]);
            }
        } else if (newCount < oldCount) {
            for (let i = oldCount - 1; i >= newCount; i--) {
                const trackToRemove = sequencerTracks[i];
                if (trackToRemove && trackToRemove.ui && trackToRemove.ui.panel) {
                    trackToRemove.ui.panel.remove();
                }
                if (transportLoops[i]) {
                    transportLoops[i].stop(0).dispose();
                }
            }
            sequencerTracks.length = newCount;
            transportLoops.length = newCount;
        }

        numTracks = newCount;
        saveSettings();
    }


    numTracksInput.addEventListener('change', (e) => {
        let count = Math.max(1, Math.min(MAX_TRACKS, parseInt(e.target.value) || numTracks));
        e.target.value = count;
        if (count !== numTracks) {
            updateTrackCount(count);
        }
    });

    playStopButton.addEventListener('click', async () => {
        if (Tone.Transport.state === 'started') {
            Tone.Transport.stop();
            const allChs = new Set([selectedMidiChannel, ...sequencerTracks.map(t => parseInt(t.channelOverride)).filter(c => !isNaN(c))]);
            allChs.forEach(sendAllNotesOff);
            playStopButton.textContent = 'Play';
            playStopButton.classList.remove('active');
        } else {
            if (Tone.context.state !== 'running') await Tone.start();
            Tone.Transport.start();
            playStopButton.textContent = 'Stop';
            playStopButton.classList.add('active');
        }
    });

    midiChannelSelect.addEventListener('change', e => { selectedMidiChannel = parseInt(e.target.value); saveSettings(); });

    for (let i = 1; i <= 16; i++) midiChannelSelect.add(new Option(`Ch ${i}`, i));

    async function init() {
        userIdDisplay.textContent = crypto.randomUUID().substring(0,8);
        const loaded = loadSettings();

        numTracks = (loaded && loaded.numTracks > 0) ? loaded.numTracks : 4;

        createChannelVolumeUI();
        for (let i = 0; i < numTracks; i++) {
            createSequencerTrackUI(i);
        }

        numTracksInput.value = numTracks;
        if(loaded && loaded.bpm) bpmSlider.value = loaded.bpm;
        if(loaded && loaded.masterVolume) masterVolumeSlider.value = loaded.masterVolume;

        Tone.Transport.bpm.value = parseInt(bpmSlider.value);
        bpmValue.textContent = bpmSlider.value;
        masterVolumeValue.textContent = masterVolumeSlider.value;
        lockStepsCheckbox.checked = stepsLocked;
        midiChannelSelect.value = selectedMidiChannel;

        if (loaded && loaded.tracks) {
            loaded.tracks.forEach((saved, i) => {
                if (i >= sequencerTracks.length) return;
                const t = sequencerTracks[i];
                Object.assign(t, saved);
                t.steps = stepsLocked ? globalLockedSteps : (saved.steps ?? globalLockedSteps);

                t.ui.stepsSlider.value = t.steps; t.ui.stepsValue.textContent = t.steps;
                t.ui.pulsesSlider.value = t.pulses; t.ui.pulsesValue.textContent = t.pulses;
                t.ui.rotationSlider.max = t.steps > 0 ? t.steps - 1 : 0;
                t.ui.rotationSlider.value = t.rotation; t.ui.rotationValue.textContent = t.rotation;
                t.ui.noteInput.value = Tone.Frequency(t.note, "midi").toNote();
                t.ui.velocitySlider.value = t.velocity; t.ui.velocityValue.textContent = t.velocity;
                t.ui.toggleButton.classList.toggle('active', t.active);
                t.ui.toggleButton.textContent = t.active ? 'ON' : 'OFF';
                t.ui.channelOverrideSelect.value = t.channelOverride;
            });
        }

        setHarmoniousRandomizationScale();
        sequencerTracks.forEach(updateTrackPattern);
        await setupMIDI();

        if (loaded && loaded.midiOutputId && Array.from(midiOutSelect.options).some(o => o.value === loaded.midiOutputId)) {
            midiOutSelect.value = loaded.midiOutputId;
            updateMidiOutput();
        }

        if (!loaded) defaultSettingsButton.click();
        else if (stepsLocked) synchronizeAllTrackSteps(globalLockedSteps);

        showStatusMessage("Rhythm King 77 Initialized!", 3000);
    }
    window.onload = init;
</script>
</body>
</html>
