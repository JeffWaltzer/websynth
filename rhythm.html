<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rhythm King 77 - Websynth (MIDI Only)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Custom CSS for a more refined look */
        :root {
            --primary-bg: #2a2a2a;
            --secondary-bg: #3a3a3a;
            --panel-bg: #4a4a4a; /* Darker panel for contrast */
            --panel-border: #6a6a6a;
            --text-color: #e0e0e0;
            --accent-color: #f0ad4e; /* Orange-yellow accent */
            --control-bg: #333333;
            --control-border: #555555;
            --thumb-color: #c0b090; /* Muted gold/silver for sliders */
            --active-toggle: #5cb85c; /* Green for ON */
            --random-btn: #337ab7; /* Blue for Random */
            --learn-btn: #d9534f; /* Red for Learn */
            --save-load-btn: #5bc0de; /* Light blue */
            --midi-util-btn: #f0ad4e; /* Orange for MIDI utilities */
            --status-bg: rgba(0,0,0,0.8);
            --status-text: #fff;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-color);
            overscroll-behavior: none;
            font-size: 12px;
            display: flex;
            flex-direction: column;
            min-height: 100vh; /* Ensure full viewport height */
        }
        .main-container {
            margin-bottom: 2rem;
            flex-grow: 1; /* Allow content to grow */
        }
        .synth-panel {
            background-color: var(--panel-bg);
            border: 2px solid var(--panel-border);
            border-radius: 12px;
            box-shadow: 5px 5px 12px rgba(0,0,0,0.6), -3px -3px 8px rgba(255,255,255,0.07), inset 2px 2px 5px rgba(255,255,255,0.05), inset -2px -2px 5px rgba(0,0,0,0.2);
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            transition: opacity 0.4s ease-in-out, filter 0.4s ease-in-out, border-color 0.4s ease-in-out, box-shadow 0.4s ease-in-out;
            position: relative;
        }
        #masterControlPanel {
            padding: 0.5rem;
            gap: 0.5rem;
        }
        .synth-panel.track-pulse {
            animation: trackPulse 0.15s ease-out;
            filter: brightness(1.2);
        }
        @keyframes trackPulse {
            0% {
                box-shadow: 0 0 15px 5px var(--accent-color), 5px 5px 12px rgba(0,0,0,0.6), -3px -3px 8px rgba(255,255,255,0.07), inset 2px 2px 5px rgba(255,255,255,0.05), inset -2px -2px 5px rgba(0,0,0,0.2);
                transform: scale(1.005);
            }
            100% {
                box-shadow: 5px 5px 12px rgba(0,0,0,0.6), -3px -3px 8px rgba(255,255,255,0.07), inset 2px 2px 5px rgba(255,255,255,0.05), inset -2px -2px 5px rgba(0,0,0,0.2);
                transform: scale(1);
            }
        }
        .control-flash {
            transition: box-shadow 0.5s ease-out;
            box-shadow: 0 0 10px 4px var(--accent-color);
        }

        .control-slider-container { display: flex; align-items: center; gap: 0.5rem; }
        .number-input-container { display: flex; align-items: center; gap: 0.5rem; }
        .slider-button, .number-input-button {
            background-color: var(--control-border); color: var(--text-color); border: 1px solid var(--control-bg); border-radius: 6px;
            padding: 0.2rem 0.5rem; font-size: 0.9rem; font-weight: bold; line-height: 1; cursor: pointer; user-select: none;
            transition: background-color 0.1s ease;
        }
        .slider-button:hover, .number-input-button:hover { background-color: var(--panel-border); }

        .control-slider {
            -webkit-appearance: none; appearance: none; width: 100%; height: 20px; background: var(--control-bg);
            border-radius: 10px; border: 1px solid var(--control-border); outline: none; cursor: pointer; flex-grow: 1;
            transition: background-color 0.1s ease;
        }
        .control-slider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 28px; height: 28px; background: var(--thumb-color);
            border-radius: 8px; border: 2px solid var(--control-border); cursor: grab; box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            transition: background-color 0.1s ease, box-shadow 0.1s ease;
        }
        .control-slider::-moz-range-thumb {
            width: 28px; height: 28px; background: var(--thumb-color); border-radius: 8px; border: 2px solid var(--control-border);
            cursor: grab; box-shadow: 0 2px 4px rgba(0,0,0,0.3); transition: background-color 0.1s ease, box-shadow 0.1s ease;
        }
        .control-slider:hover::-webkit-slider-thumb, .control-slider:hover::-moz-range-thumb {
            background-color: var(--accent-color); box-shadow: 0 0 8px var(--accent-color);
        }

        .push-button {
            font-family: 'Orbitron', sans-serif; background-color: var(--panel-border); color: var(--text-color);
            border: 2px solid var(--control-bg); padding: 0.3rem 0.8rem; border-radius: 8px; text-transform: uppercase;
            font-weight: bold; font-size: 0.7rem; box-shadow: 0 2px 4px rgba(0,0,0,0.3), inset 0 1px 1px rgba(255,255,255,0.1);
            transition: all 0.1s ease-in-out; height: 32px; display: inline-flex; align-items: center; justify-content: center;
        }
        .push-button.icon-button { font-size: 1.1rem; padding: 0.4rem; width: 32px; height: 32px; }
        .push-button:active, .push-button.active {
            background-color: var(--accent-color); color: #333;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.4), inset 2px 2px 5px rgba(0,0,0,0.3), inset -1px -1px 2px rgba(255,255,255,0.1);
            transform: translateY(1px);
        }

        #playStopButton { background-color: #5cb85c; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.3), inset 0 1px 1px rgba(255,255,255,0.2); }
        #playStopButton.stop-state { background-color: #d9534f; }
        #playStopButton:active { background-color: #4cae4c; }
        #playStopButton.stop-state:active { background-color: #c9302c; }

        .learn-cc-button, .note-learn-button {
            background-color: var(--learn-btn); color: white; flex-shrink: 0; padding: 0.15rem 0.5rem; font-size: 0.7rem;
            border-radius: 6px; border: 1px solid #c9302c; box-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        .learn-cc-button:hover, .note-learn-button:hover { background-color: #c9302c; }
        .learn-cc-button.learning, .note-learn-button.learning {
            background-color: #ffc107; color: #333; animation: pulseLearn 1s infinite alternate;
        }
        @keyframes pulseLearn { from { box-shadow: 0 0 5px #ffc107; } to { box-shadow: 0 0 15px #ffc107; } }
        .learn-cc-button.mapped { background-color: #4CAF50; border-color: #337a36; }

        .randomize-button { background-color: var(--random-btn); color: white; }
        .master-randomize-button { background-color: #f0ad4e; color: #333; }
        .re-init-midi-button { background-color: #6c757d; }
        .save-load-button { background-color: var(--save-load-btn); color: white; }
        .midi-utility-button { background-color: var(--midi-util-btn); color: #333; }

        .pattern-display { display: flex; justify-content: center; align-items: center; margin-top: 0.2rem; height: 24px; gap: 4px; }
        .pattern-step {
            width: 12px; height: 12px; background-color: var(--control-bg); border-radius: 50%;
            transition: background-color 0.1s ease-out, transform 0.1s ease-out; flex-shrink: 0; border: 1px solid var(--control-border);
        }
        .pattern-step.active { background-color: var(--accent-color); animation: dotPop 0.1s ease-out; }
        @keyframes dotPop { 0% { transform: scale(1); } 50% { transform: scale(1.4); background-color: white; } 100% { transform: scale(1); } }
        .pattern-step.current { background-color: #fff; border: 2px solid var(--accent-color); transform: scale(1.3); box-shadow: 0 0 8px rgba(255,255,255,0.9); }

        label { display: block; margin-bottom: 0.1rem; font-size: 0.75rem; text-transform: uppercase; font-family: 'Orbitron', sans-serif; white-space: nowrap; margin-right: 0.5rem; color: var(--accent-color); }
        select, input[type="number"], input[type="text"] {
            background-color: var(--control-bg); border: 1px solid var(--control-border); color: var(--text-color); padding: 0.4rem; border-radius: 6px; width: 100%; font-size: 0.8rem;
        }
        input[type="number"] { text-align: center; }

        .value-display { font-family: 'Orbitron', sans-serif; color: var(--text-color); font-size: 0.8rem; min-width: 30px; text-align: right; flex-grow: 1; }
        .control-group { display: flex; flex-direction: column; margin-bottom: 0; }
        .control-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.2rem; }
        .checkbox-label-container { display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; margin-top: 0.3rem; cursor: pointer; color: var(--text-color); }
        .checkbox-label-container input[type="checkbox"] { width: 16px; height: 16px; accent-color: var(--accent-color); border-radius: 4px; }

        #sequencerTracksContainer { display: flex; flex-wrap: wrap; justify-content: center; gap: 0.75rem; padding: 0.5rem 0; margin-left: auto; margin-right: auto; }
        #sequencerWrapperPanel { flex-grow: 1; }
        #sequencerTracksContainer > .synth-panel {
            margin-bottom: 0;
            min-width: 270px;
            max-width: 320px;
            flex: 1 1 270px;
        }

        .explanation-text-footer { font-size: 0.85rem; line-height: 1.5; color: #b0b0b0; text-align: center; padding: 1.5rem 1rem; max-width: 700px; margin: 1rem auto 0 auto; border-top: 1px solid var(--control-border); }
        .note-input-group { display: flex; align-items: center; gap: 0.25rem; }
        .note-input-group > input { flex-grow: 1; }

        #musicModePanel, #channelVolumesWrapper, #midiPanel, #randomizationSettingsContainer, #hintsPanel { display: none; }
        body.music-mode-active #musicModePanel { display: flex; flex-direction: column; gap: 0.5rem; }
        #appContainer { display: flex; flex-direction: column; gap: 0.75rem; flex-grow: 1; }
        #mainContent { flex-grow: 1; min-width: 0; display: flex; flex-direction: column; }
        #musicModeLog {
            height: 100%; min-height: 100px; background-color: rgba(0,0,0,0.3); border-radius: 8px; padding: 0.5rem;
            font-size: 0.7rem; line-height: 1.4; overflow-y: auto; display: flex; flex-direction: column-reverse; color: var(--accent-color);
        }
        #musicModeLog > div { padding: 0 0.25rem; margin-bottom: 0.2rem; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 0.2rem; word-break: break-word; }
        #channelVolumesContainer { display: grid; grid-template-columns: repeat(auto-fit, minmax(90px, 1fr)); gap: 0.75rem; padding: 0.2rem; }
        #channelVolumesContainer .control-group { margin-bottom: 0; }
        #channelVolumesContainer .control-header { margin-bottom: 0.1rem; }
        #channelVolumesContainer .control-slider { height: 16px; }
        #channelVolumesContainer .control-slider::-webkit-slider-thumb, #channelVolumesContainer .control-slider::-moz-range-thumb { width: 24px; height: 24px; }
        #channelVolumesContainer label { font-size: 0.7rem; }

        #octaveSelector { display: flex; justify-content: center; }
        .octave-radio-label {
            display: inline-flex; align-items: center; background-color: var(--control-bg); border: 1px solid var(--control-border);
            padding: 0.2rem 0.6rem; transition: all 0.1s ease; font-size: 0.8rem;
        }
        .octave-radio-label:not(:first-child) { margin-left: -1px; }
        .octave-radio-label:first-child { border-top-left-radius: 6px; border-bottom-left-radius: 6px;}
        .octave-radio-label:last-child { border-top-right-radius: 6px; border-bottom-right-radius: 6px;}
        .octave-radio-label input { display: none; }
        .octave-radio-label:hover { background-color: var(--panel-border); z-index: 1; position: relative; }
        .octave-radio-label.selected { background-color: var(--accent-color); border-color: #f8c57a; z-index: 2; position: relative; }
        .octave-radio-label.selected span { color: var(--primary-bg); font-weight: bold; }

        #logSection { display: none; }
        body.music-mode-active #logSection { display: flex; }

        #bottom-panels-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 0.75rem;
        }

        #randomizeOptionsContainer, #viewTogglesContainer {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            gap: 0 1rem;
        }

        #statusBar {
            position: fixed; bottom: 0; left: 0; width: 100%; background-color: var(--status-bg); color: var(--status-text);
            padding: 0.5rem 1rem; text-align: center; font-size: 0.9rem; z-index: 1000; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out; border-top: 2px solid var(--accent-color);
        }
        #statusBar.visible { opacity: 1; visibility: visible; }
        #hintContent {
            background-color: var(--control-bg); border: 1px solid var(--control-border); border-radius: 8px; padding: 0.75rem;
            min-height: 80px; display: flex; align-items: center; justify-content: center; color: #b0b0b0; font-style: italic;
        }

        #app-background {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background-size: cover;
            transition: all 1s ease-in-out; opacity: 0.8; filter: grayscale(0.5);
        }
        #app-background.bg-default { background-color: var(--primary-bg); background-image: radial-gradient(circle at center, rgba(60,60,60,0.1) 1px, transparent 1px); background-size: 20px 20px; }
        #app-background.bg-music-mode {
            background-color: #3b3b3b; filter: grayscale(0);
            background-image: linear-gradient(0deg, transparent 24%, rgba(240,173,78,0.05) 25%, rgba(240,173,78,0.05) 26%, transparent 27%, transparent 74%, rgba(240,173,78,0.05) 75%, rgba(240,173,78,0.05) 76%, transparent 77%, transparent), linear-gradient(90deg, transparent 24%, rgba(240,173,78,0.05) 25%, rgba(240,173,78,0.05) 26%, transparent 27%, transparent 74%, rgba(240,173,78,0.05) 75%, rgba(240,173,78,0.05) 76%, transparent 77%, transparent);
            background-size: 80px 80px;
        }
    </style>
</head>
<body class="p-1 md:p-4">

<div id="app-background" class="bg-default"></div>

<header class="text-center mb-4">
    <h1 class="text-3xl md:text-4xl font-bold" style="font-family: 'Orbitron', sans-serif; color: var(--accent-color);">RHYTHM KING 77</h1>
    <p class="text-sm md:text-base text-gray-400">Euclidean MIDI Sequencer</p>
</header>

<div id="appContainer">
    <div id="mainContent" class="flex-grow">
        <div class="flex flex-col gap-3 main-container">
            <div id="sequencerWrapperPanel" class="w-full synth-panel">
                <h2 class="text-lg font-semibold mb-3 text-center" style="font-family: 'Orbitron', sans-serif;">Euclidean Sequencer Tracks</h2>
                <div id="sequencerTracksContainer"></div>
            </div>

            <div id="bottom-panels-container">
                <div id="masterControlPanel" class="synth-panel flex flex-col gap-2">
                    <h2 class="text-lg font-semibold mb-1 text-center" style="font-family: 'Orbitron', sans-serif;">Master Control</h2>

                    <div id="toolbar" class="flex flex-wrap items-center justify-center gap-3 mb-2">
                        <button id="playStopButton" class="push-button icon-button" title="Start or stop all sequences">&#x25B6;</button>
                        <button id="saveStateButton" class="push-button save-load-button icon-button" title="Save the current session to browser storage">&#128190;</button>
                        <button id="loadStateButton" class="push-button save-load-button icon-button" title="Load the last saved session from browser storage">&#128193;</button>
                    </div>

                    <div class="control-group">
                        <label for="numTracksInput">Number of Tracks:</label>
                        <div class="number-input-container">
                            <button class="number-input-button" data-target="numTracksInput" data-action="decrement" title="Decrease number of tracks">&minus;</button>
                            <input type="number" id="numTracksInput" min="1" max="12" value="4" title="Set the total number of sequencer tracks (1-12).">
                            <button class="number-input-button" data-target="numTracksInput" data-action="increment" title="Increase number of tracks">+</button>
                        </div>
                    </div>

                    <div class="control-group">
                        <div class="control-header">
                            <label for="bpmSlider">Tempo (BPM):</label> <span id="bpmValue" class="value-display">45</span>
                            <button id="bpmSliderLearnCc" class="learn-cc-button ml-2" data-param-id="bpmSlider" title="Map Master Tempo to a MIDI CC">L</button>
                        </div>
                        <div class="control-slider-container">
                            <button class="slider-button" data-target="bpmSlider" data-action="decrement" title="Decrease Tempo">&minus;</button>
                            <input type="range" id="bpmSlider" min="20" max="240" value="45" class="control-slider" title="Adjust master tempo (20-240 BPM)">
                            <button class="slider-button" data-target="bpmSlider" data-action="increment" title="Increase Tempo">+</button>
                        </div>
                    </div>

                    <div class="control-group">
                        <div class="control-header">
                            <label for="masterVolumeSlider">Master Volume:</label> <span id="masterVolumeValue" class="value-display">100</span>
                            <button id="masterVolumeLearnCc" class="learn-cc-button ml-2" data-param-id="masterVolumeSlider" title="Map Master Volume to a MIDI CC">L</button>
                        </div>
                        <div class="control-slider-container">
                            <button class="slider-button" data-target="masterVolumeSlider" data-action="decrement" title="Decrease Volume">&minus;</button>
                            <input type="range" id="masterVolumeSlider" min="0" max="127" value="100" class="control-slider" title="Adjust master volume (MIDI CC #7)">
                            <button class="slider-button" data-target="masterVolumeSlider" data-action="increment" title="Increase Volume">+</button>
                        </div>
                    </div>

                    <div class="control-group border-t border-gray-700 pt-2 mt-2">
                        <label class="font-bold text-xs uppercase" style="font-family: 'Orbitron', sans-serif;">Global Controls</label>
                        <div class="grid grid-cols-2 gap-x-4">
                            <label class="checkbox-label-container" title="Toggle Music Mode for automatic generative patterns"><input type="checkbox" id="musicModeToggle"> Music Mode</label>
                            <label class="checkbox-label-container" title="Lock all 'Steps' sliders together."><input type="checkbox" id="lockStepsCheckbox"> Lock All Steps</label>
                        </div>
                    </div>

                    <div class="control-group border-t border-gray-700 pt-2 mt-2">
                        <label class="font-bold text-xs uppercase" style="font-family: 'Orbitron', sans-serif;">View Toggles</label>
                        <div id="viewTogglesContainer">
                            <label class="checkbox-label-container"><input type="checkbox" data-view-toggle="midiPanel" id="showMidiPanel" checked title="Show/Hide the MIDI Setup panel"> MIDI</label>
                            <label class="checkbox-label-container"><input type="checkbox" data-view-toggle="randomizationSettingsContainer" id="showRandomPanel" checked title="Show/Hide the Randomization panel"> Random</label>
                            <label class="checkbox-label-container"><input type="checkbox" data-view-toggle="channelVolumesWrapper" id="showVolumesPanel" checked title="Show/Hide the Channel Volumes panel"> Volumes</label>
                            <label class="checkbox-label-container"><input type="checkbox" data-view-toggle="hintsPanel" id="showHintsPanel" checked title="Show/Hide the Hints panel"> Hints</label>
                        </div>
                    </div>
                </div>

                <div id="midiPanel" class="synth-panel flex flex-col gap-3">
                    <h2 class="text-lg font-semibold mb-1 text-center" style="font-family: 'Orbitron', sans-serif;">MIDI Setup</h2>
                    <div class="control-group">
                        <div class="grid grid-cols-2 gap-2">
                            <button id="reInitMidiButton" class="push-button re-init-midi-button w-full" title="Rescan for MIDI devices.">RESET MIDI</button>
                            <button id="allNotesOffButton" class="push-button midi-utility-button w-full" title="Sends 'All Notes Off' messages to prevent stuck notes.">STOP NOTES</button>
                        </div>
                    </div>
                    <div class="control-group">
                        <label for="midiOutSelect">MIDI Output Device:</label>
                        <select id="midiOutSelect" title="Select MIDI output device."></select>
                    </div>
                    <div class="control-group">
                        <label for="midiChannelSelect">Global MIDI Channel:</label>
                        <select id="midiChannelSelect" title="Select default MIDI channel (1-16)."></select>
                    </div>
                </div>

                <div id="randomizationSettingsContainer" class="synth-panel">
                    <h2 class="text-lg font-semibold mb-2 text-center" style="font-family: 'Orbitron', sans-serif;">Randomization</h2>
                    <div class="control-group mb-3">
                        <button id="masterRandomizeButton" class="push-button master-randomize-button w-full" title="Randomize all active tracks.">RANDOMIZE ALL ACTIVE</button>
                    </div>
                    <div class="control-group">
                        <label for="octaveSelector" class="text-center mb-1">Base Octave</label>
                        <div id="octaveSelector" title="Set the base octave for note randomization"></div>
                    </div>
                    <div id="randomizeOptionsContainer" class="control-group mt-2">
                        <label class="font-bold text-xs uppercase col-span-full" style="font-family: 'Orbitron', sans-serif;">Randomize:</label>
                        <label class="checkbox-label-container"><input type="checkbox" id="randomizeNoteCheck" checked title="Randomize the MIDI note of tracks"> Notes</label>
                        <label class="checkbox-label-container"><input type="checkbox" id="randomizePulsesCheck" checked title="Randomize the number of pulses in tracks"> Pulses</label>
                        <label class="checkbox-label-container"><input type="checkbox" id="randomizeRotationCheck" checked title="Randomize the pattern rotation of tracks"> Rotation</label>
                        <label class="checkbox-label-container"><input type="checkbox" id="randomizeScaleCheck" checked title="Randomize the musical scale for all tracks"> Scale</label>
                        <label class="checkbox-label-container"><input type="checkbox" id="randomizeVelocityCheck" checked title="Randomize the velocity of notes in tracks"> Velocity</label>
                    </div>
                </div>

                <div id="musicModePanel" class="synth-panel">
                    <h2 class="text-lg font-semibold mb-1 text-center" style="font-family: 'Orbitron', sans-serif;">Music Mode</h2>
                    <div class="control-group">
                        <div class="control-header">
                            <label for="randomIntervalSlider">Interval (Bars):</label>
                            <span id="randomIntervalValue" class="value-display">4</span>
                        </div>
                        <div class="control-slider-container">
                            <button class="slider-button" data-target="randomIntervalSlider" data-action="decrement" title="Decrease randomization interval">&minus;</button>
                            <input type="range" id="randomIntervalSlider" min="1" max="16" value="4" class="control-slider" title="Set how often Music Mode triggers randomization">
                            <button class="slider-button" data-target="randomIntervalSlider" data-action="increment" title="Increase randomization interval">+</button>
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="checkbox-label-container"><input type="checkbox" id="multiTrackRandomToggle" title="Randomize all active tracks at once (checked) or one at a time (unchecked)"> Multi-Track Random</label>
                    </div>
                    <div class="control-group mt-3">
                        <button id="musicModeNextButton" class="push-button w-full" title="Manually trigger the next randomization step">TRIGGER NEXT</button>
                    </div>
                </div>

                <div id="channelVolumesWrapper" class="synth-panel">
                    <h2 class="text-lg font-semibold mb-2 text-center" style="font-family: 'Orbitron', sans-serif;">Channel Volumes</h2>
                    <div id="channelVolumesContainer"></div>
                </div>

                <div id="hintsPanel" class="synth-panel">
                    <div class="control-group">
                        <label class="font-bold text-xs uppercase mb-2" style="font-family: 'Orbitron', sans-serif;">Helpful Hint</label>
                        <div id="hintContent"></div>
                    </div>
                    <div id="logSection" class="control-group mt-3 flex-grow flex-col">
                        <label class="font-bold text-xs uppercase mb-2" style="font-family: 'Orbitron', sans-serif;">Music Mode Log</label>
                        <div id="musicModeLog"></div>
                    </div>
                </div>
            </div>
        </div>

        <footer id="explanationContainer" class="explanation-text-footer">
            <p>Euclidean rhythms are generated by distributing beats as evenly as possible over a set number of time steps.</p>
        </footer>
    </div>
</div>
<div id="statusBar"><div id="statusBar-content"></div></div>

<script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- CONSTANTS AND CONFIGURATION ---
        const MAX_TRACKS = 12;
        const MANUAL_SAVE_KEY = 'rhythmKing77_manualSave_v15';
        const AUTOSAVE_KEY = 'rhythmKing77_autoSave_v15';
        const SCALES = { 'Major': [0, 2, 4, 5, 7, 9, 11], 'Minor': [0, 2, 3, 5, 7, 8, 10], 'Dorian': [0, 2, 3, 5, 7, 9, 10], 'Phrygian': [0, 1, 3, 5, 7, 8, 10], 'Lydian': [0, 2, 4, 6, 7, 9, 11], 'Mixolydian': [0, 2, 4, 5, 7, 9, 10], 'Locrian': [0, 1, 3, 5, 6, 8, 10], 'Major Pentatonic': [0, 2, 4, 7, 9], 'Minor Pentatonic': [0, 3, 5, 7, 10], 'Blues': [0, 3, 5, 6, 7, 10], 'Harmonic Minor': [0, 2, 3, 5, 7, 8, 11], 'Whole Tone': [0, 2, 4, 6, 8, 10], 'Chromatic': [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11] };
        const NOTE_NAMES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const HINTS = [ "Click a red 'L' to map a MIDI CC. Click a green 'L' to un-map it.", "Toggle 'Music Mode' for generative grooves.", "Hit 'Random' on tracks for instant variations.", "Use the 'Save' icon to create a manual save point.", "Hold +/- buttons for rapid value changes.", "The 'Stop Notes' button sends an 'All Notes Off' command to your MIDI gear.", "'Stop Notes' is your friend if notes get stuck!" ];
        const VIEW_PANEL_MAP = {
            showMidiPanel: 'midiPanel',
            showRandomPanel: 'randomizationSettingsContainer',
            showVolumesPanel: 'channelVolumesWrapper',
            showHintsPanel: 'hintsPanel'
        };

        // --- DOM ELEMENT CACHE ---
        const dom = {
            get: (id) => document.getElementById(id),
            query: (selector) => document.querySelector(selector),
            queryAll: (selector) => document.querySelectorAll(selector),
        };

        function setupDOMCache() {
            const ids = [
                'playStopButton', 'masterRandomizeButton', 'saveStateButton', 'loadStateButton',
                'reInitMidiButton', 'allNotesOffButton', 'numTracksInput', 'lockStepsCheckbox',
                'bpmSlider', 'bpmValue', 'bpmSliderLearnCc', 'masterVolumeSlider',
                'masterVolumeValue', 'masterVolumeLearnCc', 'midiOutSelect', 'midiChannelSelect',
                'sequencerTracksContainer', 'channelVolumesContainer', 'channelVolumesWrapper',
                'statusBar', 'statusBar-content', 'musicModeToggle', 'randomIntervalSlider',
                'randomIntervalValue', 'randomizeNoteCheck', 'randomizePulsesCheck',
                'randomizeRotationCheck', 'randomizeScaleCheck', 'randomizeVelocityCheck',
                'multiTrackRandomToggle', 'musicModeNextButton', 'musicModeLog', 'hintContent',
                'app-background', 'octaveSelector', 'viewTogglesContainer',
                'randomizationSettingsContainer', 'musicModePanel', 'logSection',
                'midiPanel', 'hintsPanel'
            ];
            ids.forEach(id => {
                const camelCaseId = id.replace(/-([a-z])/g, g => g[1].toUpperCase());
                dom[camelCaseId] = dom.get(id);
            });
        }

        // --- APPLICATION STATE ---
        let state = {};
        let transportLoops = [];
        let timedRandomEvent = null;
        let statusTimeout, autosaveTimeout, logClearTimeout, hintInterval;
        let activeTrackNotes = {}; // For stuck note prevention

        function getDefaultState() {
            return {
                numTracks: 4,
                bpm: 45,
                masterVolume: 100,
                globalMidiChannel: 1,
                midiOutputId: null,
                ccMap: {},
                stepsLocked: false,
                globalLockedSteps: 16,
                channelVolumes: Array(16).fill(100),
                currentScaleName: 'C Major',
                musicMode: {
                    enabled: fal